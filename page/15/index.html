<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhuang-weiming.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.3.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="Zhuang&#39;s Diary">
<meta property="og:url" content="https://zhuang-weiming.github.io/page/15/index.html">
<meta property="og:site_name" content="Zhuang&#39;s Diary">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Weiming Zhuang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zhuang-weiming.github.io/page/15/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<title>Zhuang's Diary</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zhuang's Diary</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">言之有物，持之以恒</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Weiming Zhuang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">255</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/zhuangweiming/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;zhuangweiming&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/" class="post-title-link" itemprop="url">移植EVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-04-29 18:01:00 / Modified: 18:09:51" itemprop="dateCreated datePublished" datetime="2022-04-29T18:01:00+08:00">2022-04-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>请先阅览前文 ==&gt; <a target="_blank" rel="noopener" href="https://willzhuang.github.io/2019/03/20/evm%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">EVM之源码分析</a> ，整个分析其实就是为了移植虚拟机做基础。</p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>因为涉及到的代码会比较多，不可能把所有代码都列举出来。所以也只是挑关键的部分进行讲解说明。整个移植的代码已经合到之前的那个简单(无用)<a target="_blank" rel="noopener" href="https://github.com/blockchainworkers/conch">demo</a>版本的公链项目上了。 移植的以太坊版本为v1.8.12.</p>
<h3 id="开始移植"><a href="#开始移植" class="headerlink" title="开始移植"></a>开始移植</h3><p>首先先创建一个go的新项目, 将go-ethereum项目下core/vm文件夹下的代码全部拷贝到新项目下，我们为新的文件夹名称为cvm。 保存之后， 假设你用的是vscode(带上了go的周边插件)或者goland，这个时候你会发现有大量的报错。 没有关系， 因为很多以太坊包还没有被导入进来。 但是呢， 既然我们只想移植虚拟机部分，又不引入以太坊的其他模块。 这个时候我们就把需要的包直接拷贝到我们的项目中。 彻底分离和go-ethereum的关系。这里需要说明一下， 虽然是开源项目， 拷贝和使用别人的开源代码也要注意license的。</p>
<ol>
<li>主要需要拷贝的包如下</li>
</ol>
<ul>
<li>go-ethereum/common这个文件夹， 我们也将其这个内容均拷贝到cvm这个文件夹下。</li>
<li>go-ethereum/params这个文件夹中的gas_tables.go, protocol_params.go两个文件拷贝到cvm/params文件夹下。</li>
<li>创建log.go文件在cvm/types/下， 该文件中主要是智能合约emit提交事件时使用的log对象。 内容如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type Log struct &#123;</span><br><span class="line">   &#x2F;&#x2F; Consensus fields:</span><br><span class="line">   &#x2F;&#x2F; address of the contract that generated the event</span><br><span class="line">   Address common.Address &#96;json:&quot;address&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; list of topics provided by the contract.</span><br><span class="line">   Topics []common.Hash &#96;json:&quot;topics&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; supplied by the contract, usually ABI-encoded</span><br><span class="line">   Data []byte &#96;json:&quot;data&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Derived fields. These fields are filled in by the node</span><br><span class="line">   &#x2F;&#x2F; but not secured by consensus.</span><br><span class="line">   &#x2F;&#x2F; block in which the transaction was included</span><br><span class="line">   BlockNumber uint64 &#96;json:&quot;blockNumber&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; hash of the transaction</span><br><span class="line">   TxHash common.Hash &#96;json:&quot;transactionHash&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; index of the transaction in the block</span><br><span class="line">   TxIndex uint &#96;json:&quot;transactionIndex&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; hash of the block in which the transaction was included</span><br><span class="line">   BlockHash common.Hash &#96;json:&quot;blockHash&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; index of the log in the receipt</span><br><span class="line">   Index uint &#96;json:&quot;logIndex&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; The Removed field is true if this log was reverted due to a chain reorganisation.</span><br><span class="line">   &#x2F;&#x2F; You must pay attention to this field if you receive logs through a filter query.</span><br><span class="line">   Removed bool &#96;json:&quot;removed&quot;&#96;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在cvm目录下创建vm.go文件， 主要是生成evm的上下文对象。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewEVMContext creates a new context for use in the EVM.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEVMContext</span><span class="params">(from common.Address, blockNum, timeStamp, difficulty <span class="keyword">int64</span>)</span> <span class="title">vm</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="comment">// If we don&#x27;t have an explicit author (i.e. not mining), extract from the header</span></span><br><span class="line">	<span class="keyword">return</span> vm.Context&#123;</span><br><span class="line">		CanTransfer: CanTransfer,</span><br><span class="line">		Transfer:    Transfer,</span><br><span class="line">		GetHash:     GetHashFn(),</span><br><span class="line">		Origin:      from,</span><br><span class="line">		Coinbase:    common.Address&#123;&#125;,</span><br><span class="line">		BlockNumber: <span class="built_in">new</span>(big.Int).Set(big.NewInt(blockNum)),</span><br><span class="line">		Time:        <span class="built_in">new</span>(big.Int).Set(big.NewInt(timeStamp)),</span><br><span class="line">		Difficulty:  <span class="built_in">new</span>(big.Int).Set(big.NewInt(difficulty)),</span><br><span class="line">		GasLimit:    <span class="number">0xfffffffffffffff</span>, <span class="comment">//header.GasLimit,</span></span><br><span class="line">		GasPrice:    <span class="built_in">new</span>(big.Int).Set(big.NewInt(<span class="number">10</span>)),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetHashFn returns a GetHashFunc which retrieves header hashes by number 获取块号码对于的块hash</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHashFn</span><span class="params">()</span> <span class="title">func</span><span class="params">(n <span class="keyword">uint64</span>)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">uint64</span>)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line">		<span class="comment">// If there&#x27;s no hash cache yet, make one</span></span><br><span class="line">		<span class="comment">// if cache == nil &#123;</span></span><br><span class="line">		<span class="comment">// 	cache = map[uint64]common.Hash&#123;</span></span><br><span class="line">		<span class="comment">// 		ref.Number.Uint64() - 1: ref.ParentHash,</span></span><br><span class="line">		<span class="comment">// 	&#125;</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="comment">// // Try to fulfill the request from the cache</span></span><br><span class="line">		<span class="comment">// if hash, ok := cache[n]; ok &#123;</span></span><br><span class="line">		<span class="comment">// 	return hash</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="comment">// // Not cached, iterate the blocks and cache the hashes</span></span><br><span class="line">		<span class="comment">// for header := chain.GetHeader(ref.ParentHash, ref.Number.Uint64()-1); header != nil; header = chain.GetHeader(header.ParentHash, header.Number.Uint64()-1) &#123;</span></span><br><span class="line">		<span class="comment">// 	cache[header.Number.Uint64()-1] = header.ParentHash</span></span><br><span class="line">		<span class="comment">// 	if n == header.Number.Uint64()-1 &#123;</span></span><br><span class="line">		<span class="comment">// 		return header.ParentHash</span></span><br><span class="line">		<span class="comment">// 	&#125;</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CanTransfer checks wether there are enough funds in the address&#x27; account to make a transfer.</span></span><br><span class="line"><span class="comment">// This does not take the necessary gas in to account to make the transfer valid.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CanTransfer</span><span class="params">(db vm.StateDB, addr common.Address, amount *big.Int)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> db.GetBalance(addr).Cmp(amount) &gt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transfer subtracts amount from sender and adds amount to recipient using the given Db</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Transfer</span><span class="params">(db vm.StateDB, sender, recipient common.Address, amount *big.Int)</span></span> &#123;</span><br><span class="line">	db.SubBalance(sender, amount)</span><br><span class="line">	db.AddBalance(recipient, amount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接着我们把go-ethereum/account文件夹下的abi内容拷贝到cvm文件夹下。</li>
</ol>
<blockquote>
<p>abi/bind文件内容可以直接删除掉。此文件夹下是对智能合约进行函数调用进行编码的包。换句话调用智能合约构建的交易中的input内容就是需要此包中函数来生成的。当然如果你看了前面的文章，对智能合约调用了解的话，此处自然就理解这个包的作用了。</p>
</blockquote>
<p>到了这里整个需要拷贝的文件就齐全了， 目录结构如下:</p>
<p><img src="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/1.jpg"></p>
<ol start="4">
<li>接下来我们需要修改evm的部分代码了。</li>
</ol>
<blockquote>
<p>vm/contracts.go文件我们直接删除掉。 这个是自带的智能合约， 内部主要是一些内置函数， 注意实际使用的时候记得还是要实现的， evm.go文件中run函数忽略掉所有内置的合约函数。</p>
</blockquote>
<p><img src="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/2.jpg"></p>
<p>修改evm.go文件中的Call函数 当地址不存在时我们直接认为是创建地址， 忽略掉掉内置合约。 <img src="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/3.jpg"></p>
<ol start="5">
<li>接着我们要实现evm.StateDB接口的内容了， 因为此接口涉及涉及的主要是个账户状态相关的内容， 也即是说可整个区块的存储是有关联的， 暂时我也只能以一个示例来说明是如何简单的实现这些接口。</li>
</ol>
<p>我们在cvm文件夹下创建一个account_state.go的文件。 定义的数据结构格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> accountObject <span class="keyword">struct</span> &#123;</span><br><span class="line">	Address      common.Address              <span class="string">`json:&quot;address,omitempty&quot;`</span></span><br><span class="line">	AddrHash     common.Hash                 <span class="string">`json:&quot;addr_hash,omitempty&quot;`</span> <span class="comment">// hash of ethereum address of the account</span></span><br><span class="line">	ByteCode     []<span class="keyword">byte</span>                      <span class="string">`json:&quot;byte_code,omitempty&quot;`</span></span><br><span class="line">	Data         accountData                 <span class="string">`json:&quot;data,omitempty&quot;`</span></span><br><span class="line">	CacheStorage <span class="keyword">map</span>[common.Hash]common.Hash <span class="string">`json:&quot;cache_storage,omitempty&quot;`</span> <span class="comment">// 用于缓存存储的变量</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> accountData <span class="keyword">struct</span> &#123;</span><br><span class="line">	Nonce    <span class="keyword">uint64</span>      <span class="string">`json:&quot;nonce,omitempty&quot;`</span></span><br><span class="line">	Balance  *big.Int    <span class="string">`json:&quot;balance,omitempty&quot;`</span></span><br><span class="line">	Root     common.Hash <span class="string">`json:&quot;root,omitempty&quot;`</span> <span class="comment">// merkle root of the storage trie</span></span><br><span class="line">	CodeHash []<span class="keyword">byte</span>      <span class="string">`json:&quot;code_hash,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AccountState 实现vm的StateDB的接口 用于进行测试</span></span><br><span class="line"><span class="keyword">type</span> AccountState <span class="keyword">struct</span> &#123;</span><br><span class="line">	Accounts <span class="keyword">map</span>[common.Address]*accountObject <span class="string">`json:&quot;accounts,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>接下来我们实现StateDB接口:</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateAccount 创建账户接口 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">CreateAccount</span><span class="params">(addr common.Address)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> accSt.getAccountObject(addr) != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	obj := newAccountObject(addr, accountData&#123;&#125;)</span><br><span class="line">	accSt.setAccountObject(obj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SubBalance 减去某个账户的余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SubBalance</span><span class="params">(addr common.Address, amount *big.Int)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.SubBalance(amount)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddBalance 增加某个账户的余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddBalance</span><span class="params">(addr common.Address, amount *big.Int)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.AddBalance(amount)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//// GetBalance 获取某个账户的余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetBalance</span><span class="params">(addr common.Address)</span> *<span class="title">big</span>.<span class="title">Int</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.Balance()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//GetNonce 获取nonce</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetNonce</span><span class="params">(addr common.Address)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.Nonce()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetNonce 设置nonce</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SetNonce</span><span class="params">(addr common.Address, nonce <span class="keyword">uint64</span>)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.SetNonce(nonce)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCodeHash 获取代码的hash值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetCodeHash</span><span class="params">(addr common.Address)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> common.BytesToHash(stateObject.CodeHash())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//GetCode 获取智能合约的代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetCode</span><span class="params">(addr common.Address)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.Code()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SetCode 设置智能合约的code</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SetCode</span><span class="params">(addr common.Address, code []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.SetCode(crypto.Sha256(code), code)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCodeSize 获取code的大小</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetCodeSize</span><span class="params">(addr common.Address)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> stateObject.ByteCode != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(stateObject.ByteCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddRefund 暂时先忽略补偿</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddRefund</span><span class="params">(<span class="keyword">uint64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//GetRefund ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetRefund</span><span class="params">()</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetState 和SetState 是用于保存合约执行时 存储的变量是否发生变化 evm对变量存储的改变消耗的gas是有区别的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetState</span><span class="params">(addr common.Address, key common.Hash)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.GetStorageState(key)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> common.Hash&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetState 设置变量的状态</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SetState</span><span class="params">(addr common.Address, key common.Hash, value common.Hash)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;SetState key: %x value: %s&quot;</span>, key, <span class="built_in">new</span>(big.Int).SetBytes(value[:]).String())</span><br><span class="line">		stateObject.SetStorageState(key, value)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Suicide 暂时禁止自杀</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Suicide</span><span class="params">(common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HasSuicided ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">HasSuicided</span><span class="params">(common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exist 检查账户是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Exist</span><span class="params">(addr common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> accSt.getAccountObject(addr) != <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Empty 是否是空账户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Empty</span><span class="params">(addr common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	so := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">return</span> so == <span class="literal">nil</span> || so.Empty()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RevertToSnapshot ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">RevertToSnapshot</span><span class="params">(<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Snapshot ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Snapshot</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddLog 添加事件触发日志</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddLog</span><span class="params">(log *types.Log)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;log: %v&quot;</span>, log)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddPreimage </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddPreimage</span><span class="params">(common.Hash, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForEachStorage  暂时没发现vm调用这个接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">ForEachStorage</span><span class="params">(common.Address, <span class="keyword">func</span>(common.Hash, common.Hash)</span> <span class="title">bool</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit 进行持久存储 这里我们只将其简单的json话之后保存到本地磁盘中。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Commit</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 将bincode写入文件</span></span><br><span class="line">	file, err := os.Create(<span class="string">&quot;./account_sate.db&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	err = json.NewEncoder(file).Encode(accSt)</span><br><span class="line">	<span class="comment">//fmt.Println(&quot;len(binCode): &quot;, len(binCode), &quot; code: &quot;, binCode)</span></span><br><span class="line">	<span class="comment">// bufW := bufio.NewWriter(file)</span></span><br><span class="line">	<span class="comment">// bufW.Write(binCode)</span></span><br><span class="line">	<span class="comment">// // bufW.WriteByte(&#x27;\n&#x27;)</span></span><br><span class="line">	<span class="comment">// bufW.Flush()</span></span><br><span class="line">	file.Close()</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//TryLoadFromDisk  尝试从磁盘加载AccountState</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TryLoadFromDisk</span><span class="params">()</span> <span class="params">(*AccountState, error)</span></span> &#123;</span><br><span class="line">	file, err := os.Open(<span class="string">&quot;./account_sate.db&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> NewAccountStateDb(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// stat, _ := file.Stat()</span></span><br><span class="line">	<span class="comment">// // buf := stat.Size()</span></span><br><span class="line">	<span class="keyword">var</span> accStat AccountState</span><br><span class="line"></span><br><span class="line">	err = json.NewDecoder(file).Decode(&amp;accStat)</span><br><span class="line">	<span class="keyword">return</span> &amp;accStat, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>接下来尝试部署两份智能合约进行测试:</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.21</span>;</span><br><span class="line">interface BaseInterface &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CurrentVersion</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">string</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Helloworld &#123;</span><br><span class="line">    uint256 balance;</span><br><span class="line">    event Triggle(address, string);</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span>=&gt;</span>uint256) _mapamount; </span><br><span class="line">    </span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> &#123;</span><br><span class="line">        balance = <span class="number">6000000000</span>;</span><br><span class="line">        _mapamount[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line">        _mapamount[<span class="number">1</span>] = <span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getbalance</span>(<span class="params"></span>) <span class="title">public</span>  <span class="title">returns</span> (<span class="params">address, uint256</span>) </span>&#123;</span><br><span class="line">        emit Triggle(msg.sender, <span class="string">&quot;funck&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (msg.sender, balance--);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onlytest</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        _mapamount[<span class="number">1</span>] = <span class="number">100</span>;</span><br><span class="line">        emit Triggle(msg.sender, <span class="string">&quot;onlytest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setBalance</span>(<span class="params">uint256 tmp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        balance = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getVersion</span>(<span class="params">address contractAddr</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        BaseInterface baseClass = BaseInterface(contractAddr);</span><br><span class="line">       <span class="keyword">return</span> baseClass.CurrentVersion();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.21</span>;</span><br><span class="line"></span><br><span class="line">contract BaseContract &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"> <span class="comment">// </span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">CurrentVersion</span>(<span class="params"></span>) <span class="title">pure</span> <span class="title">public</span> <span class="title">returns</span>(<span class="params">string</span>)  </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;BaseContractV0.1&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这两个合约我们就可以测试到一些view 类型的函数调用， 一些对数据状态有修改的合约调用， 和跨合约的调用。 我们可以将上面的两个合约通过ethereum官方出品的remix进行编译，得到字节码。因为BaseContract没有涉及初始化的内容 所以我们可以直接使用runtime的bytecode。 不过我们直接使用Create函数去部署合约。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runtimeBytecode, contractAddr, leftgas, <span class="attr">err</span> := vmenv.Create(vm.AccountRef(normalAccount), helloCode, <span class="number">10000000000</span>, big.NewInt(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<p>第一个返回值其实就是需要部署的runtime字节码 ， 我们调用<code>stateDb.SetCode(helloWorldcontactAccont, runtimeBytecode)</code>将其部署。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> normalAddress, _ = hex.DecodeString(<span class="string">&quot;123456abc&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> hellWorldcontractAddress, _ = hex.DecodeString(<span class="string">&quot;987654321&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> baseContractAddress, _ = hex.DecodeString(<span class="string">&quot;038f160ad632409bfb18582241d9fd88c1a072ba&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> normalAccount = common.BytesToAddress(normalAddress)</span><br><span class="line"><span class="keyword">var</span> helloWorldcontactAccont = common.BytesToAddress(hellWorldcontractAddress)</span><br><span class="line"><span class="keyword">var</span> baseContractAccont = common.BytesToAddress(baseContractAddress)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本账户字节码</span></span><br><span class="line"><span class="keyword">var</span> baseCodeStr = <span class="string">&quot;608060405260043610610062576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632b225f29146100675780638afc3605146100f75780638da5cb5b1461010e578063f2fde38b14610165575b600080fd5b34801561007357600080fd5b5061007c6101a8565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100bc5780820151818401526020810190506100a1565b50505050905090810190601f1680156100e95780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561010357600080fd5b5061010c6101e5565b005b34801561011a57600080fd5b50610123610227565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561017157600080fd5b506101a6600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061024c565b005b60606040805190810160405280601081526020017f42617365436f6e747261637456302e3100000000000000000000000000000000815250905090565b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156102a757600080fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141515156102e357600080fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3505600a165627a7a723058208c3064096245894122f6bcf5e2ee12e30d4775a3b8dca0b21f10d5a5bc386e8b0029&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// hellworld 账户字节码</span></span><br><span class="line"><span class="keyword">var</span> hellCodeStr = <span class="string">&quot;6080604052600436106100615763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416634d9b3d5d81146100665780637e8800a7146100ab578063c3f82bc3146100c2578063fb1669ca14610165575b600080fd5b34801561007257600080fd5b5061007b61017d565b6040805173ffffffffffffffffffffffffffffffffffffffff909316835260208301919091528051918290030190f35b3480156100b757600080fd5b506100c06101fa565b005b3480156100ce57600080fd5b506100f073ffffffffffffffffffffffffffffffffffffffff6004351661028f565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561012a578181015183820152602001610112565b50505050905090810190601f1680156101575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561017157600080fd5b506100c0600435610389565b60408051338152602081018290526005818301527f66756e636b0000000000000000000000000000000000000000000000000000006060820152905160009182917f08c31d20d5c3a5f2cfe0adf83909e6411f43fe97eb091e15c12f3e5a203e8fde9181900360800190a150506000805460001981019091553391565b600080526001602090815260647fa6eef7e35abe7026729641147f7915573c7e97b47efa546f5f6e3230263bcb4955604080513381529182018190526008828201527f6f6e6c79746573740000000000000000000000000000000000000000000000006060830152517f08c31d20d5c3a5f2cfe0adf83909e6411f43fe97eb091e15c12f3e5a203e8fde9181900360800190a1565b606060008290508073ffffffffffffffffffffffffffffffffffffffff16632b225f296040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401600060405180830381600087803b1580156102fa57600080fd5b505af115801561030e573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052602081101561033757600080fd5b81019080805164010000000081111561034f57600080fd5b8201602081018481111561036257600080fd5b815164010000000081118282018710171561037c57600080fd5b5090979650505050505050565b6000555600a165627a7a72305820c63a859d93a3512b52ccaec75bb9aa146648c41b21c8a0cd0cd2e2c1aede35ed0029&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helloCode, _ = hex.DecodeString(hellCodeStr)</span><br><span class="line"><span class="keyword">var</span> baseCode, _ = hex.DecodeString(baseCodeStr)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">updateContract</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="comment">// 加载账户State</span></span><br><span class="line">	stateDb, <span class="attr">err</span> := cvm.TryLoadFromDisk()</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	stateDb.SetCode(helloWorldcontactAccont, helloCode)</span><br><span class="line">	stateDb.SetCode(baseContractAccont, baseCode)</span><br><span class="line">	fmt.Println(stateDb.Commit())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们调用一个智能合约比如getbalance函数， 代码类似下面这样:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4d9b3d5d : getbalance  7e8800a7: onlytest fb1669ca000000000000000000000000000000000000000000000000000000000000029a: setbalance 666</span></span><br><span class="line"><span class="keyword">var</span> input, _ = hex.DecodeString(<span class="string">&quot;7e8800a7&quot;</span>)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="comment">// updateContract()</span></span><br><span class="line">	<span class="comment">// return</span></span><br><span class="line">	<span class="comment">// 创建账户State</span></span><br><span class="line">	stateDb, <span class="attr">err</span> := cvm.TryLoadFromDisk()</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	evmCtx := cvm.NewEVMContext(normalAccount, <span class="number">100</span>, <span class="number">1200000</span>, <span class="number">1</span>)</span><br><span class="line">	vmenv := vm.NewEVM(evmCtx, stateDb, vm.Config&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	ret, leftgas, <span class="attr">err</span> := vmenv.Call(vm.AccountRef(normalAccount), helloWorldcontactAccont, input, <span class="number">1000000</span>, big.NewInt(<span class="number">0</span>))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ret: %v, usedGas: %v, err: %v, len(ret): %v, hexret: %v, &quot;</span>, ret, <span class="number">1000000</span>-leftgas, err, len(ret), hex.EncodeToString(ret))</span><br><span class="line"></span><br><span class="line">	abiObjet, <span class="attr">_</span> := abi.JSON(strings.NewReader(hellWorldContractABIJson))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// begin, length, _ := lengthPrefixPointsTo(0, ret)</span></span><br><span class="line">	addr := <span class="keyword">new</span>(common.Address)</span><br><span class="line"></span><br><span class="line">	value := big.NewInt(<span class="number">0</span>) <span class="comment">//new(*big.Int)</span></span><br><span class="line">	restult := []interface&#123;&#125;&#123;addr, &amp;value&#125;</span><br><span class="line">	fmt.Println(abiObjet.Unpack(&amp;restult, <span class="string">&quot;getbalance&quot;</span>, ret))</span><br><span class="line">	<span class="comment">//fmt.Println(unpackAtomic(&amp;restult, string(ret[begin:begin+length])))</span></span><br><span class="line">	println(restult[<span class="number">0</span>].(*common.Address).String(), (*restult[<span class="number">1</span>].(**big.Int)).String())</span><br><span class="line">	fmt.Println(stateDb.Commit())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>到了这里， evm移植流程就算完成了。 如果理解evm执行的原理， 大部分的工作其实就是拷贝， 出错的任务。 当然这个移植后的代码肯定是不能在生产中使用的， 但是需要修改和添加的代码主要也就是上文提到的内容。 最后还是想说明白原理和流程就是成功了一大半， 后面的部分主要就是调试和排错的过程了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/27/4.Open%20source%20ecommerce%20platform%20for%20multi-vendor%20marketplaces/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/27/4.Open%20source%20ecommerce%20platform%20for%20multi-vendor%20marketplaces/" class="post-title-link" itemprop="url">4.Open source ecommerce platform for multi-vendor marketplaces</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-27 17:18:00" itemprop="dateCreated datePublished" datetime="2022-04-27T17:18:00+08:00">2022-04-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-08-01 10:05:14" itemprop="dateModified" datetime="2023-08-01T10:05:14+08:00">2023-08-01</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I tried here <a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender#marketplace-tutorial">https://github.com/adrien2p/medusa-extender#marketplace-tutorial</a> for new medusa-server, the same as <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace">https://github.com/shahednasser/medusa-marketplace</a>, but fail to “npm start”.</p>
<p>But we can run it buy code update directly step by step — <a target="_blank" rel="noopener" href="https://dev.to/medusajs/create-an-open-source-commerce-marketplace-part-1-3m5k">https://dev.to/medusajs/create-an-open-source-commerce-marketplace-part-1-3m5k</a>, this is a guide to migrate exciting medusa-server to upgrade about “store_id”.</p>
<p>==================&gt; guide detail &lt;==================</p>
<p><a target="_blank" rel="noopener" href="https://www.medusajs.com/">Medusa</a> is an open source headless commerce platform that allows you to create your own store in a matter of minutes. Part of what makes Medusa a good choice for your ecommerce store is its extensibility. <strong>Now, it is also possible to create multi-vendor marketplaces using Medusa</strong>.</p>
<p>To make things easier for our open source community, <a target="_blank" rel="noopener" href="https://github.com/adrien2p">Adrien de Peretti</a>, one of our amazing contributors, created a Medusa module that allows you to extend anything and everything you want.</p>
<blockquote>
<p>“I’ve been looking for an e-commerce solution that could provide me with some core features while being fully customisable… After some research, where I found that none of the present solutions could provide what I needed, I chose Medusa as it provided me with many of the needed features while being easy to extend. I ended up loving the community atmosphere, especially the proximity with the team, and have been helping those in the community looking for a similar fully-customisable solution by sharing a part of my private project. This is how the medusa-extender was born.” — Adrien de Peretti</p>
</blockquote>
<p>In this tutorial, you’ll learn how to install and set up the Medusa Extender module on your Medusa server. You’ll then learn how to use its customization abilities to create a marketplace in your store! The marketplace will have multiple stores or vendors, and each of these stores will be able to add its own products. This tutorial will be the first part of a series that will explore all aspects of creating a marketplace.</p>
<h2 id="What-is-Medusa-Extender"><a href="#What-is-Medusa-Extender" class="headerlink" title="What is Medusa Extender"></a>What is Medusa Extender</h2><p><a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender">Medusa Extender</a> is an NPM package that you can add to your Medusa store to extend or customize its functionalities. The scope of its customization entails Entities, Repositories, Services, and more.</p>
<p>The Medusa Extender has many use cases aside the marketplace functionality. It can be used in many other use cases, such as adding custom fields, listening to events to perform certain actions like sending emails, customizing Medusa’s validation of request parameters, and more.</p>
<h2 id="What-You’ll-Be-Creating"><a href="#What-You’ll-Be-Creating" class="headerlink" title="What You’ll Be Creating"></a>What You’ll Be Creating</h2><p>In this article and the following parts of this series, you’ll learn how to create a marketplace using Medusa and Medusa Extender. A marketplace is an online store that allows multiple vendors to add their products and sell them.</p>
<p>A marketplace has a lot of features, including managing a vendor’s own orders and settings. This part of the tutorial will only showcase how to create stores for each user and attach the products they create to that store.</p>
<h2 id="Code-for-This-Tutorial"><a href="#Code-for-This-Tutorial" class="headerlink" title="Code for This Tutorial"></a>Code for This Tutorial</h2><p>If you want to follow along you can find the code for this tutorial in <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace-tutorial">this repository</a>.</p>
<p>Alternatively, if you want to install the marketplace into your existing Medusa store, you can install the <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace">Medusa Marketplace plugin</a>. This plugin is created with the code from this tutorial and will be updated with every new part of this series released.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>Before you follow along with this tutorial, make sure you have:</p>
<ol>
<li>A Medusa server instance was installed. You can follow along with our easy <a target="_blank" rel="noopener" href="https://docs.medusajs.com/quickstart/quick-start">quickstart guide</a> to learn how you can do that.</li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/download/">PostgreSQL</a> installed and your Medusa server connected to it.</li>
<li><a target="_blank" rel="noopener" href="https://redis.io/download">Redis</a> installed and your Medusa server connected to it.</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart redis-server</span><br><span class="line">清楚redis 缓存数据</span><br><span class="line">➜  ~ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; select</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;select&#x27; command</span><br><span class="line">127.0.0.1:6379&gt; select 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; FLUSHDB</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">➜  ~ sudo /etc/init.d/postgresql star</span><br><span class="line">[sudo] password for zhuang: </span><br><span class="line">➜  ~ </span><br><span class="line">➜  ~ sudo -i -u postgres</span><br><span class="line">postgres@elementoryos61:~$ psql</span><br><span class="line">psql (12.9 (Ubuntu 12.9-0ubuntu0.20.04.1))</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line">postgres=# CREATE DATABASE openharbor_marketplace_medusa;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=# </span><br></pre></td></tr></table></figure>



<h2 id="Building-the-Marketplace"><a href="#Building-the-Marketplace" class="headerlink" title="Building the Marketplace"></a>Building the Marketplace</h2><h3 id="Project-Setup"><a href="#Project-Setup" class="headerlink" title="Project Setup"></a>Project Setup</h3><p>In the directory that holds your Medusa server, start by installing Medusa Extender using NPM:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i medusa-extender</span><br></pre></td></tr></table></figure>



<p>It’s recommended that you use TypeScript in your project to get the full benefits of Medusa-Extender. To do that, create the file <code>tsconfig.json</code> in the root of the Medusa project with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;module&quot;</span>: <span class="string">&quot;CommonJS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;declaration&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;emitDecoratorMetadata&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowSyntheticDefaultImports&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;es2017&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowJs&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;outDir&quot;</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rootDir&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;include&quot;</span>: [<span class="string">&quot;src&quot;</span>, <span class="string">&quot;medusa-config.js&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exclude&quot;</span>: [<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;node_modules&quot;</span>, <span class="string">&quot;**/*.spec.ts&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Next, update the <code>scripts</code> key in <code>package.json</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;seed&quot;</span>: <span class="string">&quot;medusa seed -f ./data/seed.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;rm -rf dist &amp;&amp; tsc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;npm run build &amp;&amp; node dist/src/main.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>



<p>These scripts will ensure that your TypeScript files will be transpiled before Medusa is run.</p>
<p>Then, create the file <code>main.ts</code> in the directory <code>src</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Medusa &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> expressInstance = express();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([]);</span><br><span class="line"></span><br><span class="line">    expressInstance.listen(<span class="number">9000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&#x27;Server successfully started on port 9000&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>



<p>This file will make sure to load all the customizations you’ll add next when you run your Medusa server.</p>
<p>Now, Medusa Extender is fully integrated into your Medusa instance and you can start building the Marketplace.</p>
<h3 id="Customize-the-Store-Entity"><a href="#Customize-the-Store-Entity" class="headerlink" title="Customize the Store Entity"></a>Customize the Store Entity</h3><p>You’ll start by customizing the Store entity. You’ll need to use it later on to add relations between the store entity and the users and products entities.</p>
<p>By convention, customizations using Medusa Extender are organized in a module-like structure. However, this is completely optional.</p>
<p>In the <code>src</code> directory, create the directory <code>modules</code> in which you’ll store all the customizations in.</p>
<p>Then, create the directory <code>store</code> inside the <code>modules</code> directory. The <code>store</code> directory will hold all customizations related to the Store.</p>
<p><strong>Create a Store Entity</strong></p>
<p>Create the file <code>src/modules/store/entities/store.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Store <span class="keyword">as</span> MedusaStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity, JoinColumn, OneToMany &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaStore &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Store</span> <span class="keyword">extends</span> <span class="title">MedusaStore</span> </span>&#123;</span><br><span class="line">    <span class="comment">//TODO add relations</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the decorator <code>@Entity</code> from <code>medusa-extender</code> to customize Medusa’s <code>Store</code> entity. You create a <code>Store</code> class that extends Medusa’s Store entity (imported as <code>MedusaStore</code> ).</p>
<p>You’ll, later on, edit this entity to add the relations between the store and users and products.</p>
<p><strong>Create a Store Repository</strong></p>
<p>Next, you need to override Medusa’s <code>StoreRepository</code>. This repository will return Medusa’s <code>Store</code> entity. So, you need to override it to make sure it returns your <code>Store</code> entity that you just created.</p>
<p>Create the file <code>src/modules/store/repositories/store.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StoreRepository <span class="keyword">as</span> MedusaStoreRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/repositories/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaStoreRepository &#125;)</span><br><span class="line">@EntityRepository(Store)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">Store</span>, <span class="title">MedusaStoreRepository</span>&gt;(<span class="title">MedusaStoreRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Create the Store Module</strong></p>
<p>For now, these are the only files you’ll add for the store. You can create the Store module using these files.</p>
<p>Create the file <code>src/modules/store/store.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/store.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> StoreRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/store.repository&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [Store, StoreRepository],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the <code>@Module</code> decorator from <code>medusa-extender</code> and imports the 2 classes you created.</p>
<p>The last thing left is to import this module and use it with Medusa. In <code>src/main.ts</code> import <code>StoreModule</code> at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/store/store.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>StoreModule</code> in the array passed as a parameter to <code>Medusa.load</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">    StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p>This is all that you’ll do for now in the Store module. In the next sections, you’ll be adding more classes to it as necessary.</p>
<h3 id="Customize-the-User-Entity"><a href="#Customize-the-User-Entity" class="headerlink" title="Customize the User Entity"></a>Customize the User Entity</h3><p>In this section, you’ll customize the user entity mainly to link the user to a store.</p>
<p><strong>Create the User Entity</strong></p>
<p>Create the directory <code>user</code> inside the <code>modules</code> directory and create the file <code>src/modules/user/entities/user.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; User <span class="keyword">as</span> MedusaUser &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, Index, JoinColumn, ManyToOne &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store/entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaUser &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">MedusaUser</span> </span>&#123;</span><br><span class="line">    @Index()</span><br><span class="line">    @Column(&#123; <span class="attr">nullable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    store_id: string;</span><br><span class="line"></span><br><span class="line">    @ManyToOne(<span class="function">() =&gt;</span> Store, <span class="function">(<span class="params">store</span>) =&gt;</span> store.members)</span><br><span class="line">    @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">    store: Store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This class will add an additional column <code>store_id</code> of type string and will add a relation to the <code>Store</code> entity.</p>
<p>To add the new column to the <code>user</code> table in the database, you need to create a Migration file. Create the file <code>src/modules/user/migrations/user.migration.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Migration &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MigrationInterface, QueryRunner &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Migration()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">addStoreIdToUser1644946220401</span> <span class="title">implements</span> <span class="title">MigrationInterface</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;addStoreIdToUser1644946220401&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> up(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;user&quot; ADD COLUMN IF NOT EXISTS &quot;store_id&quot; text;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> down(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;user&quot; DROP COLUMN &quot;store_id&quot;;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>The migration is created using the <code>@Migration</code> decorator from <code>medusa-extender</code>. Notice that the migration name should end with a JavaScript timestamp based on <code>typeorm</code>‘s conventions.</p>
<p>The <code>up</code> method is run if the migration hasn’t been run before. It will add the column <code>store_id</code> to the table <code>user</code> if it doesn’t exist.</p>
<p>You’ll also need to add the relation between the Store and the User entities in <code>src/modules/store/entities/store.entity.ts</code> . Replace the <code>//TODO</code> with the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(<span class="function">() =&gt;</span> User, <span class="function">(<span class="params">user</span>) =&gt;</span> user.store)</span><br><span class="line">@JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">members: User[];</span><br></pre></td></tr></table></figure>



<p>Make sure to import the <code>User</code> entity at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p><strong>Create the User Repository</strong></p>
<p>Next, you need to override Medusa’s <code>UserRepository</code>. Create the file <code>src/modules/user/repositories/user.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserRepository <span class="keyword">as</span> MedusaUserRepository &#125; <span class="keyword">from</span> <span class="string">&quot;@medusajs/medusa/dist/repositories/user&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&quot;medusa-extender&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&quot;../entities/user.entity&quot;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaUserRepository &#125;)</span><br><span class="line">@EntityRepository(User)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">User</span>, <span class="title">MedusaUserRepository</span>&gt;(<span class="title">MedusaUserRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Create the User Service</strong></p>
<p>Next, you need to override Medusa’s <code>UserService</code> class. Create the file <code>src/modules/user/services/user.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Service &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> EventBusService <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services/event-bus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FindConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/types/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService <span class="keyword">as</span> MedusaUserService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserRepository <span class="keyword">from</span> <span class="string">&#x27;../repositories/user.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MedusaError &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-core-utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type ConstructorParams = &#123;</span><br><span class="line">    manager: EntityManager;</span><br><span class="line">    userRepository: <span class="keyword">typeof</span> UserRepository;</span><br><span class="line">    eventBusService: EventBusService;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">override</span>: MedusaUserService &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">MedusaUserService</span> </span>&#123;</span><br><span class="line">    private readonly manager: EntityManager;</span><br><span class="line">    private readonly userRepository: <span class="keyword">typeof</span> UserRepository;</span><br><span class="line">    private readonly eventBus: EventBusService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.manager = container.manager;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = container.userRepository;</span><br><span class="line">        <span class="built_in">this</span>.eventBus = container.eventBusService;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> retrieve(userId: string, config?: FindConfig&lt;User&gt;): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> userRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.userRepository);</span><br><span class="line">        <span class="keyword">const</span> validatedId = <span class="built_in">this</span>.validateId_(userId);</span><br><span class="line">        <span class="keyword">const</span> query = <span class="built_in">this</span>.buildQuery_(&#123; <span class="attr">id</span>: validatedId &#125;, config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> userRepo.findOne(query);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MedusaError(MedusaError.Types.NOT_FOUND, <span class="string">`User with id: <span class="subst">$&#123;userId&#125;</span> was not found`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user <span class="keyword">as</span> User;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the <code>@Service</code> decorator from <code>medusa-extender</code> to override Medusa’s <code>UserService</code>. The class you create to override it will extend <code>UserService</code>.</p>
<p>This new class overrides the <code>retrieve</code> method to ensure that the user returned is the new User entity class you created earlier.</p>
<p><strong>Create a User Middleware</strong></p>
<p>The <code>loggedInUser</code> is not available natively in Medusa. You’ll need to create a Middleware that, when a request is authenticated, registers the logged-in User within the scope.</p>
<p>Create the file <code>src/modules/user/middlewares/loggedInUser.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MedusaAuthenticatedRequest, MedusaMiddleware, Middleware &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;../../user/services/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">true</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;all&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggedInUserMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">async</span> consume(req: MedusaAuthenticatedRequest, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.user &amp;&amp; req.user.userId) &#123;</span><br><span class="line">            <span class="keyword">const</span> userService = req.scope.resolve(<span class="string">&#x27;userService&#x27;</span>) <span class="keyword">as</span> UserService;</span><br><span class="line">            <span class="keyword">const</span> loggedInUser = <span class="keyword">await</span> userService.retrieve(req.user.userId, &#123;</span><br><span class="line">                select: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;store_id&#x27;</span>],</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            req.scope.register(&#123;</span><br><span class="line">                loggedInUser: &#123;</span><br><span class="line">                    resolve: <span class="function">() =&gt;</span> loggedInUser,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>You can use the <code>@Middleware</code> decorator from <code>medusa-extender</code> to create a Middleware that runs on specific requests. This Middleware is run when the request is received from an authenticated user, and it runs for all paths (notice the use of <code>path: &#39;*&#39;</code> ) and for all types of requests (notice the use of <code>method: &quot;all&quot;</code>).</p>
<p>Inside the middleware, you retrieve the current user ID from the request, then retrieve the user model and register it in the scope so that it can be accessed from services.</p>
<blockquote>
<p>This approach is simplified for the purpose of this tutorial. However, it makes more sense to include this middleware in a separate <code>auth</code> module. Whether you include this middleware in the <code>user</code> module or the <code>auth</code> middleware will not affect its functionality.</p>
</blockquote>
<p><strong>Create a Store Service to Handle User Insert Events</strong></p>
<p>You need to ensure that when a user is created, a store is associated with it. You can do that by listening to the User-created event and creating a new store for that user. You’ll add this event handler in a <code>StoreService</code>.</p>
<p>Create the file <code>src/modules/store/services/store.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreService <span class="keyword">as</span> MedusaStoreService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CurrencyRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/repositories/currency&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/store.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityEventType, Service, MedusaEventHandlerParams, OnMedusaEntityEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> EventBusService <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services/event-bus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> StoreRepository <span class="keyword">from</span> <span class="string">&#x27;../repositories/store.repository&#x27;</span>;</span><br><span class="line"></span><br><span class="line">interface ConstructorParams &#123;</span><br><span class="line">    loggedInUser: User;</span><br><span class="line">    manager: EntityManager;</span><br><span class="line">    storeRepository: <span class="keyword">typeof</span> StoreRepository;</span><br><span class="line">    currencyRepository: <span class="keyword">typeof</span> CurrencyRepository;</span><br><span class="line">    eventBusService: EventBusService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">override</span>: MedusaStoreService, <span class="attr">scope</span>: <span class="string">&#x27;SCOPED&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreService</span> <span class="keyword">extends</span> <span class="title">MedusaStoreService</span> </span>&#123;</span><br><span class="line">    private readonly manager: EntityManager;</span><br><span class="line">    private readonly storeRepository: <span class="keyword">typeof</span> StoreRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.manager = container.manager;</span><br><span class="line">        <span class="built_in">this</span>.storeRepository = container.storeRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    withTransaction(transactionManager: EntityManager): StoreService &#123;</span><br><span class="line">        <span class="keyword">if</span> (!transactionManager) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> cloned = <span class="keyword">new</span> StoreService(&#123;</span><br><span class="line">            ...this.container,</span><br><span class="line">            manager: transactionManager,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        cloned.transactionManager_ = transactionManager;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cloned;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @OnMedusaEntityEvent.Before.Insert(User, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    public <span class="keyword">async</span> createStoreForNewUser(</span><br><span class="line">        params: MedusaEventHandlerParams&lt;User, <span class="string">&#x27;Insert&#x27;</span>&gt;</span><br><span class="line">    ): <span class="built_in">Promise</span>&lt;EntityEventType&lt;User, <span class="string">&#x27;Insert&#x27;</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; event &#125; = params;</span><br><span class="line">        <span class="keyword">const</span> createdStore = <span class="keyword">await</span> <span class="built_in">this</span>.withTransaction(event.manager).createForUser(event.entity);</span><br><span class="line">        <span class="keyword">if</span> (!!createdStore) &#123;</span><br><span class="line">            event.entity.store_id = createdStore.id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> createForUser(user: User): <span class="built_in">Promise</span>&lt;Store | <span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (user.store_id) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> storeRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.storeRepository);</span><br><span class="line">        <span class="keyword">const</span> store = storeRepo.create() <span class="keyword">as</span> Store;</span><br><span class="line">        <span class="keyword">return</span> storeRepo.save(store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> <span class="function"><span class="title">retrieve</span>(<span class="params">relations: string[] = []</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.container.loggedInUser) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.retrieve(relations);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> storeRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.storeRepository);</span><br><span class="line">        <span class="keyword">const</span> store = <span class="keyword">await</span> storeRepo.findOne(&#123;</span><br><span class="line">            relations,</span><br><span class="line">            join: &#123; <span class="attr">alias</span>: <span class="string">&#x27;store&#x27;</span>, <span class="attr">innerJoin</span>: &#123; <span class="attr">members</span>: <span class="string">&#x27;store.members&#x27;</span> &#125; &#125;,</span><br><span class="line">            where: <span class="function">(<span class="params">qb</span>) =&gt;</span> &#123;</span><br><span class="line">                qb.where(<span class="string">&#x27;members.id = :memberId&#x27;</span>, &#123; <span class="attr">memberId</span>: <span class="built_in">this</span>.container.loggedInUser.id &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!store) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Unable to find the user store&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> store;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>@OnMedusaEntityEvent.Before.Insert</code> is used to add a listener to an insert event on an entity, which in this case is the <code>User</code> entity. Inside the listener, you create the user using the <code>createForUser</code> method. This method just uses the <code>StoreRepository</code> to create a store.</p>
<p>You also add a helper event <code>retrieve</code> to retrieve the store that belongs to the currently logged-in user.</p>
<p>Notice the use of <code>scope: &#39;SCOPED&#39;</code> in the <code>@Service</code> decorator. This will allow you to access the logged in user you registered earlier in the scope.</p>
<p>You’ll need to import this new class into the <code>StoreModule</code>. In <code>src/modules/store/store.module.ts</code> add the following import at the beginning:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> StoreService <span class="keyword">from</span> <span class="string">&#x27;./services/store.service&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>StoreService</code> to the <code>imports</code> array passed to <code>@Module</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imports: [Store, StoreRepository, StoreService],</span><br></pre></td></tr></table></figure>



<p><strong>Create a User Subscriber</strong></p>
<p>For the event listener to work, you need to first emit this event in a subscriber. The event will be emitted before a <code>User</code> is inserted. Create the file <code>src/modules/user/subscribers/user.subscriber.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Connection, EntitySubscriberInterface, EventSubscriber, InsertEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; eventEmitter, Utils <span class="keyword">as</span> MedusaUtils, OnMedusaEntityEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@EventSubscriber()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSubscriber</span> <span class="title">implements</span> <span class="title">EntitySubscriberInterface</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> attachTo(connection: Connection): <span class="keyword">void</span> &#123;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, UserSubscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public listenTo(): <span class="keyword">typeof</span> User &#123;</span><br><span class="line">        <span class="keyword">return</span> User;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> beforeInsert(event: InsertEvent&lt;User&gt;): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> eventEmitter.emitAsync(OnMedusaEntityEvent.Before.InsertEvent(User), &#123;</span><br><span class="line">            event,</span><br><span class="line">            transactionalEntityManager: event.manager,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will create a subscriber using the <code>EventSubscriber</code> decorator from <code>typeorm</code>. Then, before a user is inserted the <code>OnMedusaEntityEvent.Before.InsertEvent</code> event from <code>medusa-extender</code> is emitted, which will trigger creating the store.</p>
<p>To register the subscriber, you need to create a middleware that registers it. Create the file <code>src/modules/user/middlewares/userSubscriber.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  MEDUSA_RESOLVER_KEYS,</span><br><span class="line">  MedusaAuthenticatedRequest,</span><br><span class="line">  MedusaMiddleware,</span><br><span class="line">  Utils <span class="keyword">as</span> MedusaUtils,</span><br><span class="line">  Middleware</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserSubscriber <span class="keyword">from</span> <span class="string">&#x27;../subscribers/user.subscriber&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">false</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/users&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachUserSubscriberMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">async</span> consume(req: MedusaAuthenticatedRequest, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; connection &#125; = req.scope.resolve(MEDUSA_RESOLVER_KEYS.manager) <span class="keyword">as</span> &#123; <span class="attr">connection</span>: Connection &#125;;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, UserSubscriber);</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will register the subscriber when a <code>POST</code> request is sent to <code>/admin/users</code>, which creates a new user.</p>
<p><strong>Create a User Router</strong></p>
<p>The last customization left is an optional one. By default, Medusa’s create user endpoint requires you to be authenticated as an admin. In a marketplace use case, you might want users to register on their own and create their own stores. If this is not the case for you, you can skip creating the following class.</p>
<p>Medusa Extender allows you to also override routes in Medusa. In this case, you’ll be adding the <code>/admin/create-user</code> route to accept non-authenticated requests.</p>
<p>Create the file <code>src/modules/user/routers/user.router.ts</code> and add the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createUserHandler <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/api/routes/admin/users/create-user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> wrapHandler <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/api/middlewares/await-middleware&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Router(&#123;</span><br><span class="line">    routes: [</span><br><span class="line">        &#123;</span><br><span class="line">            requiredAuth: <span class="literal">false</span>,</span><br><span class="line">            path: <span class="string">&#x27;/admin/create-user&#x27;</span>,</span><br><span class="line">            method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">            handlers: [wrapHandler(createUserHandler)],</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRouter</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>You use the <code>@Router</code> decorator from <code>medusa-extender</code> to create a router. This router will accept a <code>routes</code> array which will either be added or override existing routes in your Medusa server. In this case, you override the <code>/admin/create-user</code> route and set <code>requiredAuth</code> to false.</p>
<p>To make sure that the <code>AttachUserSubscriberMiddleware</code> also runs for this new route (so that the before insert user event handlers run for this new route), make sure to add a new entry to the <code>routes</code> array:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">false</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/users&#x27;</span> &#125;, &#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/create-user&#x27;</span> &#125;] &#125;)</span><br></pre></td></tr></table></figure>



<p><strong>Create a User Module</strong></p>
<p>You’ve added all the customizations necessary to associate a user with their own store. Now, you can create the User module using these files.</p>
<p>Create the file <code>src/modules/user/user.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AttachUserSubscriberMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;./middlewares/userSubscriber.middleware&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoggedInUserMiddleware &#125; <span class="keyword">from</span> <span class="string">&quot;./middlewares/loggedInUser.middleware&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/user.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserRouter &#125; <span class="keyword">from</span> <span class="string">&quot;./routers/user.router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;./services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> addStoreIdToUser1644946220401 <span class="keyword">from</span> <span class="string">&#x27;./migrations/user.migration&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [</span><br><span class="line">        User,</span><br><span class="line">        UserService,</span><br><span class="line">        UserRepository,</span><br><span class="line">        addStoreIdToUser1644946220401,</span><br><span class="line">        UserRouter,</span><br><span class="line">        LoggedInUserMiddleware,</span><br><span class="line">        AttachUserSubscriberMiddleware</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>If you didn’t create the <code>UserRouter</code> in the previous step then make sure to remove it from the <code>imports</code> array.</p>
</blockquote>
<p>The last thing left is to import this Module. In <code>src/main.ts</code> import <code>UserModule</code> at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/user/user.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>UserModule</code> in the array passed as a parameter to <code>Medusa.load</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">        UserModule,</span><br><span class="line">        StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p><strong>Test it Out</strong></p>
<p>You are now ready to test out this customization! In your terminal, run your Medusa server:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// this is upgrade DB, also the same as scripts in package.json</span><br><span class="line">medusa seed -f data/seed.json -m</span><br><span class="line"></span><br><span class="line">// this is start medusa server</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>



<p>Or using Medusa’s CLI:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa develop</span><br></pre></td></tr></table></figure>



<p>After your run your server, you need to use a tool like <a target="_blank" rel="noopener" href="https://www.postman.com/">Postman</a> to easily send requests to your server.</p>
<p>If you didn’t add the <code>UserRouter</code>, you first need to log in as an admin to be able to add users. You can do that by sending a <code>POST</code> request to <code>localhost:9000/admin/auth</code>. In the body, you should include the email and password. If you’re using a fresh Medusa install you can use the following credentials:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;admin@medusa-test.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;supersecret&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Following this request, you can send authenticated requests to the Admin.</p>
<p>Send a <code>POST</code> request to <code>[localhost:9000/admin/users](http://localhost:9000/admin/users)</code> to create a new user. In the body, you need to pass the email and password of the new user:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;example@gmail.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;supersecret&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>The request will return a user object with the details of the new user:</p>
<p>![Create User Result](Open source ecommerce platform for multi-vendor marketplaces/1.png)</p>
<p>Notice how there’s a <code>store_id</code> field now. If you try to create a couple of users, you’ll see that the <code>store_id</code> will be different each time.</p>
<h3 id="Customize-the-Products-Entity"><a href="#Customize-the-Products-Entity" class="headerlink" title="Customize the Products Entity"></a>Customize the Products Entity</h3><p>Similar to how you just customized the <code>User</code> entity, you need to customize the <code>Product</code> entity to also hold the <code>store_id</code> with the relationship as well. You’ll then customize the <code>ProductService</code> as well as other classes to make sure that, when a product is created, the store ID of the user creating it is attached to it. You’ll also make sure that when the list of products is fetched, only the products that belong to the current user’s store are returned.</p>
<p><strong>Create a Product Entity</strong></p>
<p>Create the file <code>src/modules/product/entities/product.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Product <span class="keyword">as</span> MedusaProduct &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, Index, JoinColumn, ManyToOne &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store/entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaProduct &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">extends</span> <span class="title">MedusaProduct</span> </span>&#123;</span><br><span class="line">    @Index()</span><br><span class="line">    @Column(&#123; <span class="attr">nullable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    store_id: string;</span><br><span class="line"></span><br><span class="line">    @ManyToOne(<span class="function">() =&gt;</span> Store, <span class="function">(<span class="params">store</span>) =&gt;</span> store.members)</span><br><span class="line">    @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;store_id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;id&#x27;</span> &#125;)</span><br><span class="line">    store: Store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override Medusa’s <code>Product</code> entity to add the <code>store_id</code> field and relation to the <code>Store</code> entity.</p>
<p>You need to also reflect this relation in the <code>Store</code> entity, so, in <code>src/modules/store/entities/store.entity.ts</code> add the following code below the relation with the <code>User</code> entity you previously added:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(<span class="function">() =&gt;</span> Product, <span class="function">(<span class="params">product</span>) =&gt;</span> product.store)</span><br><span class="line">@JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">products: Product[];</span><br></pre></td></tr></table></figure>



<p>Make sure to import the <code>Product</code> entity at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../../product/entities/product.entity&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p><strong>Create a Product Migration</strong></p>
<p>Next, create the file <code>src/modules/product/migrations/product.migration.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MigrationInterface, QueryRunner &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Migration &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Migration()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">addStoreIdToProduct1645034402086</span> <span class="title">implements</span> <span class="title">MigrationInterface</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;addStoreIdToProduct1645034402086&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> up(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;product&quot; ADD COLUMN IF NOT EXISTS &quot;store_id&quot; text;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> down(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;product&quot; DROP COLUMN &quot;store_id&quot;;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will add a migration that will add the <code>store_id</code> column to the <code>product</code> table.</p>
<p><strong>Create a Product Repository</strong></p>
<p>Next, create the file <code>src/modules/product/repositories/product.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&quot;medusa-extender&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductRepository <span class="keyword">as</span> MedusaProductRepository &#125; <span class="keyword">from</span> <span class="string">&quot;@medusajs/medusa/dist/repositories/product&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaProductRepository &#125;)</span><br><span class="line">@EntityRepository(Product)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">Product</span>, <span class="title">MedusaProductRepository</span>&gt;(<span class="title">MedusaProductRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override Medusa’s <code>ProductRepository</code> to return your new <code>Product</code> entity.</p>
<p><strong>Create a Product Service</strong></p>
<p>Now, you’ll add the customization to ensure that only the products that belong to the currently logged-in user are returned when a request is sent.</p>
<p>Since you created the <code>LoggedInUserMiddleware</code> earlier, you can have access to the logged-in user from any service through the <code>container</code> object passed to the constructor of the service.</p>
<p>Create the file <code>src/modules/product/services/product.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; EntityEventType, MedusaEventHandlerParams, OnMedusaEntityEvent, Service &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductService <span class="keyword">as</span> MedusaProductService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;../../user/services/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type ConstructorParams = &#123;</span><br><span class="line">    manager: any;</span><br><span class="line">    loggedInUser: User;</span><br><span class="line">    productRepository: any;</span><br><span class="line">    productVariantRepository: any;</span><br><span class="line">    productOptionRepository: any;</span><br><span class="line">    eventBusService: any;</span><br><span class="line">    productVariantService: any;</span><br><span class="line">    productCollectionService: any;</span><br><span class="line">    productTypeRepository: any;</span><br><span class="line">    productTagRepository: any;</span><br><span class="line">    imageRepository: any;</span><br><span class="line">    searchService: any;</span><br><span class="line">    userService: UserService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">scope</span>: <span class="string">&#x27;SCOPED&#x27;</span>, <span class="attr">override</span>: MedusaProductService &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> <span class="keyword">extends</span> <span class="title">MedusaProductService</span> </span>&#123;</span><br><span class="line">    readonly #manager: EntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.#manager = container.manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prepareListQuery_(selector: object, <span class="attr">config</span>: object): object &#123;</span><br><span class="line">        <span class="keyword">const</span> loggedInUser = <span class="built_in">this</span>.container.loggedInUser</span><br><span class="line">        <span class="keyword">if</span> (loggedInUser) &#123;</span><br><span class="line">            selector[<span class="string">&#x27;store_id&#x27;</span>] = loggedInUser.store_id</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.prepareListQuery_(selector, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override the <code>prepareListQuery</code> method in Medusa’s <code>ProductService</code>, which this new class extends, to get the logged-in user. Then, if the user is retrieved successfully the key <code>store_id</code> is added to the <code>selector</code> object to filter the products by the user’s <code>store_id</code>.</p>
<p><strong>Create a Product Module</strong></p>
<p>That’s all the customization you’ll do for now. You just need to import all these files into a Product module.</p>
<p>Create <code>src/modules/product/product.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/product.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ProductRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/product.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductService &#125; <span class="keyword">from</span> <span class="string">&#x27;./services/product.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> addStoreIdToProduct1645034402086 <span class="keyword">from</span> <span class="string">&#x27;./migrations/product.migration&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [</span><br><span class="line">      Product,</span><br><span class="line">      ProductRepository,</span><br><span class="line">      ProductService,</span><br><span class="line">      addStoreIdToProduct1645034402086,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>Finally, import the <code>ProductModule</code> at the beginning of <code>src/main.ts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ProductModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/product/product.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>And add the <code>ProductModule</code> to the array passed to <code>load</code> along with <code>UserModule</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">    UserModule,</span><br><span class="line">    ProductModule,</span><br><span class="line">    StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p><strong>Test it Out</strong></p>
<p>You can go ahead and test it out now. Run the server if it isn’t running already and log in with the user you created earlier by sending the credentials to <code>localhost:9000/admin/auth</code>.</p>
<p>After that, send a <code>GET</code> request to <code>localhost:9000/admin/products</code>. You’ll receive an empty array of products as the current user does not have any products yet.</p>
<p>![Result of Get Products](Open source ecommerce platform for multi-vendor marketplaces/2.png)</p>
<p>You’ll now add the necessary customization to attach a store ID to a newly created product.</p>
<p>To listen to the product created event, create the file <code>src/modules/product/subscribers/product.subscriber.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Connection, EntitySubscriberInterface, EventSubscriber, InsertEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; OnMedusaEntityEvent, Utils, eventEmitter &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@EventSubscriber()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductSubscriber</span> <span class="title">implements</span> <span class="title">EntitySubscriberInterface</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> attachTo(connection: Connection): <span class="keyword">void</span> &#123;</span><br><span class="line">        Utils.attachOrReplaceEntitySubscriber(connection, ProductSubscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public listenTo(): <span class="keyword">typeof</span> Product &#123;</span><br><span class="line">        <span class="keyword">return</span> Product;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> beforeInsert(event: InsertEvent&lt;Product&gt;): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> eventEmitter.emitAsync(OnMedusaEntityEvent.Before.InsertEvent(Product), &#123;</span><br><span class="line">            event,</span><br><span class="line">            transactionalEntityManager: event.manager,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Then, you need to register this Subscriber using Middleware. Create the file <code>src/modules/product/middlewares/product.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  MEDUSA_RESOLVER_KEYS,</span><br><span class="line">  MedusaAuthenticatedRequest,</span><br><span class="line">  MedusaMiddleware,</span><br><span class="line">  Utils <span class="keyword">as</span> MedusaUtils,</span><br><span class="line">  Middleware</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ProductSubscriber <span class="keyword">from</span> <span class="string">&#x27;../subscribers/product.subscriber&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">true</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/products&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachProductSubscribersMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public consume(req: MedusaAuthenticatedRequest | Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="keyword">void</span> | <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; connection &#125; = req.scope.resolve(MEDUSA_RESOLVER_KEYS.manager) <span class="keyword">as</span> &#123; <span class="attr">connection</span>: Connection &#125;;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, ProductSubscriber);</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will register the subscriber when a <code>POST</code> request is sent to <code>/admin/products</code>, which creates a new product.</p>
<p><strong>Add Event Listener in Product Service</strong></p>
<p>Next, in <code>src/modules/product/services/product.service.ts</code> add the following inside the class:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@OnMedusaEntityEvent.Before.Insert(Product, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">public <span class="keyword">async</span> attachStoreToProduct(</span><br><span class="line">    params: MedusaEventHandlerParams&lt;Product, <span class="string">&#x27;Insert&#x27;</span>&gt;</span><br><span class="line">): <span class="built_in">Promise</span>&lt;EntityEventType&lt;Product, <span class="string">&#x27;Insert&#x27;</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; event &#125; = params;</span><br><span class="line">    <span class="keyword">const</span> loggedInUser = <span class="built_in">this</span>.container.loggedInUser;</span><br><span class="line">    event.entity.store_id = loggedInUser.store_id;</span><br><span class="line">    <span class="keyword">return</span> event;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will listen to the Insert event using the <code>@OnMedusaEntityEvent</code> decorator from <code>medusa-extender</code>. It will then use the logged-in user and attach the user’s <code>store_id</code> to the newly created product.</p>
<p><strong>Add Middleware to Product Module</strong></p>
<p>Finally, make sure to import the new middleware at the beginning of <code>src/modules/product/product.module.ts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> AttachProductSubscribersMiddleware <span class="keyword">from</span> <span class="string">&#x27;./middlewares/product.middleware&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add it in the <code>imports</code> array passed to <code>@Module</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  Product,</span><br><span class="line">  ProductRepository,</span><br><span class="line">  ProductService,</span><br><span class="line">  addStoreIdToProduct1645034402086,</span><br><span class="line">  AttachProductSubscribersMiddleware</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>You’re ready to add products into a store now! Run the server if it’s not running and make sure you’re logged in with the user you created earlier. Then, send a <code>POST</code> request to <code>[localhost:9000/admin/products](http://localhost:9000/admin/products)</code> with the following body:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;my product&quot;</span>,</span><br><span class="line">    <span class="string">&quot;options&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This is the minimum structure of a product. You can rename the title to anything you want.</p>
<p>After you send the request, you should receive a Product object where you can see the <code>store_id</code> is set to the same <code>store_id</code> of the user you’re logged in with.</p>
<p>![Add Product Request Result](Open source ecommerce platform for multi-vendor marketplaces/3.png)</p>
<p>Now, try sending a <code>GET</code> request to <code>[localhost:9000/admin/products](http://localhost:9000/admin/products)</code> as you did earlier. Instead of an empty array, you’ll see the product you just added.</p>
<p>![Retrieve Products](Open source ecommerce platform for multi-vendor marketplaces/4.png)</p>
<h2 id="Testing-it-Out-Using-Medusa’s-Admin"><a href="#Testing-it-Out-Using-Medusa’s-Admin" class="headerlink" title="Testing it Out Using Medusa’s Admin"></a>Testing it Out Using Medusa’s Admin</h2><p>If you also have a <a target="_blank" rel="noopener" href="https://github.com/medusajs/admin">Medusa Admin</a> instance installed, you can also test this out. Log in with the user you created earlier and you’ll see that you can only see the product they added.</p>
<p>![Admin Dashboard](Open source ecommerce platform for multi-vendor marketplaces/5.png)</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this tutorial, you learned the first steps of creating a Marketplace using Medusa and Medusa Extender! In later points, you’ll learn about how you can add settings, manage orders, and more!</p>
<p>Be sure to support <a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender">Medusa Extender</a> and check the repository out for more details!</p>
<p>Should you have any issues or questions related to Medusa, then feel free to reach out to the Medusa team via <a target="_blank" rel="noopener" href="https://discord.gg/F87eGuwkTp">Discord</a>. You can also contact Adrien <code>@adrien2p</code> for more details or help regarding Medusa Extender.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/26/3.Create%20medusa%20transaction%20step%20by%20step/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/26/3.Create%20medusa%20transaction%20step%20by%20step/" class="post-title-link" itemprop="url">3.Create medusa transaction step by step</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-26 21:39:00" itemprop="dateCreated datePublished" datetime="2022-04-26T21:39:00+08:00">2022-04-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-05-11 15:47:57" itemprop="dateModified" datetime="2023-05-11T15:47:57+08:00">2023-05-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>This is a collection of medusa-postman, from the name sequence, we can see the business steps one by one.</p>
<p>It is based on <a target="_blank" rel="noopener" href="https://github.com/medusajs/medusa/releases/tag/%40medusajs%2Fmedusa%401.2.1">@medusajs/medusa@1.2.1</a>, <a target="_blank" rel="noopener" href="https://github.com/medusajs/medusa/releases/tag/%40medusajs%2Fmedusa-cli%401.2.1">@medusajs/medusa-cli@1.2.1</a>.</p>
<p>Please import this json as a file into postman, you can call the API step by step.</p>
<p>![](3.Create medusa transaction step by step/1.png)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;info&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;_postman_id&quot;</span>: <span class="string">&quot;d0447766-3c8d-4b70-bf6c-ca66061249f8&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;medusa&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;schema&quot;</span>: <span class="string">&quot;https://schema.getpostman.com/json/collection/v2.1.0/collection.json&quot;</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">&quot;item&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;1.Authenticate a User&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n  \&quot;email\&quot;: \&quot;zwm136200@gmail.com\&quot;,\n  \&quot;password\&quot;: \&quot;zaq12wsx\&quot;\n&#125;\n&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/admin/auth&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">						<span class="string">&quot;auth&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;2.Create product&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n\t\&quot;title\&quot;: \&quot;nft-04-26-test-01\&quot;,\n\t\&quot;subtitle\&quot;: \&quot;\&quot;,\n\t\&quot;description\&quot;: \&quot;this is a test\&quot;,\n\t\&quot;is_giftcard\&quot;: false,\n\t\&quot;discountable\&quot;: false,\n\t\&quot;images\&quot;: [],\n\t\&quot;thumbnail\&quot;: \&quot;\&quot;,\n\t\&quot;handle\&quot;: \&quot;test-nft-product-04-27\&quot;,\n\t\&quot;weight\&quot;: 10,\n\t\&quot;length\&quot;: 20,\n\t\&quot;height\&quot;: 5,\n\t\&quot;width\&quot;: 10,\n\t\&quot;origin_country\&quot;: \&quot;\&quot;,\n\t\&quot;mid_code\&quot;: \&quot;\&quot;,\n\t\&quot;material\&quot;: \&quot;\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/admin/products&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">						<span class="string">&quot;products&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;3.Create a Customer-admin&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n  \&quot;email\&quot;: \&quot;test1@gmail.com\&quot;,\n  \&quot;password\&quot;: \&quot;test1\&quot;,\n  \&quot;first_name\&quot;: \&quot;firstname\&quot;,\n  \&quot;last_name\&quot;: \&quot;lastname\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/admin/customers&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">						<span class="string">&quot;customers&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;3.Create a Customer-store&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n  \&quot;email\&quot;: \&quot;test2@gmail.com\&quot;,\n  \&quot;password\&quot;: \&quot;test2\&quot;,\n  \&quot;first_name\&quot;: \&quot;firstname2\&quot;,\n  \&quot;last_name\&quot;: \&quot;lastname2\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/customers&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;customers&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;4.Auth a customer&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n  \&quot;email\&quot;: \&quot;test1@gmail.com\&quot;,\n  \&quot;password\&quot;: \&quot;test1\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/auth&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;auth&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;4.1 get regions&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/regions&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;regions&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;5.Create a cart&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n    \&quot;region_id\&quot;: \&quot;reg_01G1FPXMTTD926PVCYW9WT9QSN\&quot;,\n    \&quot;country_code\&quot;: \&quot;cn\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/carts&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;carts&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;5.1 Add a item&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n    \&quot;variant_id\&quot;: \&quot;variant_01G1G2029D4ASNYWGEX9TCSVTY\&quot;,\n    \&quot;quantity\&quot;: 1\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/carts/cart_01G1G1R5D2JCA2CP0HV55JHEMJ/line-items&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;carts&quot;</span>,</span><br><span class="line">						<span class="string">&quot;cart_01G1G1R5D2JCA2CP0HV55JHEMJ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;line-items&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;5.2Add a Shipping Method&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n    \&quot;option_id\&quot;: \&quot;so_01G1FZ76DY5XVRT64639856AR0\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;5.3Calculate Cart Taxes&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/carts/cart_01G1G1R5D2JCA2CP0HV55JHEMJ/taxes&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;carts&quot;</span>,</span><br><span class="line">						<span class="string">&quot;cart_01G1G1R5D2JCA2CP0HV55JHEMJ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;taxes&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;5.4Initialize Payment Sessions&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/carts/cart_01G1G1R5D2JCA2CP0HV55JHEMJ/payment-sessions&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;carts&quot;</span>,</span><br><span class="line">						<span class="string">&quot;cart_01G1G1R5D2JCA2CP0HV55JHEMJ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;payment-sessions&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;5.5Complete a Cart - create an order&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/store/carts/cart_01G1G1R5D2JCA2CP0HV55JHEMJ/complete&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;store&quot;</span>,</span><br><span class="line">						<span class="string">&quot;carts&quot;</span>,</span><br><span class="line">						<span class="string">&quot;cart_01G1G1R5D2JCA2CP0HV55JHEMJ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;complete&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;6.Capture an Order - payment finished&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/admin/orders/order_01G1G6DRGQQX5QBF7RQY1JYWWQ/capture&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">						<span class="string">&quot;orders&quot;</span>,</span><br><span class="line">						<span class="string">&quot;order_01G1G6DRGQQX5QBF7RQY1JYWWQ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;capture&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;7.Create a Fulfillment - order fulfilled&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n    \&quot;items\&quot;: [\n        &#123;\n            \&quot;item_id\&quot;: \&quot;item_01G1G21Z2G7VDXYZ51AZM53YNN\&quot;,\n            \&quot;quantity\&quot;: 1\n        &#125;\n    ],\n    \&quot;metadata\&quot;: &#123;&#125;,\n    \&quot;no_notification\&quot;: false\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/admin/orders/order_01G1G6DRGQQX5QBF7RQY1JYWWQ/fulfillment&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">						<span class="string">&quot;orders&quot;</span>,</span><br><span class="line">						<span class="string">&quot;order_01G1G6DRGQQX5QBF7RQY1JYWWQ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;fulfillment&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">&quot;name&quot;</span>: <span class="string">&quot;8.Create a Shipment - order shipped&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">				<span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">				<span class="attr">&quot;header&quot;</span>: [],</span><br><span class="line">				<span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;&#123;\n    \&quot;fulfillment_id\&quot;: \&quot;ful_01G1JKV7Y3V25GDBE8T30EH0GB\&quot;\n&#125;&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">						<span class="attr">&quot;raw&quot;</span>: &#123;</span><br><span class="line">							<span class="attr">&quot;language&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">					<span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;localhost:9000/admin/orders/order_01G1G6DRGQQX5QBF7RQY1JYWWQ/shipment&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;host&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;localhost&quot;</span></span><br><span class="line">					],</span><br><span class="line">					<span class="attr">&quot;port&quot;</span>: <span class="string">&quot;9000&quot;</span>,</span><br><span class="line">					<span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">						<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">						<span class="string">&quot;orders&quot;</span>,</span><br><span class="line">						<span class="string">&quot;order_01G1G6DRGQQX5QBF7RQY1JYWWQ&quot;</span>,</span><br><span class="line">						<span class="string">&quot;shipment&quot;</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">&quot;response&quot;</span>: []</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/26/2.How%20to%20complete%20an%20order%20in%20medusa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/26/2.How%20to%20complete%20an%20order%20in%20medusa/" class="post-title-link" itemprop="url">2.How to complete an order in medusa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-26 21:34:00" itemprop="dateCreated datePublished" datetime="2022-04-26T21:34:00+08:00">2022-04-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-05-11 15:37:17" itemprop="dateModified" datetime="2023-05-11T15:37:17+08:00">2023-05-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h3><p>How can I finish (or complete) an order? I already run Capture an Order -&gt; Create a Fulfillment -&gt; Create a Shipment successfully, but the order status is “pending” in DB. (in Ubuntu / medusa version <a target="_blank" rel="noopener" href="https://github.com/medusajs/medusa/releases/tag/v1.7.12">v1.7.12</a>)</p>
<h3 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h3><p>You can create a simple subscriber, that listens for order completion events:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderSubscriber</span> </span>&#123;</span><br><span class="line">  constructor(&#123; orderService, eventBusService &#125;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.orderService_ = orderService;</span><br><span class="line">    eventBusService.subscribe(<span class="string">&quot;order.placed&quot;</span>, <span class="keyword">this</span>.handleOrderPlaced);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleOrderPlaced = async (data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> await <span class="keyword">this</span>.orderService_.update(data.id, &#123; status: <span class="string">&quot;completed&quot;</span> &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> OrderSubscriber;</span><br></pre></td></tr></table></figure>



<p>![](2.How to complete an order in medusa/1.png)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/18/1.Medusajs%20quick%20start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/18/1.Medusajs%20quick%20start/" class="post-title-link" itemprop="url">1.medusajs quick start</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-18 14:03:00" itemprop="dateCreated datePublished" datetime="2022-04-18T14:03:00+08:00">2022-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-05-11 15:31:53" itemprop="dateModified" datetime="2023-05-11T15:31:53+08:00">2023-05-11</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="in-Ubuntu-medusa-version-v1-7-12"><a href="#in-Ubuntu-medusa-version-v1-7-12" class="headerlink" title="in Ubuntu / medusa version v1.7.12"></a>in Ubuntu / medusa version <a target="_blank" rel="noopener" href="https://github.com/medusajs/medusa/releases/tag/v1.7.12">v1.7.12</a></h2><p>nodejs version</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ node -v</span><br><span class="line">v16.14.1</span><br><span class="line">➜  ~ npm -v</span><br><span class="line">8.5.0</span><br></pre></td></tr></table></figure>

<h3 id="Quickstart"><a href="#Quickstart" class="headerlink" title="Quickstart"></a>Quickstart</h3><ol>
<li><p>Install Medusa CLI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @medusajs&#x2F;medusa-cli</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a new Medusa project</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa new my-medusa-store --seed</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start redis (in ubuntu)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart redis-server</span><br><span class="line">➜  ~ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; select</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;select&#x27; command</span><br><span class="line">127.0.0.1:6379&gt; select 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; FLUSHDB</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start postgres DB (in ubuntu)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo /etc/init.d/postgresql start</span><br><span class="line">[sudo] password for zhuang: </span><br><span class="line">➜  ~ </span><br><span class="line">➜  ~ sudo -i -u postgres</span><br><span class="line">postgres@elementoryos61:~$ psql</span><br><span class="line">psql (12.9 (Ubuntu 12.9-0ubuntu0.20.04.1))</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line">postgres=# CREATE DATABASE openharbor_marketplace_medusa;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=# </span><br></pre></td></tr></table></figure>
</li>
<li><p>Config postgress</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// CORS when consuming Medusa from admin</span><br><span class="line">const ADMIN_CORS = process.env.ADMIN_CORS || &quot;http://localhost:7000,http://localhost:7001&quot;;</span><br><span class="line"></span><br><span class="line">// CORS to avoid issues when consuming Medusa from a client</span><br><span class="line">const STORE_CORS = process.env.STORE_CORS || &quot;http://localhost:8000&quot;;</span><br><span class="line"></span><br><span class="line">// Database URL (here we use a local database called medusa-development)</span><br><span class="line">const DATABASE_URL =</span><br><span class="line">  process.env.DATABASE_URL || &quot;postgres://postgres:postgres@localhost:5432/openharbor_marketplace_medusa&quot;;</span><br><span class="line"></span><br><span class="line">// Medusa uses Redis, so this needs configuration as well</span><br><span class="line">const REDIS_URL = process.env.REDIS_URL || &quot;redis://localhost:6379&quot;;</span><br><span class="line"></span><br><span class="line">// This is the place to include plugins. See API documentation for a thorough guide on plugins.</span><br><span class="line">const plugins = [</span><br><span class="line">  `medusa-fulfillment-manual`,</span><br><span class="line">  `medusa-payment-manual`,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  projectConfig: &#123;</span><br><span class="line">    redis_url: REDIS_URL,</span><br><span class="line">    // For more production-like environment install PostgresQL</span><br><span class="line">    database_url: DATABASE_URL,</span><br><span class="line">    database_type: &quot;postgres&quot;,</span><br><span class="line">    // database_database: &quot;./medusa-db.sql&quot;,</span><br><span class="line">    //database_type: &quot;sqlite&quot;,</span><br><span class="line">    store_cors: STORE_CORS,</span><br><span class="line">    admin_cors: ADMIN_CORS,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Init data for postgres DB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa migrations run</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start your Medusa engine</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa develop</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use the API, check medusa server status.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9000/store/products</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="Setting-up-Admin"><a href="#Setting-up-Admin" class="headerlink" title="Setting up Admin"></a>Setting up Admin</h3><ol>
<li><p>Clone this repository</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/medusajs/admin medusa-admin</span><br><span class="line">cd medusa-admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>Install dependencies</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn install</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start the development server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Go to <a target="_blank" rel="noopener" href="http://localhost:7000/">http://localhost:7000</a></strong></p>
</li>
<li><p>Back in your Medusa engine installation directory, you can create your own user for the admin by running:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa user -e some@email.com -p some-password</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Setup-medusa-plugin-filestorage-local"><a href="#Setup-medusa-plugin-filestorage-local" class="headerlink" title="Setup medusa-plugin-filestorage-local"></a>Setup <strong><a target="_blank" rel="noopener" href="https://github.com/Blechlawine/medusa-plugin-filestorage-local">medusa-plugin-filestorage-local</a></strong></h2><p>setup medusa local file service for Images of product which support you create product in Admin.</p>
<ol>
<li><p>Back in your Medusa engine installation directory,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install medusa-plugin-filestorage-local</span><br></pre></td></tr></table></figure>
</li>
<li><p>Setup config in medusa-config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> plugins = [</span><br><span class="line">  <span class="string">`medusa-fulfillment-manual`</span>,</span><br><span class="line">  <span class="string">`medusa-payment-manual`</span>,</span><br><span class="line">  &#123;</span><br><span class="line">  	resolve: <span class="string">`medusa-plugin-filestorage-local`</span>,</span><br><span class="line">  	options: &#123;</span><br><span class="line"> 	   <span class="comment">// The baseurl for your medusajs server</span></span><br><span class="line">    	   serverBaseUrl: <span class="string">&quot;http://localhost:9000&quot;</span>,</span><br><span class="line">    	   <span class="comment">// when enabled saves the file as a base64 encoded string inside the database (deleting that row is not yet supported)</span></span><br><span class="line">    	   saveInDatabase: <span class="literal">false</span>, <span class="comment">// recommended: false</span></span><br><span class="line">    	   <span class="comment">// the folder where your files are stored on the server</span></span><br><span class="line">    	   fileLocation: <span class="string">&quot;uploads/persistent/&quot;</span>,</span><br><span class="line">    	&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
<li><p>Restart medusa server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">medusa develop</span><br><span class="line">// or</span><br><span class="line">medusa start</span><br></pre></td></tr></table></figure>
</li>
<li><p>then, you can create a product in medusa admin. e.g. <a target="_blank" rel="noopener" href="http://localhost:7000/">http://localhost:7000/</a></p>
</li>
</ol>
<p>====================================================================</p>
<h2 id="in-Mac-medusa-version-v1-10-1"><a href="#in-Mac-medusa-version-v1-10-1" class="headerlink" title="in Mac / medusa version v1.10.1"></a>in Mac / medusa version <a target="_blank" rel="noopener" href="https://github.com/medusajs/medusa/releases/tag/v1.10.1">v1.10.1</a></h2><p>Follow the medusa guide <a target="_blank" rel="noopener" href="https://docs.medusajs.com/development/backend/prepare-environment">https://docs.medusajs.com/development/backend/prepare-environment</a></p>
<ol>
<li>node version</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ node -v   </span><br><span class="line">v18.16.0</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Install medusa CLI</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install @medusajs/medusa-cli -g</span><br><span class="line"></span><br><span class="line">➜  ~ medusa -v                           </span><br><span class="line">Medusa CLI version: 1.3.13</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Create a new Medusa project</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa new my-medusa-store --seed</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Start your Medusa backend</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd my-medusa-store</span><br><span class="line">medusa develop</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Test the Backend</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9000/store/products</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>PostgreSQL Configurations</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const DATABASE_TYPE = process.env.DATABASE_TYPE || &quot;postgres&quot;;</span><br><span class="line">const DATABASE_URL = process.env.DATABASE_URL || &quot;postgres://postgres:zaq12wsx@localhost:5432/pg-medusa-1-10-1-test&quot;;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>Update DB</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa migrations run</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>medusa can mock Redis for test</li>
</ol>
<h3 id="For-admin-dashboard"><a href="#For-admin-dashboard" class="headerlink" title="For admin dashboard"></a>For admin dashboard</h3><ol>
<li>back the folder path of medusa, Install the Package of Admin Dashboard</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @medusajs/admin</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Add Admin to Medusa Configurations.</li>
</ol>
<p>In <code>medusa-config.js</code>, add the admin plugin into the array of <code>plugins</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> plugins = [</span><br><span class="line">  <span class="string">`medusa-fulfillment-manual`</span>,</span><br><span class="line">  <span class="string">`medusa-payment-manual`</span>,</span><br><span class="line">  <span class="comment">// To enable the admin plugin, uncomment the following lines and run `yarn add @medusajs/admin`</span></span><br><span class="line">   &#123;</span><br><span class="line">     resolve: <span class="string">&quot;@medusajs/admin&quot;</span>,</span><br><span class="line">     <span class="comment">/** <span class="doctag">@type <span class="type">&#123;import(&#x27;@medusajs/admin&#x27;).PluginOptions&#125;</span> </span>*/</span></span><br><span class="line">     options: &#123;</span><br><span class="line">       autoRebuild: <span class="literal">true</span>,</span><br><span class="line">     &#125;,</span><br><span class="line">   &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>The plugin accepts the following options:</p>
<p>a. <code>serve</code>: (default: <code>true</code>) a boolean indicating whether to serve the admin dashboard when the Medusa backend starts. If set to <code>false</code>, you can serve the admin dashboard using the <a target="_blank" rel="noopener" href="https://docs.medusajs.com/admin/quickstart#dev-command-options">dev command</a>.</p>
<p>b. <code>path</code>: (default: <code>app</code>) a string indicating the path the admin server should run on. It shouldn’t be prefixed or suffixed with a slash <code>/</code>, and it can’t be one of the reserved paths: “admin” and “store”.</p>
<p>c. <code>outDir</code>: Optional path for where to output the admin build files.</p>
<p>e. <code>autoRebuild</code>: (default: <code>false</code>) a boolean indicating whether the admin UI should be rebuilt if there are any changes or if a missing build is detected when the backend starts. If not set, you must <a target="_blank" rel="noopener" href="https://docs.medusajs.com/admin/quickstart#build-command-options">manually build the admin dashboard</a>.</p>
<ol start="3">
<li>Start the Admin Dashboard</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Create a New Admin User</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa user -e some@email.com -p some-password</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/14/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/51/">51</a><a class="extend next" rel="next" href="/page/16/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weiming Zhuang</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  




  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'none'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>




</body>
</html>
