<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhuang-weiming.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.3.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="Zhuang&#39;s Diary">
<meta property="og:url" content="https://zhuang-weiming.github.io/page/21/index.html">
<meta property="og:site_name" content="Zhuang&#39;s Diary">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Weiming Zhuang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zhuang-weiming.github.io/page/21/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<title>Zhuang's Diary</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zhuang's Diary</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">言之有物，持之以恒</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Weiming Zhuang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">287</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/zhuangweiming/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;zhuangweiming&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/05/13/%E7%BF%BB%E8%AF%912-Decentralized%20Society%20Finding%20Web3%20Soul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/13/%E7%BF%BB%E8%AF%912-Decentralized%20Society%20Finding%20Web3%20Soul/" class="post-title-link" itemprop="url">翻译2-Decentralized Society Finding Web3 Soul</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-05-13 16:50:00 / Modified: 18:59:54" itemprop="dateCreated datePublished" datetime="2022-05-13T16:50:00+08:00">2022-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<h3 id="§6-DECENTRALIZED-SOCIETY"><a href="#§6-DECENTRALIZED-SOCIETY" class="headerlink" title="§6 DECENTRALIZED SOCIETY"></a>§6 DECENTRALIZED SOCIETY</h3><p>Web3 aspires to transform societies broadly, rather than merely financial systems. Yet today’s social fabric—families, churches, teams, companies, civil society, celebrity, democracy—is meaningless in virtual worlds (often called the “metaverse”) without primitives representing human souls and the broader relationships they support. If web3 eschews persistent identities, their patterns of trust and cooperation, and their composable rights and permissions, we see, respectively, sybil attacks, collusion, and a limited economic realm of wholly transferable private property—all of which trends towards hyper-financialization. </p>
<p>To skirt hyper-financialization—yet unlock exponential growth—we propose augmenting and bridging our sociality across virtual and physical realities, empowering souls and communities to encode rich social and economic relationships. But simply building on trust and cooperation is not enough. Correcting for biases and tendencies to over-coordinate (or collude) among trust networks is essential to encouraging more intricate, diverse relationships that span greater social distances than before. We call this “Decentralized Society (DeSoc)”: a co-determined sociality, where Souls and Communities convene bottom-up, as emergent properties of each other to produce plural network goods across different scales.</p>
<p>We emphasize plural network goods as a feature of DeSoc, because networks are the most powerful engine of economic growth, yet the most susceptible to dystopian capture by private actors (e.g., web2) and powerful governments (e.g., Chinese Communist Party). Most significant economic growth results from increasing network returns, where every additional unit of input yields incrementally more output. Examples of simple physical networks include roads, electrical grids, cities, and other forms of infrastructure built off labor and other capital inputs. Examples of powerful digital networks include marketplaces, predictive models and plural intelligences built o￾ data. In both cases, network economics diverges from neoclassical economics, which teaches decreasing returns—where every additional unit of input yields incrementally less output—and where private property yields the most efficient outcomes. Private property applied to an increasing returns context has the opposite effect—throttling network growth by rent extraction. A road between two cities can unlock increasing returns from gains from trade. But the same road privately owned can throttle growth if the owners choose to extract rent up to the value trading between the two cities. Public ownership over a network also has its own perils, being susceptible to regulatory capture or underfunding.</p>
<p>Networks with increasing returns are most efficient when treated neither as purely public nor purely private goods, but rather as partial and plural shared goods. DeSoc provides the social substrate to unbundle and reconfigure rights—rights of use (“usus”), rights to consume or destroy (“abusus”), and rights of profit (“fructus”)—and enable efficient governance mechanisms across these rights that augment trust and cooperation while checking for collusion and capture. We’ve explored several mechanisms throughout this paper, such as community-based SALSA and quadratic funding (and voting) discounted by correlation scores. This third way of partial and plural ownership avoids the Charybdis of private rent extraction and Scylla of public regulatory capture.</p>
</blockquote>
<p>Web3 渴望广泛地改变社会，而不仅仅是金融系统。然而，今天的社会结构——家庭、教堂、团队、公司、公民社会、名人、民主——在没有代表人类灵魂的原始人和他们所支持的更广泛关系的虚拟世界（通常称为“元界”）中毫无意义。如果 web3 避开持久性身份、信任和合作模式以及可组合的权利和许可，我们将分别看到女巫攻击、勾结和完全可转让的私有财产的有限经济领域——所有这些都趋向于超金融化。</p>
<p>为了避免过度金融化——同时释放指数级增长——我们建议在虚拟和物理现实中增强和连接我们的社交性，赋予灵魂和社区以编码丰富的社会和经济关系的能力。但仅仅建立在信任与合作之上是不够的。纠正信任网络之间的偏见和过度协调（或勾结）的倾向对于鼓励比以前跨越更大社会距离的更复杂、更多样化的关系至关重要。<strong>我们称之为“去中心化社会（DeSoc）”：一种共同决定的社会性，灵魂和社区自下而上地聚集在一起，作为彼此的新兴属性，以生产不同规模的多种网络商品。</strong></p>
<p>我们强调多元网络商品是 DeSoc 的一个特征，因为网络是经济增长最强大的引擎，但最容易被私人参与者（例如 web2）和强大的政府（例如中国共产党）所俘获。最显着的经济增长来自网络回报的增加，其中每增加一个输入单位就会产生更多的输出。简单的物理网络的例子包括道路、电网、城市和其他形式的基础设施，这些基础设施是建立在劳动力和其他资本投入之上的。强大的数字网络的例子包括市场、预测模型和基于数据的多元智能。在这两种情况下，网络经济学都不同于新古典经济学，后者教导收益递减——每增加一个单位的投入产生的产出就会逐渐减少——而私有财产产生最有效的结果。在收益递增的情况下，私有财产会产生相反的效果——通过提取租金来抑制网络增长。两座城市之间的道路可以从贸易收益中获得越来越多的回报。但如果业主选择将租金提高到两个城市之间的价值交易，同一条私人拥有的道路可能会抑制增长。网络的公共所有权也有其自身的风险，容易受到监管或资金不足的影响。</p>
<p><strong>当既不将其视为纯粹的公共物品或纯粹的私人物品，而是将其视为部分和复数的共享物品时，回报递增的网络效率最高。</strong>DeSoc 为分解和重新配置权利提供了社会基础——使用权（“usus”）、消费或破坏权（“abusus”）和利润权（“fructus”）——并在这些权利中启用有效的治理机制， 在检查合谋和俘虏的同时增强信任和合作。 我们在本文中探索了几种机制，例如基于社区的 SALSA 和相关分数打折的二次融资（和投票）。 第三种部分和复数所有权避免了私人租金提取的 Charybdis 和公共监管捕获的 Scylla。</p>
<blockquote>
<p>In many ways, DeFi today is a decreasing returns private property paradigm retro￾tted onto increasing returns networks. Built on the premise of trustlessness, DeFi is inherently limited to the realm of wholly transferable private property (e.g., transferable tokens) that mostly bundles “usus,” “abusus,” and “fructus.” At best, DeFi risks throttling network growth by rent extraction and at worst risks ushering in dystopian surveillance monopolies dominated by “whales’’ who harvest and hoover up data in a race-to-the-bottom—much like web2. </p>
<p>DeSoc transforms DeFi’s race to control and speculate on the value of networks into a bottom-up coordination to build, participate, and govern them. At minimum, DeSoc’s social substrate can make DeFisybil-resistant (enabling community governance), vampire-resistant (internalizing positive externalities to build an open-source network), and collusion-resistant (preserving a network’s decentralization). With DeSoc’s structural corrections, DeFi can support and expand plural networks that confer benefits broadly—as agreed upon by the most diverse members—rather than further entrenching networks captured by narrow interests.</p>
<p>Yet, the greatest strength of DeSoc is its network composability. Sustained increasing returns and network growth isn’t simply avoiding the perils of rent extraction, but also encouraging the proliferation and intersection of nested networks. A road may form a network between two cities. But cut off from broader cooperation, two cooperating cities will eventually hit a ceiling of diminishing returns—either because of congestion (roads and housing) or exhaustion (reaching the limits of the people they can serve). Only through technological innovation and growing broader, if looser, cooperation with neighboring networks for new sources of increasing returns can value continue to grow exponentially. Some cooperation will be physical, incrementally extending physical trade across space. But many more connections will be informational and digital. Over time, we will see new matrices of cooperation between physical and digital networks, reliant upon and extending the social interconnections they are built on. It is precisely this intersecting, partly nested structure of ever growing network cooperation across digital and physical worlds that DeSoc enables.</p>
<p>Through composing networks and coordination, DeSoc emerges at the intersection of politics and markets—augmenting both with sociality. DeSoc empowers the vision of JCR Licklider—founder of ARPANET that created the internet—of “man-computer symbiosis” in an “intergalactic computer network” with dramatically increased social dynamism built on trust. Rather than build on DeFi’s trustless premise, DeSoc encodes trust networks that underpin the real economy today and enables us to harness them to generate plural network goods resilient to capture, extraction, or domination. With such augmented sociality, web3 can eschew short-term hyper-financialization in favor of an unbounded future of increasing returns across social distance.</p>
</blockquote>
<p>在许多方面，<strong>今天的 DeFi 是一种收益递减的私有财产范式，被改造成收益递增的网络。</strong>DeFi 建立在无需信任的前提下，本质上仅限于完全可转让的私有财产（例如可转让代币）领域，主要捆绑了 “usus”、 “abusus” 和 “fructus”。充其量，DeFi 有可能通过提取租金来限制网络增长，而在最坏的情况下，有可能迎来由“鲸鱼”主导的反乌托邦监视垄断，这些鲸鱼在竞相下收集和吸食数据——就像 web2 一样。</p>
<p>DeSoc 将 DeFi 控制和推测网络价值的竞赛转变为自下而上的协调，以构建、参与和管理它们。至少，DeSoc 的社会基础可以使 DeFisybil 抗性（支持社区治理）、吸血鬼抗性（内化正外部性以构建开源网络）和抗共谋（保持网络的去中心化）。通过 DeSoc 的结构修正，DeFi 可以支持和扩展多元化的网络，这些网络可以广泛地赋予利益——正如最多样化的成员所同意的那样——而不是进一步巩固被狭隘利益集团俘获的网络。</p>
<p>然而，<strong>DeSoc 的最大优势在于其网络可组合性</strong>。持续递增的回报和网络增长不仅避免了租金提取的危险，而且还鼓励嵌套网络的扩散和交叉。一条道路可以形成两个城市之间的网络。但如果切断更广泛的合作，两个合作的城市最终将达到收益递减的上限——要么是因为拥堵（道路和住房），要么是因为疲惫（达到了他们可以服务的人群的极限）。只有通过技术创新和更广泛（如果更松散）与邻近网络合作以获得新的收益增加来源，价值才能继续呈指数级增长。一些合作将是实体的，逐步扩展跨空间的实体贸易。但更多的连接将是信息化和数字化的。随着时间的推移，我们将看到物理和数字网络之间的新合作矩阵，依赖并扩展它们所建立的社会互连。正是这种交叉、部分嵌套的跨数字和物理世界不断增长的网络合作结构正是 DeSoc 实现的。</p>
<p>通过组成网络和协调，DeSoc 出现在政治和市场的交汇处——同时增强了社会性。 DeSoc 赋予了 JCR Licklider （创造互联网的 ARPANET 的创始人）在“星际计算机网络”中“人机共生”的愿景，并在信任的基础上显着增强了社会活力。DeSoc 不是建立在 DeFi 的去信任前提之上，而是对支撑当今实体经济的信任网络进行编码，并使我们能够利用它们来生成多种网络商品，以适应捕获、提取或支配。借助这种增强的社交性，web3 可以避免短期的超金融化，转而支持跨越社交距离的无限未来增加回报。</p>
<blockquote>
<h3 id="§7-IMPLEMENTATION-CHALLENGES"><a href="#§7-IMPLEMENTATION-CHALLENGES" class="headerlink" title="§7 IMPLEMENTATION CHALLENGES"></a>§7 IMPLEMENTATION CHALLENGES</h3><p>Privacy presents a key challenge for DeSoc. On the one hand, too many public SBTs may reveal too much information about a Soul, making them vulnerable to social control. On the other hand, too many purely private SBTs may also lead to private communication channels that eschew correlation discounting for governance and social coordination—presenting important incentive compatibility questions. Closely related to the issue of privacy is the issue of cheating: Souls may misrepresent their social solidarities, while coordinating through private or side channels. We cannot aspire to know all the possibilities and answers, but instead explore the nature of the challenge here and sketch a few promising paths for future research.</p>
</blockquote>
<p>隐私对 DeSoc 来说是一个关键挑战。一方面，太多的公共 SBT 可能会泄露太多关于灵魂的信息，使他们容易受到社会控制。另一方面，过多的纯私人 SBT 也可能导致私人沟通渠道避开治理和社会协调的相关性折扣——这提出了重要的激励相容性问题。与隐私问题密切相关的是欺骗问题：灵魂可能会歪曲他们的社会团结，同时通过私人或辅助渠道进行协调。我们不能渴望知道所有的可能性和答案，而是在这里探索挑战的本质，并为未来的研究勾勒出一些有希望的路径。</p>
<blockquote>
<h4 id="7-1-Private-Souls"><a href="#7-1-Private-Souls" class="headerlink" title="7.1 Private Souls"></a>7.1 Private Souls</h4><p>Blockchain-based systems are public by default. Any relationship that is recorded on-chain is immediately visible not just to the participants, but also to anyone in the entire world. Some privacy can be retained by having multiple pseudonyms: a family Soul, a medical Soul, a professional Soul, a political Soul each carrying different SBTs. But done naively, it could be very easy to correlate these Souls to each other. The consequences of this lack of privacy are serious. Indeed, without explicit measures taken to protect privacy, the “naive” vision of simply putting all SBTs on-chain may well make too much information public for many applications. </p>
<p>To deal with over-publicity, there are a number of solutions with different levels of technical complexity and functionality. The simplest approach is that an SBT could store data on-chain.</p>
</blockquote>
<p>基于区块链的系统默认是公开的。 记录在链上的任何关系不仅对参与者，而且对全世界的任何人都是立即可见的。使用多个假名可以保留一些隐私：家庭灵魂、医疗灵魂、专业灵魂、政治灵魂，每个都携带不同的 SBT。但是如果天真地完成，很容易将这些灵魂相互关联起来。 这种缺乏隐私的后果是严重的。<strong>事实上，如果没有采取明确的措施来保护隐私，简单地将所有 SBT 上链的“幼稚”愿景很可能会使许多应用程序公开太多信息。</strong></p>
<p>为了应对过度宣传，有许多具有不同技术复杂性和功能级别的解决方案。 最简单的方法是 SBT 可以在链上存储数据。</p>
<p>![](翻译2-Decentralized Society Finding Web3 Soul/1.png)</p>
<blockquote>
<p>The choice of how to store the o￾-chain data is left to the person; possible solutions include (i) their own devices, (ii) a cloud service trusted by them, or (iii) decentralized networks such as the Interplanetary File System (IPFS). Storing data off-chain lets us continue to have smart contracts that permission the right to write SBT data, but at the same time have separate permissions to read that data. Bob can choose to reveal the contents of any of his SBTs (or the data stores which they permission) only when he wishes to. This already gets us quite far, and has the further benefit of improving technical scalability because most data only needs to be handled by a very small number of parties. But to fully achieve properties like plural privacy, as well as more fine-grained forms of disclosure, we need to go further. Fortunately, many cryptographic technologies let us do that.</p>
<p>One powerful set of building blocks that enables new ways to partially reveal data is a branch of cryptography called “zero knowledge proofs.” While zero knowledge proofs are most frequently used today to enable privacy-preserving transfers of assets, they also can allow people to prove arbitrary statements without revealing any more information beyond the statement itself. For example, in a world where government documents and other attestations are cryptographically provable, someone could prove a statement like “I am a citizen of Canada, who is over 18 years old and has a university degree in economics and over 50,000 Twitter followers, and who has not yet claimed an account in this system.”</p>
<p>Zero-knowledge proofs can be computed over SBTs to prove characteristics about a Soul (e.g., that it has certain memberships). This technique can be extended further by introducing multi-party computation techniques such as garbled circuits, which could make such tests doubly private: the prover does not reveal who they are to the verifier, and the verifier does not reveal their verification mechanism to the prover. Instead, both parties make the computation together and only learn the output.</p>
<p>Another powerful technique is designated-verifier proofs. In general, “data” is slippery: if I send a movie to you, I cannot technologically prevent you from recording and sending it to a third party. Workarounds like Digital Rights Management (DRM) have at best limited e￾ectiveness, and often come at great costs to users. Proofs, however, are not slippery in the same way. If Amma wants to prove some property X about her SBTs to Bob, she can make a zero knowledge proof of the statement “I hold SBTs that satisfy property X, OR I have the access key to Bob’s Soul.” Bob would find this statement convincing: he knows that he did not make the proof, and so Amma must actually have SBTs that satisfy property X. But if Bob passes the proof along to Cuifen, Cuifen would not be convinced: for all he knows, Bob could have made the proof with his own key. This can be made even stronger with verifiable delay functions (VDFs): Amma can make and present a proof that can only be made with the required SBTs right now, but anyone else will be able to make five minutes from now. This means it is possible to represent sophisticated access permissions to trustworthy proofs about data despite the impossibility of making the same kinds of selective permissions to the raw data itself, which may simply be copy and pasted. This may take us quite far nonetheless. Just as blockchains o￾er traceability in transactions that prevents someone from right-click copy-and-pasting a valuable NFT (and sybil attacking the original owner), similarly SBTs can o￾er traceability in social prevenance, which at minimum can reduce the value of copy-and-pasted data with unverified origins.</p>
<p>These off-chain data and zero-knowledge techniques are compatible with negative reputation—SBTs that are made visible even if the holder does not want them to be visible. Important examples of negative reputation include credit history, data about unpaid loans, negative reviews and complaints from business partners, and SBTs attesting to social connections relevant for coordination. Blockchains coupled with the same cryptography could offer a potential solution: Souls could be forced by smart contract logic to incorporate negative SBTs into a data structure like a Merkle tree that is stored off-chain, and any zero knowledge proof or garbled circuit computation would require them to introduce that information, because otherwise there would be a visible “hole” in the provided data that the verifier would recognize. The Unirep protocol is an example of how this might be implemented.</p>
<p>The point of these examples is not to show exactly how cryptographic technology can be used to solve all of the privacy and data permissioning problems with SBTs. Rather, it is to sketch out a few examples to show the power of such technologies. An important future research direction is to scope the exact limits of different kinds of data permissioning and the specific combinations of techniques that work best to achieve the desired level of permissions. Another question is what types of plural property regimes are desirable to govern data, and how to properly unbundle access (“usus”), editing (“abusus”) and cash.</p>
</blockquote>
<p>如何存储外链数据的选择由个人决定；可能的解决方案包括（i）他们自己的设备，（ii）他们信任的云服务，或（iii）去中心化网络，例如星际文件系统（IPFS）。将数据存储在链下让我们继续拥有有权写入 SBT 数据的智能合约，但同时拥有读取该数据的单独权限。Bob 可以选择仅在他愿意时透露他的任何 SBT（或他们允许的数据存储）的内容。这已经让我们走得很远，并且具有提高技术可扩展性的进一步好处，因为大多数数据只需要由极少数方处理。但要完全实现多元隐私等属性，以及更细粒度的披露形式，我们还需要更进一步。幸运的是，许多加密技术让我们能够做到这一点。</p>
<p>一组强大的构建块能够以新的方式部分揭示数据，它是密码学的一个分支，称为<strong>“零知识证明”</strong>。虽然如今零知识证明最常用于保护隐私的资产转移，但它们也可以让人们证明任意陈述，而无需透露陈述本身之外的任何更多信息。例如，在一个政府文件和其他证明可以通过密码证明的世界中，有人可以证明这样的陈述：“我是加拿大公民，年满 18 岁，拥有大学经济学学位和超过 50,000 名 Twitter 关注者，并且谁还没有在这个系统中申请账户。”零知识证明可以通过 SBT 计算来证明灵魂的特征（例如，它具有某些成员资格）。通过引入多方计算技术（例如乱码电路）可以进一步扩展该技术，这可以使此类测试具有双重私密性：证明者不会向验证者透露他们是谁，而验证者不会向证明者透露他们的验证机制。相反，双方一起进行计算，只学习输出。</p>
<p>另一种强大的技术是<strong>指定验证者证明</strong>。总的来说，“数据”是很滑的：如果我向您发送电影，我无法在技术上阻止您录制并将其发送给第三方。数字版权管理 (DRM) 之类的变通办法充其量只能起到有限的作用，而且通常会给用户带来巨大的成本。然而，证明并不是以同样的方式滑溜的。如果 Amma 想向 Bob 证明一些关于她的 SBT 的属性 X，她可以对“我持有满足属性 X 的 SBT，或者我拥有 Bob 的灵魂的访问密钥”这一陈述进行零知识证明。 Bob 会发现这个陈述令人信服：他知道他没有做出证明，因此 Amma 实际上必须有满足性质 X 的 SBT。但是如果 Bob 将证明传递给 Cuifen，Cuifen 不会被说服：据他所知， Bob 可以用他自己的密钥来证明。这可以通过可验证的延迟函数 (VDF) 变得更加强大：Amma 可以制作并展示目前只能使用所需的 SBT 制作的证明，但其他任何人都可以在五分钟后制作。这意味着尽管不可能对原始数据本身（可能只是简单地复制和粘贴）进行相同类型的选择性权限，但可以表示对有关数据的可信证明的复杂访问权限。尽管如此，这可能会让我们走得很远。正如区块链在交易中提供可追溯性以防止某人右键单击复制和粘贴有价值的 NFT（以及女巫攻击原始所有者）一样，SBT 可以在社会传播方面提供可追溯性，这至少可以减少来源未经验证的复制粘贴数据的价值。</p>
<p>这些链下数据和零知识技术与负面声誉兼容——即使持有者不希望它们可见，SBT 也会变得可见。负面声誉的重要示例包括信用记录、未付贷款数据、负面评论和业务合作伙伴的投诉，以及证明与协调相关的社会关系的 SBT。与相同密码学相结合的区块链可以提供一个潜在的解决方案：智能合约逻辑可以强制 Souls 将负 SBT 合并到数据结构中，例如存储在链外的 Merkle 树，并且任何零知识证明或乱码电路计算都需要他们介绍该信息，否则在提供的数据中会有一个可见的“漏洞”，验证者会识别出来。 Unirep 协议是如何实现这一点的一个例子。</p>
<p>这些示例的重点并不是要准确说明如何使用加密技术来解决 SBT 的所有隐私和数据许可问题。相反，它是勾勒出几个例子来展示这些技术的力量。一个重要的未来研究方向是确定不同类型数据许可的确切限制以及最适合实现所需许可级别的技术的特定组合。 另一个问题是需要什么样的多元财产制度来管理数据，以及如何正确地拆分访问（“usus”）、编辑（“abusus”）和现金。</p>
<blockquote>
<h4 id="7-2-Cheating-Souls"><a href="#7-2-Cheating-Souls" class="headerlink" title="7.2 Cheating Souls"></a>7.2 Cheating Souls</h4><p>If SBTs are the social substrate upon which plural property, network goods and intelligences are coordinated, one might be concerned that Souls will try to trick or cheat their way into communities to gain access to governance or property rights that we imagine SBTs permissioning. For example, if many applications depend on SBTs representing conference attendance, unscrupulous conferences could offer such SBTs in exchange for bribes. With enough bribes, humans (and bots) could generate a fake social graph that makes the account look like an authentic human Soul, richly ifferentiated by (fake) SBTs. Just as DAOs can be bribed, so can Souls and the on-chain voting mechanisms which they use. Conversely, if SBTs are used to discount coordination, Souls may avoid SBTs to maximize their influence. Why should we believe that the SBTs a Soul possess accurately reflect their true social commitments rather than simply how they choose to play this game?</p>
<p>One argument is that the varying incentives to cheat may “balance out.” Souls may sort and self-identify into the networks that are important to them at the right scale, much like how Harberger taxes balance out the incentive to over-value and under-value assets to elicit approximately accurate market valuations. Souls will want to hold more SBTs to gain influence within their communities, but on the other hand will eschew SBTs from communities they care less about to score lower on correlation metrics and increase their influence in governance over broader networks. </p>
<p>But it would be naive to assume that the two incentives—to gain access and maximize influence—always evenly cancel out, or even come close to canceling out, as though by magic. There may be many communities that use systems other than SBTs to gate access and governance. Or communities may—counter to our primary assumption about publicity—dole out private SBTs to reflect governance rights, but induce community members to keep these SBTs secret in broader decisions.</p>
<p>The problem of “gaming” should not be understated. It is a significant issue and resolving it is one of the most important foci for future research. Indeed, it is a major reason why open-sourcing many existing algorithms that prioritize or filter for human users is very challenging. To mitigate and deter SBT gaming, we suggest several norms and cryptographic directions:</p>
</blockquote>
<p>如果 SBT 是多种财产、网络商品和智能在其上协调的社会基础，人们可能会担心灵魂会试图欺骗或欺骗他们进入社区，以获得我们想象 SBT 允许的治理或财产权。例如，如果许多应用程序依赖于代表会议出席的 SBT，则不道德的会议可能会提供此类 SBT 以换取贿赂。有了足够的贿赂，人类（和机器人）可以生成一个虚假的社交图谱，使该帐户看起来像一个真实的人类灵魂，并被（假的）SBT 丰富地分化。就像 DAO 可以被贿赂一样，Souls 和他们使用的链上投票机制也可以。相反，如果使用 SBT 来降低协调性，Souls 可能会避免 SBT 以最大化其影响力。为什么我们应该相信灵魂拥有的 SBT 准确地反映了他们真正的社会承诺，而不仅仅是他们选择玩这个游戏的方式？</p>
<p>一个论点是，不同的作弊动机可能会“平衡”。灵魂可能会以适当的规模分类和自我识别到对他们来说很重要的网络中，就像哈伯格税收如何平衡高估和低估资产的激励，以得出大致准确的市场估值一样。 Souls 将希望持有更多的 SBT 以在其社区中获得影响力，但另一方面，他们会避开他们不太关心的社区中的 SBT，以在相关性指标上得分较低，并增加他们在更广泛网络治理中的影响力。</p>
<p>但是，如果假设这两种激励措施——获得访问权和最大化影响力——总是均匀地抵消，甚至接近于抵消，就好像施了魔法一样，那就太天真了。可能有许多社区使用 SBT 以外的系统来控制访问和治理。或者社区可能——与我们关于公开的主要假设相反——发放私人 SBT 以反映治理权利，但诱使社区成员在更广泛的决策中对这些 SBT 保密。</p>
<p>“游戏”的问题不容小觑。这是一个重要的问题，解决它是未来研究的最重要的焦点之一。事实上，这也是为什么开源许多为人类用户优先考虑或过滤的现有算法非常具有挑战性的一个主要原因。为了减轻和阻止 SBT 游戏，我们建议了几个规范和加密方向：</p>
<blockquote>
<ol>
<li>The ecosystem of SBTs could bootstrap off “thick” community channels, where SBTs signal authentic off-chain community membership with strong social bonds and repeat interactions. This would make it easier for communities to filter and revoke SBTs of impersonators and bots. Such thick channels—which we often find in churches, workplaces, schools, meet-up groups, and organizations in civil society—would provide a more sybil-resistant social substrate to police gaming (e.g., through bots, bribes, impersonation) in more “thin” social channels. </li>
<li>Nested communities could require SBTs to force context on potential collusion vectors “just below” them. For example, if a state were holding a funding round or vote, the state might require every participating citizen to also hold an SBT of a defined county and municipality.</li>
<li>The openness and cryptographic provability of the SBT ecosystem could itself be used to actively detect collusive patterns and penalize inauthentic behavior—perhaps discounting the voting power of collusive Souls, or obliging Souls to accept SBTs representing negative attestations. For example, if one Soul attests to the humanity of another Soul that turns out to be a bot, the case can be escalated and publicly verified, leading to that Soul having a large number of negative attestations. This already happens to an extent within the GitCoin QF ecosystem, where a range of signals are used to detect “collusive groups.”</li>
<li>ZK technology (eg. MACI) could cryptographically prevent some attestations made by a Soul from being provable. This would make attempts to sell certain kinds of attestations non-credible, because the briber would have no way to tell whether or not the bribe recipient followed through on their side of the deal. There has been a large body of research on the use of such techniques for voting, but ultimately any non-financialized social mechanism may end up benefiting from similar ideas.</li>
<li>We could encourage whistleblowers as a way of making collusion of significant size unstable. Instead of detecting and penalizing incorrect or abusive behavior, we detect and penalize abusive patterns of collusion. This technique is risky to overuse because of the possibility of false-flag bribes, but it is nevertheless part of the toolkit.</li>
<li>We could use mechanisms from peer-prediction theory to encourage reporting to be honest in all cases except where collusion is extremely large. Instead of the conference attesting to attendees’ attendance, attendees could attest to each other’s attendance, so the number of participants that would need to be bribed to attest to a false claim becomes very large. The rewards need not be financial, but could be SBTs, making the rewards more useful to genuine community members than they are to attackers.</li>
<li>We could use correlation scores that focus on correlations where there is a large incentive to be honest if a group of Souls share a common interest. For example, the correlation scoring technique used in bounded pairwise quadrating funding uses quadratic funding donations themselves to determine how correlated two participants are, and therefore how much to discount their intersection. If two participants share many common interests, their incentive to express this fact to the QF mechanism is certainly diminished with correlation discounting, but it never becomes zero or negative.</li>
</ol>
<p>While the range of identity frameworks proposed is almost limitless, there are four particularly prominent and adjacent paradigms widely discussed in the web3 space that merit comparison: the dominant “legacy” identity ecosystem, the pseudonymous economy, proof of personhood, and verifiable credentials. Each paradigm highlights important contributions and challenges for future development of the social identity paradigm we advocate, and we use such limitations as a springboard for exploring future directions. All that considered, we also explain why we believe our social identity primitives of Souls and soulbound tokens are a more promising path forward for privacy regimes.</p>
</blockquote>
<ol>
<li><strong>SBT 的生态系统可以引导“厚”的社区渠道，在这些渠道中，SBT 通过强大的社会纽带和重复互动表明真正的链下社区成员身份。 这将使社区更容易过滤和撤销冒充者和机器人的 SBT。</strong> 如此密集的渠道——我们经常在教堂、工作场所、学校、聚会小组和民间社会的组织中发现——将为警察博弈（例如，通过机器人、贿赂、冒充）提供更具抗女巫性的社会基础。 “瘦”社交渠道。</li>
<li><strong>嵌套社区可能需要 SBT 将上下文强加在“正下方”的潜在共谋向量上</strong>。例如，如果一个州正在举行一轮融资或投票，该州可能会要求每个参与的公民也持有一个确定的县和市的 SBT。</li>
<li>SBT 生态系统的开放性和密码学可证明性本身可用于<strong>主动检测合谋模式并惩罚不真实行为</strong>——可能会降低合谋 Souls 的投票权，或迫使 Souls 接受代表负面证明的 SBT。例如，如果一个灵魂证明另一个灵魂是机器人的人性，那么案件可以升级并公开验证，导致该灵魂有大量负面证明。这在 GitCoin QF 生态系统中已经在一定程度上发生了，其中使用一系列信号来检测“合谋团体”。</li>
<li>ZK 技术（例如 MACI）可以<strong>通过密码防止灵魂做出的某些证明是可证明的</strong>。这将使出售某些类型的证明的尝试变得不可信，因为贿赂者无法判断受贿者是否遵守了他们的交易。已经有大量关于使用这种技术进行投票的研究，但最终任何非金融化的社会机制都可能最终受益于类似的想法。</li>
<li>我们可以<strong>鼓励举报</strong>人，以此来使大规模的串通变得不稳定。我们不是检测和惩罚不正确或滥用行为，而是检测和惩罚共谋的滥用模式。由于存在虚假贿赂的可能性，这种技术有过度使用的风险，但它仍然是工具包的一部分。</li>
<li>我们可以使用来自<strong>同行预测理论的机制</strong>来鼓励在所有情况下都诚实报告，除非串通非常大。与会议证明与会者的出席不同，与会者可以证明彼此的出席，因此需要贿赂以证明虚假声明的与会者数量变得非常大。奖励不一定是金钱上的，但可以是 SBT，这使得奖励对真正的社区成员比对攻击者更有用。</li>
<li>如果一群灵魂有共同的兴趣，我们可以使用关注相关性的<strong>相关性分数</strong>。例如，有界成对二次融资中使用的相关评分技术使用二次融资捐赠本身来确定两个参与者的相关性，从而确定他们的交集的折扣程度。如果两个参与者有许多共同利益，他们向 QF 机制表达这一事实的动机肯定会随着相关性折扣而减少，但它永远不会变成零或负数。</li>
</ol>
<p>虽然提出的身份框架的范围几乎是无限的，但在 web3 空间中有四个特别突出和相邻的范式被广泛讨论，值得比较：<strong>占主导地位的“传统”身份生态系统、假名经济、人格证明和可验证的凭据</strong>。每个范式都突出了我们所倡导的社会认同范式未来发展的重要贡献和挑战，我们将这些限制作为探索未来方向的跳板。考虑到所有这些，我们还解释了为什么我们相信我们的灵魂和灵魂令牌的社会身份原语是隐私制度的一条更有希望的前进道路。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/05/13/%E7%BF%BB%E8%AF%911-Decentralized%20Society%20Finding%20Web3%20Soul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/13/%E7%BF%BB%E8%AF%911-Decentralized%20Society%20Finding%20Web3%20Soul/" class="post-title-link" itemprop="url">翻译1-Decentralized Society Finding Web3 Soul</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-05-13 13:55:00 / Modified: 18:59:54" itemprop="dateCreated datePublished" datetime="2022-05-13T13:55:00+08:00">2022-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><blockquote>
<p>Web3 today centers around expressing transferable, financialized assets, rather than encoding social<br>relationships of trust. Yet many core economic activities—such as uncollateralized lending and building personal brands—are built on persistent, non-transferable relationships. In this paper, we illustrate how non-transferable “soulbound” tokens (SBTs) representing the commitments, credentials, and affiliations of “Souls” can encode the trust networks of the real economy to establish provenance and reputation. More importantly, SBTs enable other applications of increasing ambition, such as community wallet recovery, sybil-resistant governance, mechanisms for decentralization, and novel markets with decomposable, shared rights. We call this richer, pluralistic ecosystem “Decentralized Society” (DeSoc)—a co-determined sociality, where Souls and communities come together bottom-up, as emergent properties of each other to co-create plural network goods and intelligences, at a range of scales. Key to this sociality is decomposable property rights and enhanced governance mechanisms—such as quadratic funding discounted by correlation scores—that reward trust and cooperation while protecting networks from capture, extraction, and domination. With such augmented sociality, web3 can eschew today’s hyper-financialization in favor of a more transformative, pluralist future of increasing returns across social distance.</p>
</blockquote>
<p>今天的 Web3 以表达可转让的金融化资产为中心，而不是编码信任的社会关系。然而，许多核心经济活动——例如无抵押贷款和建立个人品牌——都是建立在持久的、不可转让的关系之上的。在本文中，我们说明了代表“灵魂”的承诺、凭证和从属关系的不可转让“灵魂绑定”令牌 (SBT) 如何编码实体经济的信任网络以建立出处和声誉。更重要的是，SBT 支持其他雄心勃勃的应用，例如社区钱包恢复、抗女巫治理、去中心化机制以及具有可分解、共享权利的新市场。我们将这个更丰富、多元化的生态系统称为“去中心化社会”（DeSoc）——一种共同决定的社会性，灵魂和社区自下而上地聚集在一起，作为彼此的新兴属性，在一定范围内共同创造多元化的网络商品和智能的规模。这种社会性的关键是可分解的产权和增强的治理机制——例如相关分数打折的二次融资——奖励信任和合作，同时保护网络不被捕获、提取和支配。借助这种增强的社交性，web3 可以避开当今的超金融化，转而支持更具变革性、多元化的未来，即跨社会距离增加回报。</p>
<blockquote>
<h3 id="§1-INTRODUCTION"><a href="#§1-INTRODUCTION" class="headerlink" title="§1 INTRODUCTION"></a>§1 INTRODUCTION</h3><p>Web3 has stunned the world by forging a parallel system of finance of unprecedented flexibility and<br>creativity in less than a decade. Cryptographic and economic primitives such as public key cryptography, smart contracts, proof of work, and proof of stake have led to a sophisticated and open ecosystem for expressing financial transactions.</p>
<p>Yet the economic value finance trades on is generated by humans and their relationships. Because<br>web3 lacks primitives to represent such social identity, it has become fundamentally dependent on the very centralized web2 structures it aims to transcend, replicating their limitations.<br>Examples of these dependencies include:</p>
<ol>
<li><p>Most NFT artists rely on centralized platforms like OpenSea and Twitter to commit to<br> scarcity and initial provenance.</p>
</li>
<li><p>DAOs that try to move beyond simple coin-voting often rely on web2 infrastructure, such<br> as social media pro￾les, for sybil resistance.</p>
</li>
<li><p>Many web3 participants rely on custodial wallets managed by centralized entities like<br> Coinbase or Binance. Decentralized key management systems are not user-friendly for any<br> but the most sophisticated.</p>
</li>
</ol>
<p>Furthermore, the lack a native web3 identity makes today’s DeFi ecosystem unable to support  activities ubiquitous in the real economy, such as undercollateralized lending or simple contracts, like an  apartment lease. In this paper, we illustrate how even small and incremental steps towards representing  social identity with soulbound tokens could overcome these limitations and bring the ecosystem far closer to  regenerating markets with their underpinning human relationships in a native web3 context.</p>
<p>Even more promising, we highlight how native web3 social identity, with rich social composability, could yield great progress on broader long-standing problems in web3 around wealth concentration and vulnerability of governance to financial attacks, while spurring a Cambrian explosion of innovative political, economic, and social applications. We refer to these use cases and the richer pluralistic ecosystem that they enable as “Decentralized Society” (DeSoc).</p>
</blockquote>
<p>Web3 在不到十年的时间里打造了一个具有前所未有的灵活性和创造力的平行金融系统，震惊了世界。密码学和经济原语，例如公钥密码学、智能合约、工作量证明和权益证明，已经形成了一个用于表达金融交易的复杂而开放的生态系统。<br>然而，金融交易的经济价值是由人类及其关系产生的。因为 web3 缺乏代表这种社会身份的原语，它已经从根本上依赖于它旨在超越的非常集中的 web2 结构，复制它们的局限性。<br>这些依赖项的示例包括：</p>
<ol>
<li><p>大多数 NFT 艺术家依靠 OpenSea 和 Twitter 等中心化平台来承诺稀缺性和初始出处。</p>
</li>
<li><p>试图超越简单的硬币投票的 DAO 通常依赖于 web2 基础设施，例如社交媒体配置文件，以抵抗女巫。</p>
</li>
<li><p>许多 web3 参与者依赖于由 Coinbase 或 Binance 等中心化实体管理的托管钱包。去中心化的密钥管理系统除了最复杂的人外，对任何人都不友好。</p>
</li>
</ol>
<p>此外，缺乏原生的 web3 身份使得今天的 DeFi 生态系统无法支持实体经济中无处不在的活动，例如抵押不足的贷款或简单的合同，例如公寓租赁。在本文中，我们说明了即使是用灵魂绑定的代币表示社会身份的微小和渐进的步骤也可以克服这些限制，并使生态系统更接近于在原生 web3 环境中以人际关系为基础的再生市场。</p>
<p>更有希望的是，我们强调了具有丰富社会可组合性的原生 web3 社会身份如何在 web3 中围绕财富集中和治理易受金融攻击的更广泛长期存在的问题上取得巨大进展，同时刺激寒武纪的创新政治、经济爆炸和社交应用。我们将这些用例和它们所支持的更丰富的多元化生态系统称为“去中心化社会”（DeSoc）。</p>
<blockquote>
<h3 id="§2-OUTLINE"><a href="#§2-OUTLINE" class="headerlink" title="§2 OUTLINE"></a>§2 OUTLINE</h3><p>We begin by explaining the primitives of DeSoc, centered around accounts (or wallets) holding non-transferable (initially public) “soulbound” tokens (SBTs) representing commitments, credentials, and affiliations. Such tokens would be like an extended resume, issued by other wallets that attest to these social relations.</p>
<p>We then describe a “stairway” of increasingly ambitious applications across the social stack such primitives could empower, including:</p>
<ul>
<li><p>establishing provenance</p>
</li>
<li><p>unlocking undercollateralized lending markets through reputation</p>
</li>
<li><p>enabling decentralized key management</p>
</li>
<li><p>thwarting and compensating for coordinated strategic behavior</p>
</li>
<li><p>measuring decentralization</p>
</li>
<li><p>creating novel markets with decomposable, shared rights and permissions</p>
</li>
</ul>
<p>This description culminates with a vision of DeSoc—a co-determined sociality, where Souls and communities come together bottom-up, as emergent properties of each other to co-create plural network goods, including plural intelligences, at a range of social scales.</p>
<p>Finally, we answer several potential concerns and objections, and make comparisons to other identity paradigms familiar in the web3 space, conceding often how our vision is just a first step but nonetheless an advance in programmable privacy and communication. Then, we consider technical pathways to bootstrap the vision we imagine. Building off these, we look forward, more philosophically, to the potential of DeSoc to redirect web3 to a more profound, legitimate, and transformative path.</p>
</blockquote>
<p>我们首先解释 DeSoc 的原语，以持有代表承诺、凭证和隶属关系的不可转让（最初是公开的）“灵魂绑定”代币 (SBT) 为中心的账户（或钱包）。这样的代币就像一份扩展的简历，由证明这些社会关系的其他钱包发行。</p>
<p>然后，我们描述了跨社交堆栈的越来越雄心勃勃的应用程序的“阶梯”，这些原语可以赋予权力，包括：</p>
<ul>
<li><p>确定出处</p>
</li>
<li><p>通过声誉打开抵押不足的贷款市场</p>
</li>
<li><p>实现分散的密钥管理</p>
</li>
<li><p>阻挠和补偿协调的战略行为</p>
</li>
<li><p>衡量权力下放</p>
</li>
<li><p>创建具有可分解、共享权利和许可的新市场</p>
</li>
</ul>
<p>这种描述以 DeSoc 的愿景达到高潮——一种共同决定的社会性，灵魂和社区自下而上地聚集在一起，作为彼此的新兴属性，在一系列社会尺度上共同创造包括多元智能在内的多元网络商品。<br>最后，我们回答了几个潜在的担忧和反对意见，并与 web3 空间中熟悉的其他身份范式进行了比较，经常承认我们的愿景只是第一步，但却是可编程隐私和通信方面的进步。然后，我们考虑引导我们想象的愿景的技术途径。在这些基础上，我们从更哲学的角度期待 DeSoc 将 web3 重定向到更深刻、更合法和更具变革性的道路的潜力。</p>
<blockquote>
<h3 id="§3-SOULS"><a href="#§3-SOULS" class="headerlink" title="§3 SOULS"></a>§3 SOULS</h3><p>Our key primitive is accounts, or wallets, that hold publicly visible, non-transferable (but possibly revocable-by-the-issuer) tokens. We refer to the accounts as “Souls” and tokens held by the accounts as “Soulbound Tokens” (SBTs). We initially assume publicity despite our deep interest in privacy because it is technically simpler to validate as a proof-of-concept, even if limited by the subset of tokens people are willing to publicly share. Later in the paper, we introduce the concept of “programmable privacy” for richer use cases.</p>
<p>Imagine a world where most participants have Souls that store SBTs corresponding to a series of affiliations, memberships, and credentials. For example, a person might have a Soul that stores SBTs representing educational credentials, employment history, or hashes of their writings or works of art. In their simplest form, these SBTs can be “self-certified,” similar to how we share information about ourselves in our CVs. But the true power of this mechanism emerges when SBTs held by one Soul can be issued—or attested—by other Souls, who are counterparties to these relationships. These counterparty Souls could be individuals, companies, or institutions. For example, the Ethereum Foundation could be a Soul that issues SBTs to Souls who attended a developer conference. A university could be a Soul that issues SBTs to graduates. A stadium could be a Soul that issues SBTs to longtime Dodgers fans.</p>
<p>Note there is no requirement for a Soul to be linked to a legal name, or for there to be any protocol-level attempt to ensure “one Soul per human.” A Soul could be a persistent pseudonym with a range of SBTs that cannot easily be linked. We also do not assume non-transferability of Souls across humans. Instead, we try to illustrate how these properties, where needed, can naturally emerge from the design itself.</p>
</blockquote>
<p><strong>我们的关键原语是持有公开可见、不可转让（但可能由发行人撤销）代币的账户或钱包。我们将账户称为“灵魂”，将账户持有的代币称为“灵魂绑定代币”（SBT）。</strong>尽管我们对隐私有着浓厚的兴趣，但我们最初假设是公开的，因为它在技术上更容易验证为概念验证，即使受到人们愿意公开分享的代币子集的限制。在本文的后面，我们为更丰富的用例引入了“可编程隐私”的概念。<br>想象一个世界，其中大多数参与者都拥有存储与一系列从属关系、会员资格和证书相对应的 SBT 的灵魂。例如，一个人可能有一个灵魂，它存储代表教育证书、工作经历或他们的著作或艺术作品的哈希值的 SBT。在最简单的形式中，这些 SBT 可以“自我认证”，类似于我们在简历中分享关于自己的信息的方式。但是，当一个灵魂持有的 SBT 可以由作为这些关系的对手的其他灵魂发行或证明时，这种机制的真正力量就会显现出来。这些对手灵魂可能是个人、公司或机构。例如，以太坊基金会可以是一个灵魂，它向参加开发者大会的灵魂发放 SBT。大学可以是向毕业生发放 SBT 的灵魂。体育场可能是向道奇队的长期球迷发放 SBT 的灵魂。<br>请注意，灵魂不需要与合法名称相关联，也不需要任何协议级别的尝试来确保“每个人一个灵魂”。灵魂可能是一个持久的化名，具有一系列无法轻易链接的 SBT。我们也不假设灵魂在人类之间的不可转移性。相反，我们试图说明这些属性如何在需要时自然地从设计本身中出现。</p>
<blockquote>
<h3 id="§4-STAIRWAY-TO-DESOC"><a href="#§4-STAIRWAY-TO-DESOC" class="headerlink" title="§4 STAIRWAY TO DESOC"></a>§4 STAIRWAY TO DESOC</h3><h4 id="4-1-Art-amp-Soul"><a href="#4-1-Art-amp-Soul" class="headerlink" title="4.1 Art &amp; Soul"></a>4.1 Art &amp; Soul</h4><h4 id="4-2-Soul-Lending"><a href="#4-2-Soul-Lending" class="headerlink" title="4.2 Soul Lending"></a>4.2 Soul Lending</h4><p>Perhaps the largest financial value built directly on reputation is credit and uncollateralized lending. Currently, the web3 ecosystem cannot replicate simple forms of uncollateralized lending, because all assets are transferable and saleable—thus simply forms of collateral. The “traditional” financial ecosystem supports many forms of uncollateralized lending, but relies on centralized credit scores to gauge creditworthiness of borrowers who have little incentive to share information about their credit history. But such scores have many flaws. At best, they opaquely overweight and underweight factors relevant to creditworthiness, and bias those who haven’t accumulated su￾cient data—mainly minorities and the poor. At worst, they can enable Black Mirror opaque “social credit” systems that engineer social outcomes and reinforce discriminations.</p>
<p><strong>An ecosystem of SBTs could unlock a censorship-resistant, bottom-up alternative to top-down commercial and “social” credit systems.</strong> SBTs that represent education credentials, work history, and rental contracts could serve as a persistent record of credit-relevant history, allowing Souls to stake meaningful reputation to avoid collateral requirements and secure a loan. Loans and credit lines could be represented as non-transferable but revocable SBTs, so they are nested amongst a Soul’s other SBTs—a kind of non-sizable reputational collateral—until they are repaid and subsequently burned, or better yet, replaced with proof of repayment. SBTs offer useful security properties: non-transferability prevents transferring or hiding outstanding loans, while a rich ecosystem of SBTs ensures that borrowers who try to escape their loans (perhaps by spinning up a fresh Soul) will lack SBTs to meaningfully stake their reputation. </p>
<p>The ease of computing public liabilities with SBTs would open-source lending markets. New correlations between SBTs and repayment risk would emerge, birthing better lending algorithms that predict creditworthiness and thereby reduce the role of centralized, opaque credit-scoring infrastructure. Better yet, lending would likely occur within social connections. In particular, SBTs would offer a substrate for community lending practices similar to those pioneered by Muhammad Yunus and the Grameen Bank, where members of a social network agree to support one another’s liabilities. Because a Soul’s constellation of SBTs represents memberships across social groups, participants could easily discover other Souls who would be valuable co-participants in a group lending project. Whereas commercial lending is a “lend-it-and-forget-it” until repayment model, community lending might take a “lend-it-and-help-it” approach—combining working capital with human capital with greater rates of return.</p>
<p>How does uncollateralized community lending get o￾ the ground? At the start, we expect Souls to carry only SBTs that reflect information they are comfortable with sharing publicly, such as information in a CV. While limited in scope, it might be a level of resolution sufficient for intra-community lending<br>experiments to take off, especially if the SBTs are issued by reputable institutions. For example, a constellation of SBTs that show certain programming credentials, participation in several conferences, and work history might be sufficient for a Soul to take a loan (or raise seed capital) for their venture. Such credentials and social relationships already informally play an important, but opaque role in capital allocation like venture capital.</p>
</blockquote>
<p>直接建立在声誉之上的最大财务价值也许是信贷和无抵押贷款。目前，web3 生态系统无法复制简单形式的无抵押借贷，因为所有资产都是可转让和可销售的——因此只是抵押形式。“传统”金融生态系统支持多种形式的无抵押贷款，但依赖于集中的信用评分来衡量借款人的信用度，这些借款人几乎没有动力分享有关其信用历史的信息。但这样的分数有很多缺陷。充其量，他们不透明地高估和低估与信用相关的因素，并偏向那些没有积累足够数据的人——主要是少数族裔和穷人。在最坏的情况下，他们可以启用黑镜不透明的“社会信用”系统，从而设计社会成果并加强歧视。</p>
<p><strong>SBT 的生态系统可以解锁自上而下的商业和“社会”信用系统的抗审查、自下而上的替代方案。</strong>代表教育证书、工作经历和租赁合同的 SBT 可以作为持续记录与信用相关的历史记录，允许灵魂获得有意义的声誉，以避免抵押要求并获得贷款。贷款和信贷额度可以表示为不可转让但可撤销的 SBT，因此它们嵌套在灵魂的其他 SBT 中——一种规模不大的声誉抵押品——直到它们被偿还并随后被烧毁，或者更好的是，被证明取代还款。SBT 提供了有用的安全属性：不可转让性可防止转移或隐藏未偿还的贷款，而丰富的 SBT 生态系统可确保试图逃避贷款（可能通过旋转新的灵魂）的借款人将缺乏 SBT 来有意义地抵押他们的声誉。</p>
<p>使用 SBT 计算公共负债的便利性将开源贷款市场。SBT 与还款风险之间将出现新的相关性，从而产生更好的贷款算法来预测信用，从而减少集中、不透明的信用评分基础设施的作用。更好的是，借贷很可能发生在社会关系中。特别是，SBT 将为类似于穆罕默德尤努斯和格莱珉银行开创的社区借贷实践提供基础，其中社交网络的成员同意支持彼此的债务。因为一个灵魂的 SBT 星座代表了跨社会群体的成员资格，所以参与者可以很容易地发现其他灵魂，他们将是一个团体借贷项目的有价值的共同参与者。商业贷款是一种“先贷后忘”直至还款的模式，而社区贷款可能会采取“先贷后助”的方式——将营运资本与人力资本结合起来，从而获得更高的回报率。</p>
<p>无抵押社区贷款是如何落地的？一开始，我们希望 Souls 只携带反映他们愿意公开分享的信息的 SBT，例如简历中的信息。虽然范围有限，但它可能足以让社区内借贷实验起飞，特别是如果 SBT 是由信誉良好的机构发行的。例如，显示某些编程证书、参加多个会议和工作经历的 SBT 星座可能足以让灵魂为他们的企业贷款（或筹集种子资金）。这种资历和社会关系已经非正式地在风险投资等资本配置中发挥了重要但不透明的作用。</p>
<blockquote>
<h4 id="4-4-Souldrops"><a href="#4-4-Souldrops" class="headerlink" title="4.4 Souldrops"></a>4.4 Souldrops</h4><p>So far we have explained how Souls can come to represent individuals and re￾ect their unique traits and solidarities as they acquire SBTs that reflect their affiliations, memberships, and credentials. Such individuation helps Souls build reputations, establish provenance, access uncollateralized lending markets, and protect reputation and identity. But the converse is also true; SBTs also enable communities to be convened at unique intersections of Souls. Thus far web3 has largely relied on token sales or airdrops to summon new communities, which yield little accuracy or precision. Airdrops, in which tokens are algorithmically given for free to a set of wallets, mostly fall to some combination of existing token holders and wallets—easily attacked by sybils, encouraging strategic behavior and the Matthew effect. SBTs offer a radical improvement we call “souldrops.”</p>
<p>“Souldrops” are airdrops based on computations over SBTs and other tokens within a Soul. For example, a DAO that wants to convene a community within a particular layer 1 protocol could souldrop to developers who hold 3 out of the last 5 conference attendance SBTs, or other tokens reflecting attendance like POAPs. Protocols could also programmatically weight token drops across a combination of SBTs. We can imagine a non-profit whose mission is to plant trees dropping governance tokens to Souls who hold a mix of environmental action SBTs, gardening SBTs, and carbon sequestration tokens—perhaps dropping more tokens to the carbon sequestration token-holders.</p>
<p>Souldrops could also introduce novel incentives to encourage community engagement. Dropped SBTs could be engineered to be soulbound for a period but eventually “vest” into transferable tokens over time. Or the reverse could be true. Transferable tokens held for some period could unlock the right to SBTs that confer further governance rights over a protocol. SBTs open a rich possibility space to experiment with mechanisms that maximize community engagement and other goals, like decentralization, which we discuss further below.</p>
</blockquote>
<p>到目前为止，我们已经解释了灵魂如何能够代表个人并在他们获得反映他们的隶属关系、成员资格和证书的 SBT 时反映他们的独特特征和团结。这种个性化有助于 Souls 建立声誉、确定出处、进入无抵押贷款市场并保护声誉和身份。但反过来也是如此； SBT 还使社区能够在灵魂的独特交汇处召集。到目前为止，web3 主要依靠代币销售或空投来召唤新社区，这几乎没有准确性或精确度。空投，其中代币通过算法免费提供给一组钱包，主要属于现有代币持有者和钱包的某种组合——很容易被女巫攻击，鼓励战略行为和马太效应。 SBT 提供了一种彻底的改进，我们称之为“灵魂点”。</p>
<p>“Souldrops”是基于灵魂内 SBT 和其他代币计算的空投。例如，想要在特定的第 1 层协议中召集社区的 DAO 可以向持有最近 5 次会议出席 SBT 中的 3 次的开发人员或其他反映出席情况的代币（如 POAP）的开发人员投降。协议还可以在 SBT 组合中以编程方式加权令牌下降。我们可以想象一个非营利组织，其使命是植树，将治理代币投放给持有环境行动 SBT、园艺 SBT 和碳封存代币的灵魂——也许向碳封存代币持有者投放更多代币。</p>
<p>Souldrops 还可以引入新的激励措施来鼓励社区参与。丢弃的 SBT 可以设计为在一段时间内受到灵魂约束，但最终随着时间的推移“归属”为可转让的代币。或者反过来可能是正确的。持有一段时间的可转让代币可以解锁 SBT 的权利，从而赋予协议进一步的治理权。 SBT 为尝试最大化社区参与和其他目标（如权力下放）的机制提供了丰富的可能性空间，我们将在下面进一步讨论。</p>
<blockquote>
<h4 id="4-5-The-DAO-of-Souls"><a href="#4-5-The-DAO-of-Souls" class="headerlink" title="4.5 The DAO of Souls"></a>4.5 The DAO of Souls</h4><p>Distributed autonomous organizations (DAOs) are virtual communities that come together around a common purpose, coordinated by voting through smart contracts on a public blockchain. While DAOs offer great potential for coordination of global communities across distance and difference, they are vulnerable to sybil attacks where a single user can have multiple wallets to accrue voting power—or in less sophisticated one-token-one-vote style governance, simply hoard tokens to accrue 51% voting power and dispossess the other 49%.</p>
<p>DAOs could mitigate sybil attacks with SBTs in several ways, by:</p>
<ul>
<li>computing over a Soul’s constellation of SBTs to differentiate between unique Souls and probable bots, and denying any voting power to a Soul that appears to be a Sybil.</li>
<li>conferring more voting power to Souls who hold more reputable SBTs—like work or educational credentials, licenses, or certifications.</li>
<li>issuing specialized “proof-of-personhood” SBTs, which could help other DAOs bootstrap sybil resistance.</li>
<li>checking for correlations between SBTs held by Souls who support a particular vote, and applying a lower vote weight to voters who are highly correlated.</li>
</ul>
<p>The latter idea of correlation checking is particularly promising and novel. A vote supported by many Souls who all share the same SBT(s) is more likely to be a Sybil attack and—even if not a Sybil attack—such a vote is more likely to be a group of Souls who are making the same error in judgment or who share the same bias, and so should reasonably be weighted less than a vote with the same numerical level of support but from a more diverse base of participants.</p>
<p>We explore the latter idea mathematically in greater detail in the context of quadratic funding in the Appendix, where we introduce a new primitive, called the “correlation score.” This concept of correlation discounting could be extended to structure deliberative conversations. For example, DAOs susceptible to majoritarian capture could compute over SBTs to bring maximally diverse members together in conversation and ensure minority voices are heard.</p>
<p>DAOs could also rely on SBTs to deter forms of strategic behavior such as “vampire attacks.” In such attacks, a DAO—typically with an associated DeFi protocol of economic value—free-rides off the R&amp;D of another by copying their open-source code and subsequently luring users’ liquidity with a token. DAOs could deter free-riders by first creating a norm around souldropping (perhaps vesting SBTs) only to probable sybil-resistant Souls who delivered liquidity and then withholding souldrops to Souls who shifted their liquidity in a vampire attack. The same mechanism wouldn’t work with airdrops to wallets because a holder can spread liquidity across many wallets to obfuscate their liquidity trail.</p>
<p>DAOs could also use SBTs to make leadership and governance programmatically responsive to their communities. Leadership roles could dynamically shift as the composition of the community shifts—as reflected in the changing distribution of SBTs across member Souls. A subset of members could be elevated to potential officer roles based on their intersectionality and coverage across multiple communities within the DAO. Protocols that value community cohesion could use SBTs to keep intersectional Souls at the center. Alternatively, DAOs may opt for governance that elevates certain combinations of traits more than others, such as diversity among zip codes or participation among a subset of special hobby DAOs.</p>
</blockquote>
<p>分布式自治组织 (DAO) 是围绕一个共同目的聚集在一起的虚拟社区，通过公共区块链上的智能合约投票进行协调。虽然 DAO 为跨距离和差异的全球社区协调提供了巨大的潜力，但它们很容易受到女巫攻击，其中单个用户可以拥有多个钱包来积累投票权——或者在不太复杂的单代币一票式治理中，简单地囤积代币累积 51% 的投票权并剥夺其他 49% 的投票权。</p>
<p>DAO 可以通过以下几种方式减轻 SBT 的女巫攻击：</p>
<ul>
<li>计算灵魂的 SBT 星座以区分独特的灵魂和可能的机器人，并拒绝对看似女巫的灵魂有任何投票权。</li>
<li>将更多的投票权授予持有更有信誉的 SBT（如工作或教育证书、执照或证书）的灵魂。</li>
<li>发布专门的“人格证明”SBT，这可以帮助其他 DAO 引导女巫抵抗。</li>
<li>检查支持特定投票的灵魂持有的 SBT 之间的相关性，并对高度相关的选民应用较低的投票权重。</li>
</ul>
<p>后一种相关性检查的想法特别有前途和新颖。由共享相同 SBT 的许多灵魂支持的投票更有可能是女巫攻击，即使不是女巫攻击，这样的投票也更有可能是一群犯同样错误的灵魂在判断或谁有相同的偏见，因此应该合理地加权低于具有相同数量支持但来自更多样化的参与者基础的投票。</p>
<p>我们在附录中的二次融资的背景下更详细地探讨了后一种想法，我们在其中引入了一个新的原语，称为“相关分数”。这种相关折扣的概念可以扩展到构建审议对话。例如，容易被多数派俘虏的 DAO 可以通过 SBT 进行计算，以将最大程度不同的成员聚集在一起进行对话，并确保听到少数派的声音。</p>
<p>DAO 还可以依靠 SBT 来阻止各种形式的战略行为，例如“吸血鬼攻击”。在此类攻击中，DAO（通常具有相关的具有经济价值的 DeFi 协议）通过复制其开源代码并随后用代币吸引用户的流动性来搭便车。 DAO 可以阻止搭便车者，首先围绕灵魂投掷（可能授予 SBT）创建一个规范，仅针对提供流动性的可能的抗女巫灵魂，然后将灵魂投递给在吸血鬼攻击中转移流动性的灵魂。同样的机制不适用于空投到钱包，因为持有人可以将流动性分散到许多钱包中以混淆他们的流动性轨迹。</p>
<p>DAO 还可以使用 SBT 以编程方式响应其社区的领导和治理。领导角色可以随着社区组成的变化而动态变化——这反映在 SBT 在成员灵魂中的分布变化中。根据 DAO 内多个社区的交叉性和覆盖范围，可以将一部分成员提升为潜在的官员角色。重视社区凝聚力的协议可以使用 SBT 将交叉灵魂保持在中心。或者，DAO 可能会选择比其他更提升某些特征组合的治理，例如邮政编码之间的多样性或特殊爱好 DAO 子集的参与。</p>
<blockquote>
<h4 id="4-6-Measuring-Decentralization-through-Pluralism"><a href="#4-6-Measuring-Decentralization-through-Pluralism" class="headerlink" title="4.6 Measuring Decentralization through Pluralism"></a>4.6 Measuring Decentralization through Pluralism</h4><h4 id="Measuring-Decentralization-through-Pluralism"><a href="#Measuring-Decentralization-through-Pluralism" class="headerlink" title="Measuring Decentralization through Pluralism"></a>Measuring Decentralization through Pluralism</h4><p>When analyzing real-world ecosystems, it is desirable to measure how decentralized the ecosystem actually is. To what extent is the ecosystem truly decentralized, and to what extent is the decentralization “fake” and the ecosystem de-facto dominated by one or a small set of coordinating entities?</p>
<p>Two popular decentralization metrics are the Nakamoto coefficient proposed by Balaji Srinivasan, which measures how many distinct entities need to be combined to gather 51% of some resource, and the Herfindahl-Hirschman index used to measure market concentration for antitrust purposes, calculated by summing the squares of the market shares of the market participants. These approaches, however, leave open key questions of what are the correct resources to measure, how to deal with partial coordination, and the gray areas in what constitutes a “distinct entity.”</p>
<p>For example, nominally independent firms may have many major shareholders in common, have directors who are friends with each other, or be regulated by the same government. In the context of token protocols, measuring decentralization of token holdings by looking at on-chain wallets is wildly inaccurate because many people have multiple wallets, and some wallets (e.g., exchanges) represent many people. Moreover, even if addresses could be traced back to unique individuals, those individuals could be socially correlated groups prone to accidental coordination (at best) or intentional collusion (at worst). A better way of measuring decentralization would capture social dependencies, weak affiliations, and strong solidarities.</p>
<p>SBTs support a different way of measuring the level of decentralization (or pluralism) in a DAO, protocol, or network.</p>
<ul>
<li><p>As a first step, protocol could limit token voting to reasonably sybil-resistant (or SBT rich) Souls.</p>
</li>
<li><p>As a second step, a protocol could examine the correlations between SBTs held by different Souls and discount votes by Souls (pooling them as only partially separate) if they share a large number of SBTs. (We explore the latter idea mathematically in greater detail in the context of quadratic funding in Appendix A, where we introduce a new primitive, called the “correlation score.”)</p>
</li>
<li><p>As a third step, to zoom out and get a sense of the decentralization across the network, one could measure the correlations between SBTs held by Souls among and across different layers of the network stack—measuring correlations in voting, token ownership, governance-related communication, and even control over computational resources. </p>
</li>
</ul>
<p>SBTs allow us to begin to measure the decentralization of an interoperating and layered ecosystem that is very di￾cult to measure at all today. There is still a large, open question of what formulas would best capture what we want to measure and be least vulnerable to manipulation. There are also many questions about how to examine the relationships of SBTs—weighting some SBTs more than others, discounting nested SBTs, or also factoring in the composition of transferable tokens within Souls. However, with a rich ecosystem of Souls and SBTs, a much larger amount of data would be available to make these calculations and move towards meaningful decentralization.</p>
</blockquote>
<h4 id="通过多元化衡量去中心化"><a href="#通过多元化衡量去中心化" class="headerlink" title="通过多元化衡量去中心化"></a>通过多元化衡量去中心化</h4><p>在分析现实世界的生态系统时，需要衡量生态系统的去中心化程度。生态系统在多大程度上真正去中心化，去中心化在多大程度上是“假的”，生态系统事实上由一个或一小部分协调实体主导？</p>
<p>两个流行的去中心化指标是 Balaji Srinivasan 提出的 Nakamoto 系数，它衡量需要合并多少不同的实体才能收集 51% 的资源，以及用于衡量反垄断目的的市场集中度的 Herfindahl-Hirschman 指数，通过将市场参与者的市场份额的平方。然而，这些方法留下的关键问题是什么是要衡量的正确资源、如何处理部分协调以及构成”不同实体”的灰色区域。</p>
<p>例如，名义上独立的公司可能有许多共同的大股东，有彼此是朋友的董事，或者受同一政府监管。在代币协议的背景下，通过查看链上钱包来衡量代币持有量的去中心化是非常不准确的，因为很多人有多个钱包，而一些钱包（例如交易所）代表了很多人。此外，即使地址可以追溯到独特的个人，这些个人也可能是容易发生意外协调（最好的情况）或故意勾结（最坏的情况）的社会相关群体。衡量权力下放的更好方法是捕捉社会依赖、弱联系和强大的团结。</p>
<p>SBT 支持一种不同的方式来衡量 DAO、协议或网络中的去中心化（或多元化）水平。</p>
<ul>
<li><p>作为第一步，协议可以将代币投票限制为合理抗女巫（或富含 SBT）的灵魂。</p>
</li>
<li><p>作为第二步，如果不同灵魂拥有大量 SBT，协议可以检查不同灵魂持有的 SBT 与灵魂的折扣投票之间的相关性（将它们作为仅部分分开的池）。（我们在附录 A 的二次融资背景下更详细地探讨了后一个想法，我们在其中引入了一个新的原语，称为“相关分数”。）</p>
</li>
<li><p>作为第三步，为了缩小并了解整个网络的去中心化，可以测量 Souls 持有的 SBT 在网络堆栈的不同层之间和跨层之间的相关性——测量投票、代币所有权、治理方面的相关性——相关的通信，甚至对计算资源的控制。</p>
</li>
</ul>
<p>SBT 使我们能够开始衡量当今很难衡量的互操作和分层生态系统的去中心化程度。关于哪些公式最能捕捉我们想要测量的内容并且最不容易受到操纵，仍然存在一个很大的悬而未决的问题。还有很多关于如何检查 SBT 的关系的问题——对某些 SBT 的权重比其他的更高，对嵌套的 SBT 进行折扣，或者还考虑到 Souls 中可转让代币的组成。然而，随着 Souls 和 SBT 的丰富生态系统，大量数据可用于进行这些计算并朝着有意义的去中心化方向发展。</p>
<blockquote>
<h4 id="4-7-Plural-Property"><a href="#4-7-Plural-Property" class="headerlink" title="4.7 Plural Property"></a>4.7 Plural Property</h4><p>DAOs often own—or organize around owning—assets, both in the virtual and physical worlds. So<br>far web3’s scope has largely been limited to a narrow class of property whose bundle of rights are wholly transferable: tokens, NFTs, artworks, first editions or rare manuscripts like the U.S. Constitution. But the emphasis on transferability has been to web3’s detriment, making it incapable of representing and supporting some of the simplest and ubiquitous property contracts today, such as apartment leases. Property rights are defined in the Roman legal tradition as bundles of rights to use (“usus”), consume or destroy (“abusus”), and profit (“fructus”). Rarely are all these rights jointly vested in the same owner. Apartment leases, for example, confer limited rights of use (“usus”) to the lessor, but not unfettered rights to destroy the apartment (“abusus”), sell it off (“fructus”), or even transfer use (subletting). Rights of real property (land) are typically encumbered by a range of restrictions on private use, grants of public rights of access, limits on rights of sale, and even rights of purchase by eminent domain. They are also typically encumbered with mortgages that transfer some financial value to lenders.</p>
<p>The future of property innovation is unlikely to build on wholly transferable private property so far<br>imagined web3. Rather <strong>innovation will hinge on the ability to decompose property rights to match features of existing property regimes, and code even richer elaborations.</strong> Corporations and other<br>organizational forms evolved precisely to reconfigure property rights in even more creative ways—for<br>example, granting employees access to proprietary facilities (“usus”), but reserving for managers rights to change or damage assets (“abusus”), while paying shareholders most financial benefit (“fructus”). SBTs have the flexibility to represent and proliferate such nuanced property rights of both physical and virtual assets, while encouraging new experiments. Here are just a few use cases:</p>
<ul>
<li>Permissioning access to privately or publicly controlled resources (e.g., homes, cars, museums, parks, and virtual equivalents). Transferable NFTs fail to capture this use case well because often access rights are conditional and non-transferable: if I trust you to enter my backyard and use it as recreational space, that does not imply that I trust you to sub-license that permission to someone else.</li>
<li>Data Cooperatives where SBTs grant data access to researchers, while instantiating members’ rights to grant access (perhaps by quadratic vote) and bargain for economic rights to discoveries and intellectual property born out of research. We explore this further in Section 4 on Plural Sensemaking.</li>
<li>Experiments with local currencies with rules that make them more valuable to hold and spend by Souls who live in a particular region or are part of a particular community.</li>
<li>Experiments in participation where SBTs create a continuous basis for less contextualized Souls (e.g., immigrants, adolescents) to gain influence within novel and broader networks. Such Souls would begin with narrow SBTs that pool them with their families or local communities. As their affiliations gradually diversify, they would gain broader SBTs that instantiate voting rights to influence  broader networks—in the spirit of Danielle Allen’s idea of polypolitanism—a process that currently is mediated by arbitrary age and residence cut-offs.</li>
<li>Experiments in market design, such as Harberger taxation and SALSA (self-assessed licenses sold at auction), where holders of an asset post a self-assessed price at which anyone else can buy the asset from them, and must periodically pay a tax proportional to the self-assessed price to maintain control. SBTs could be used to create more nuanced versions of SALSA—for example, where rights of participation are approved by the community to minimize strategic behavior from within or outside the community.</li>
<li>Experiments in democratic mechanism design such as quadratic voting. Holders of SBTs representing membership in a community could quadratically vote on parameters such as incentives and tax rates. Ultimately, “markets” and “politics” are not separate design spaces; SBTs can be a major part of a technological stack that enables the entire space between the two categories to be explored. Provision of public goods through quadratic funding is another such intersection.</li>
</ul>
<p>Of course, there are dystopian scenarios to consider. Immigration systems could be permissioned with migratory SBTs. Regulatory capture could be codified in nested community tokens, where homeowners have a disproportionate voting power and stall housing construction. SBTs could automate red-lining. As we discuss further below, these scenarios should be considered within the context of the current opaque-top-down permissions and discriminations. SBTs make discrimination more transparent and therefore potentially contestable.</p>
</blockquote>
<p>DAO 通常在虚拟世界和物理世界中拥有或围绕拥有资产进行组织。到目前为止，web3 的范围主要局限于一小类财产，其权利捆绑可以完全转让：代币、NFT、艺术品、第一版或像美国宪法这样的稀有手稿。但是，对可转让性的强调对 web3 不利，使其无法代表和支持当今一些最简单且无处不在的财产合同，例如公寓租赁。财产权在罗马法律传统中被定义为使用权（“usus”）、消费或破坏权（“abusus”）和利润（“fructus”）的组合。很少有所有这些权利共同归属于同一所有者。例如，公寓租赁授予出租人有限的使用权（“usus”），但不授予出租人摧毁公寓（“abusus”）、出售（“fructus”）甚至转让使用权（转租）的不受限制的权利.不动产（土地）的权利通常受到一系列私人使用限制、公共使用权授予、销售权限制，甚至征用权购买权的限制。他们通常还背负着将一些财务价值转移给贷方的抵押贷款。</p>
<p>财产创新的未来不太可能建立在迄今为止想象的 web3 完全可转让的私有财产之上。<strong>相反，创新将取决于分解财产权以匹配现有财产制度特征的能力，并编写更丰富的细节。</strong>公司和其他组织形式的演变恰恰是为了以更具创造性的方式重新配置产权——例如，授予员工使用专有设施（“usus”）的权限，但保留经理更改或损坏资产的权利（“abusus”），同时支付股东最大的经济利益（“结果”）。 SBT 可以灵活地代表和扩大物理和虚拟资产的细微产权，同时鼓励新的实验。这里只是一些用例：</p>
<ul>
<li>允许访问私人或公共控制的资源（例如，住宅、汽车、博物馆、公园和虚拟等价物）。可转让的 NFT 未能很好地捕捉到这个用例，因为访问权限通常是有条件的且不可转让的：如果我相信你会进入我的后院并将其用作娱乐空间，这并不意味着我相信你会将该许可转授给其他人。</li>
<li>SBT 授予研究人员数据访问权限的数据合作社，同时赋予成员授予访问权限的权利（可能通过二次投票），并就研究产生的发现和知识产权的经济权利进行谈判。我们将在第 4 节“复数意义构建”中进一步探讨这一点。</li>
<li>试验当地货币的规则，让居住在特定地区或属于特定社区的灵魂更有价值地持有和消费。</li>
<li>参与实验，其中 SBT 为较少情境化的灵魂（例如移民、青少年）在新颖和更广泛的网络中获得影响力创造持续的基础。这样的灵魂将从狭窄的 SBT 开始，将他们与家人或当地社区集中在一起。随着他们的从属关系逐渐多样化，他们将获得更广泛的 SBT，以实例化投票权以影响更广泛的网络——本着 Danielle Allen 的多元政治理念的精神——这一过程目前由任意年龄和居住地截止进行调解。</li>
<li>市场设计实验，例如 Harberger 税收和 SALSA（在拍卖中出售的自我评估许可证），资产持有人发布自我评估价格，任何其他人都可以从他们那里购买资产，并且必须定期缴纳税款与自我评估的价格成正比，以保持控制。 SBT 可用于创建更细微的 SALSA 版本——例如，社区批准参与权，以尽量减少来自社区内部或外部的战略行为。</li>
<li>二次投票等民主机制设计实验。代表社区成员的 SBT 持有者可以对激励和税率等参数进行二次投票。归根结底，“市场”和“政治”不是独立的设计空间。 SBT 可以成为技术堆栈的主要部分，可以探索两个类别之间的整个空间。通过二次融资提供公共产品是另一个这样的交叉点。</li>
</ul>
<p>当然，还有一些反乌托邦场景需要考虑。移民系统可以通过迁移 SBT 获得许可。 监管捕获可以编码在嵌套的社区代币中，其中房主拥有不成比例的投票权并阻碍住房建设。SBT 可以使红线自动化。 正如我们在下面进一步讨论的那样，应该在当前不透明的自上而下的权限和歧视的背景下考虑这些场景。 SBT 使歧视更加透明，因此可能具有争议性。</p>
<blockquote>
<h4 id="4-8-From-Private-and-Public-Goods-to-Plural-Network-Goods"><a href="#4-8-From-Private-and-Public-Goods-to-Plural-Network-Goods" class="headerlink" title="4.8 From Private and Public Goods to Plural Network Goods"></a>4.8 From Private and Public Goods to Plural Network Goods</h4></blockquote>
<p>从私人和公共产品到多元网络产品</p>
<blockquote>
<h3 id="§5-PLURAL-SENSEMAKING"><a href="#§5-PLURAL-SENSEMAKING" class="headerlink" title="§5 PLURAL SENSEMAKING"></a>§5 PLURAL SENSEMAKING</h3><p>An example of plural network goods that are of increasing salience in a digital world are predictive models built off user data. Both artificial intelligence (AI) and prediction markets seek to predict future events based on data primarily elicited from people. But both paradigms are limited in different and nearly opposite ways. The dominant paradigm in AI eschews incentives, instead hoovering up (public or privately surveilled) data feeds and synthesizing them into predictions through proprietary large-scale, non-linear models—harnessing the default web2 monopoly on “usus” without any “fructus” flowing to data laborers. Prediction markets take the opposite approach, where people bet on outcome in the hopes of financial gains, relying entirely on economic incentives of financial speculation (“fructus”) without synthesizing the beliefs of bettors to produce composable models. At the same time, both of these paradigms yield conclusions that are characterized as “objective” truths; whereas AI models are portrayed as “universal” or “generally intelligent,” prediction markets are portrayed as summarizing all the beliefs of the market participants in a single number: equilibrium price.</p>
<p>A more productive paradigm is to eschew these extremes, and instead draw on the virtues of both, while compensating for their weaknesses and enriching their breadth. We propose thoughtfully combining the complexity of non-linear AI models with the market incentives of prediction markets to transform passive data laborers into active data creators. With such provenance-rich information rooted in the sociality of data creators, we illustrate how DeSoc can unlock plural network(ed) intelligence more powerful than either approach.</p>
<h4 id="5-1-Prediction-Markets-to-Prediction-Plurality"><a href="#5-1-Prediction-Markets-to-Prediction-Plurality" class="headerlink" title="5.1 Prediction Markets to Prediction Plurality"></a>5.1 Prediction Markets to Prediction Plurality</h4><h4 id="5-2-Artificial-Intelligence-to-Plural-Intelligence"><a href="#5-2-Artificial-Intelligence-to-Plural-Intelligence" class="headerlink" title="5.2 Artificial Intelligence to Plural Intelligence"></a>5.2 Artificial Intelligence to Plural Intelligence</h4><h4 id="5-3-Programmable-Plural-Privacy"><a href="#5-3-Programmable-Plural-Privacy" class="headerlink" title="5.3 Programmable Plural Privacy"></a>5.3 Programmable Plural Privacy</h4></blockquote>
<p>在数字世界中越来越显着的多种网络商品的一个例子是基于用户数据构建的预测模型。人工智能 (AI) 和预测市场都试图根据主要从人们那里获得的数据来预测未来事件。但是这两种范式都以不同且几乎相反的方式受到限制。 AI 中的主导范式避开了激励措施，而是收集（公共或私人监视的）数据馈送，并通过专有的大规模非线性模型将它们综合成预测——利用默认的 web2 对“usus”的垄断，而没有任何“fructus”流动给数据工作者。预测市场采取相反的方法，人们在结果上下注，希望获得经济收益，完全依赖金融投机（“水果”）的经济激励，而不综合投注者的信念来产生可组合的模型。同时，这两种范式都得出了被称为“客观”真理的结论。人工智能模型被描述为“通用”或“普遍智能”，而预测市场被描述为将市场参与者的所有信念总结为一个数字：均衡价格。</p>
<p>一个更有成效的范式是避开这些极端，取而代之的是利用两者的优点，同时弥补它们的弱点并丰富它们的广度。我们建议将非线性 AI 模型的复杂性与预测市场的市场激励相结合，将被动的数据劳动者转变为主动的数据创造者。有了这些植根于数据创建者的社交性的来源丰富的信息，我们说明了 DeSoc 如何能够解锁比任何一种方法都更强大的多元网络智能。</p>
<h4 id="5-1-预测复数的预测市场"><a href="#5-1-预测复数的预测市场" class="headerlink" title="5.1 预测复数的预测市场"></a>5.1 预测复数的预测市场</h4><h4 id="5-2-人工智能到多元智能"><a href="#5-2-人工智能到多元智能" class="headerlink" title="5.2 人工智能到多元智能"></a>5.2 人工智能到多元智能</h4><h4 id="5-3-可编程复数隐私"><a href="#5-3-可编程复数隐私" class="headerlink" title="5.3 可编程复数隐私"></a>5.3 可编程复数隐私</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/05/12/%E4%BB%A5%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%BA%E4%BE%8B%E5%88%86%E6%9E%90%E5%85%AC%E6%9C%89%E9%93%BE%E4%BA%A4%E6%98%93%E5%90%88%E8%A7%84%E7%9A%84%E6%8A%80%E6%9C%AF%E9%9A%9C%E7%A2%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/12/%E4%BB%A5%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%BA%E4%BE%8B%E5%88%86%E6%9E%90%E5%85%AC%E6%9C%89%E9%93%BE%E4%BA%A4%E6%98%93%E5%90%88%E8%A7%84%E7%9A%84%E6%8A%80%E6%9C%AF%E9%9A%9C%E7%A2%8D/" class="post-title-link" itemprop="url">以以太坊为例分析公有链交易合规的技术障碍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-12 09:24:00" itemprop="dateCreated datePublished" datetime="2022-05-12T09:24:00+08:00">2022-05-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-05-19 22:02:06" itemprop="dateModified" datetime="2022-05-19T22:02:06+08:00">2022-05-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>假设一个罪犯，他想要将钱洗干净：</p>
<p>1）通常他会将钱转移到一个干净的地址，很可能会建立控制权，这样可以否认自己是当事方；</p>
<p>2）开始交易：</p>
<ul>
<li>在DEX (AMM)交易所中交易，可能是几次投资性交易，最终回到stable coin；</li>
<li>在中心化交易所交易，其历史交易记录保存在其中心化order_book_history中；</li>
<li>在桥接协议中去到其他公有链交易，混淆交易路径；</li>
<li>利用零知识证明、混币等隐私交易，可以隐藏交易路径以及金额；</li>
<li>通过 scaling protocol 交易，可以做隐私交易，如zksync；也可以只做rollup，如Optimism；也可能是state channel，如Raiden Network只记录blockhash而已；</li>
<li>隐私合约，桥接合约，HTLC合约等可以是新部署，且只服务若干笔交易；</li>
<li>以上交易方式可以搭配，组合使用。</li>
</ul>
<p>3）最终从一个干净的地址，甚至（关联交易，关联账户）拆解成为小额交易，从交易所交易成为现金取出。</p>
<p>另外，未来还有一种可能会影响合规和审计：</p>
<p>1）隐私合约，桥接合约，HTLC合约等可以是新部署，且只服务若干笔交易；</p>
<p>2）交易有可能是废弃的，无效的 <a target="_blank" rel="noopener" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-5081.md%EF%BC%9B">https://github.com/ethereum/EIPs/blob/master/EIPS/eip-5081.md；</a></p>
<p>3）以太坊删除无用的state数据。</p>
<p>最后，Even if a contract is removed by <code>selfdestruct</code>, it is still part of the history of the blockchain and probably retained by most Ethereum nodes. So using <code>selfdestruct</code> is not the same as deleting data from a hard disk. 合约删除不会是技术障碍。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/" class="post-title-link" itemprop="url">移植EVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-04-29 18:01:00 / Modified: 18:09:51" itemprop="dateCreated datePublished" datetime="2022-04-29T18:01:00+08:00">2022-04-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>请先阅览前文 ==&gt; <a target="_blank" rel="noopener" href="https://willzhuang.github.io/2019/03/20/evm%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">EVM之源码分析</a> ，整个分析其实就是为了移植虚拟机做基础。</p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>因为涉及到的代码会比较多，不可能把所有代码都列举出来。所以也只是挑关键的部分进行讲解说明。整个移植的代码已经合到之前的那个简单(无用)<a target="_blank" rel="noopener" href="https://github.com/blockchainworkers/conch">demo</a>版本的公链项目上了。 移植的以太坊版本为v1.8.12.</p>
<h3 id="开始移植"><a href="#开始移植" class="headerlink" title="开始移植"></a>开始移植</h3><p>首先先创建一个go的新项目, 将go-ethereum项目下core/vm文件夹下的代码全部拷贝到新项目下，我们为新的文件夹名称为cvm。 保存之后， 假设你用的是vscode(带上了go的周边插件)或者goland，这个时候你会发现有大量的报错。 没有关系， 因为很多以太坊包还没有被导入进来。 但是呢， 既然我们只想移植虚拟机部分，又不引入以太坊的其他模块。 这个时候我们就把需要的包直接拷贝到我们的项目中。 彻底分离和go-ethereum的关系。这里需要说明一下， 虽然是开源项目， 拷贝和使用别人的开源代码也要注意license的。</p>
<ol>
<li>主要需要拷贝的包如下</li>
</ol>
<ul>
<li>go-ethereum/common这个文件夹， 我们也将其这个内容均拷贝到cvm这个文件夹下。</li>
<li>go-ethereum/params这个文件夹中的gas_tables.go, protocol_params.go两个文件拷贝到cvm/params文件夹下。</li>
<li>创建log.go文件在cvm/types/下， 该文件中主要是智能合约emit提交事件时使用的log对象。 内容如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type Log struct &#123;</span><br><span class="line">   &#x2F;&#x2F; Consensus fields:</span><br><span class="line">   &#x2F;&#x2F; address of the contract that generated the event</span><br><span class="line">   Address common.Address &#96;json:&quot;address&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; list of topics provided by the contract.</span><br><span class="line">   Topics []common.Hash &#96;json:&quot;topics&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; supplied by the contract, usually ABI-encoded</span><br><span class="line">   Data []byte &#96;json:&quot;data&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Derived fields. These fields are filled in by the node</span><br><span class="line">   &#x2F;&#x2F; but not secured by consensus.</span><br><span class="line">   &#x2F;&#x2F; block in which the transaction was included</span><br><span class="line">   BlockNumber uint64 &#96;json:&quot;blockNumber&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; hash of the transaction</span><br><span class="line">   TxHash common.Hash &#96;json:&quot;transactionHash&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; index of the transaction in the block</span><br><span class="line">   TxIndex uint &#96;json:&quot;transactionIndex&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; hash of the block in which the transaction was included</span><br><span class="line">   BlockHash common.Hash &#96;json:&quot;blockHash&quot;&#96;</span><br><span class="line">   &#x2F;&#x2F; index of the log in the receipt</span><br><span class="line">   Index uint &#96;json:&quot;logIndex&quot; gencodec:&quot;required&quot;&#96;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; The Removed field is true if this log was reverted due to a chain reorganisation.</span><br><span class="line">   &#x2F;&#x2F; You must pay attention to this field if you receive logs through a filter query.</span><br><span class="line">   Removed bool &#96;json:&quot;removed&quot;&#96;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在cvm目录下创建vm.go文件， 主要是生成evm的上下文对象。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewEVMContext creates a new context for use in the EVM.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEVMContext</span><span class="params">(from common.Address, blockNum, timeStamp, difficulty <span class="keyword">int64</span>)</span> <span class="title">vm</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="comment">// If we don&#x27;t have an explicit author (i.e. not mining), extract from the header</span></span><br><span class="line">	<span class="keyword">return</span> vm.Context&#123;</span><br><span class="line">		CanTransfer: CanTransfer,</span><br><span class="line">		Transfer:    Transfer,</span><br><span class="line">		GetHash:     GetHashFn(),</span><br><span class="line">		Origin:      from,</span><br><span class="line">		Coinbase:    common.Address&#123;&#125;,</span><br><span class="line">		BlockNumber: <span class="built_in">new</span>(big.Int).Set(big.NewInt(blockNum)),</span><br><span class="line">		Time:        <span class="built_in">new</span>(big.Int).Set(big.NewInt(timeStamp)),</span><br><span class="line">		Difficulty:  <span class="built_in">new</span>(big.Int).Set(big.NewInt(difficulty)),</span><br><span class="line">		GasLimit:    <span class="number">0xfffffffffffffff</span>, <span class="comment">//header.GasLimit,</span></span><br><span class="line">		GasPrice:    <span class="built_in">new</span>(big.Int).Set(big.NewInt(<span class="number">10</span>)),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetHashFn returns a GetHashFunc which retrieves header hashes by number 获取块号码对于的块hash</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHashFn</span><span class="params">()</span> <span class="title">func</span><span class="params">(n <span class="keyword">uint64</span>)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">uint64</span>)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line">		<span class="comment">// If there&#x27;s no hash cache yet, make one</span></span><br><span class="line">		<span class="comment">// if cache == nil &#123;</span></span><br><span class="line">		<span class="comment">// 	cache = map[uint64]common.Hash&#123;</span></span><br><span class="line">		<span class="comment">// 		ref.Number.Uint64() - 1: ref.ParentHash,</span></span><br><span class="line">		<span class="comment">// 	&#125;</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="comment">// // Try to fulfill the request from the cache</span></span><br><span class="line">		<span class="comment">// if hash, ok := cache[n]; ok &#123;</span></span><br><span class="line">		<span class="comment">// 	return hash</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="comment">// // Not cached, iterate the blocks and cache the hashes</span></span><br><span class="line">		<span class="comment">// for header := chain.GetHeader(ref.ParentHash, ref.Number.Uint64()-1); header != nil; header = chain.GetHeader(header.ParentHash, header.Number.Uint64()-1) &#123;</span></span><br><span class="line">		<span class="comment">// 	cache[header.Number.Uint64()-1] = header.ParentHash</span></span><br><span class="line">		<span class="comment">// 	if n == header.Number.Uint64()-1 &#123;</span></span><br><span class="line">		<span class="comment">// 		return header.ParentHash</span></span><br><span class="line">		<span class="comment">// 	&#125;</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CanTransfer checks wether there are enough funds in the address&#x27; account to make a transfer.</span></span><br><span class="line"><span class="comment">// This does not take the necessary gas in to account to make the transfer valid.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CanTransfer</span><span class="params">(db vm.StateDB, addr common.Address, amount *big.Int)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> db.GetBalance(addr).Cmp(amount) &gt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transfer subtracts amount from sender and adds amount to recipient using the given Db</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Transfer</span><span class="params">(db vm.StateDB, sender, recipient common.Address, amount *big.Int)</span></span> &#123;</span><br><span class="line">	db.SubBalance(sender, amount)</span><br><span class="line">	db.AddBalance(recipient, amount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>接着我们把go-ethereum/account文件夹下的abi内容拷贝到cvm文件夹下。</li>
</ol>
<blockquote>
<p>abi/bind文件内容可以直接删除掉。此文件夹下是对智能合约进行函数调用进行编码的包。换句话调用智能合约构建的交易中的input内容就是需要此包中函数来生成的。当然如果你看了前面的文章，对智能合约调用了解的话，此处自然就理解这个包的作用了。</p>
</blockquote>
<p>到了这里整个需要拷贝的文件就齐全了， 目录结构如下:</p>
<p><img src="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/1.jpg"></p>
<ol start="4">
<li>接下来我们需要修改evm的部分代码了。</li>
</ol>
<blockquote>
<p>vm/contracts.go文件我们直接删除掉。 这个是自带的智能合约， 内部主要是一些内置函数， 注意实际使用的时候记得还是要实现的， evm.go文件中run函数忽略掉所有内置的合约函数。</p>
</blockquote>
<p><img src="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/2.jpg"></p>
<p>修改evm.go文件中的Call函数 当地址不存在时我们直接认为是创建地址， 忽略掉掉内置合约。 <img src="/2022/04/29/%E7%A7%BB%E6%A4%8DEVM/3.jpg"></p>
<ol start="5">
<li>接着我们要实现evm.StateDB接口的内容了， 因为此接口涉及涉及的主要是个账户状态相关的内容， 也即是说可整个区块的存储是有关联的， 暂时我也只能以一个示例来说明是如何简单的实现这些接口。</li>
</ol>
<p>我们在cvm文件夹下创建一个account_state.go的文件。 定义的数据结构格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> accountObject <span class="keyword">struct</span> &#123;</span><br><span class="line">	Address      common.Address              <span class="string">`json:&quot;address,omitempty&quot;`</span></span><br><span class="line">	AddrHash     common.Hash                 <span class="string">`json:&quot;addr_hash,omitempty&quot;`</span> <span class="comment">// hash of ethereum address of the account</span></span><br><span class="line">	ByteCode     []<span class="keyword">byte</span>                      <span class="string">`json:&quot;byte_code,omitempty&quot;`</span></span><br><span class="line">	Data         accountData                 <span class="string">`json:&quot;data,omitempty&quot;`</span></span><br><span class="line">	CacheStorage <span class="keyword">map</span>[common.Hash]common.Hash <span class="string">`json:&quot;cache_storage,omitempty&quot;`</span> <span class="comment">// 用于缓存存储的变量</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> accountData <span class="keyword">struct</span> &#123;</span><br><span class="line">	Nonce    <span class="keyword">uint64</span>      <span class="string">`json:&quot;nonce,omitempty&quot;`</span></span><br><span class="line">	Balance  *big.Int    <span class="string">`json:&quot;balance,omitempty&quot;`</span></span><br><span class="line">	Root     common.Hash <span class="string">`json:&quot;root,omitempty&quot;`</span> <span class="comment">// merkle root of the storage trie</span></span><br><span class="line">	CodeHash []<span class="keyword">byte</span>      <span class="string">`json:&quot;code_hash,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AccountState 实现vm的StateDB的接口 用于进行测试</span></span><br><span class="line"><span class="keyword">type</span> AccountState <span class="keyword">struct</span> &#123;</span><br><span class="line">	Accounts <span class="keyword">map</span>[common.Address]*accountObject <span class="string">`json:&quot;accounts,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>接下来我们实现StateDB接口:</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateAccount 创建账户接口 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">CreateAccount</span><span class="params">(addr common.Address)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> accSt.getAccountObject(addr) != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	obj := newAccountObject(addr, accountData&#123;&#125;)</span><br><span class="line">	accSt.setAccountObject(obj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SubBalance 减去某个账户的余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SubBalance</span><span class="params">(addr common.Address, amount *big.Int)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.SubBalance(amount)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddBalance 增加某个账户的余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddBalance</span><span class="params">(addr common.Address, amount *big.Int)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.AddBalance(amount)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//// GetBalance 获取某个账户的余额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetBalance</span><span class="params">(addr common.Address)</span> *<span class="title">big</span>.<span class="title">Int</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.Balance()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//GetNonce 获取nonce</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetNonce</span><span class="params">(addr common.Address)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.Nonce()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetNonce 设置nonce</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SetNonce</span><span class="params">(addr common.Address, nonce <span class="keyword">uint64</span>)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.SetNonce(nonce)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCodeHash 获取代码的hash值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetCodeHash</span><span class="params">(addr common.Address)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> common.BytesToHash(stateObject.CodeHash())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//GetCode 获取智能合约的代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetCode</span><span class="params">(addr common.Address)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.Code()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SetCode 设置智能合约的code</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SetCode</span><span class="params">(addr common.Address, code []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		stateObject.SetCode(crypto.Sha256(code), code)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCodeSize 获取code的大小</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetCodeSize</span><span class="params">(addr common.Address)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> stateObject.ByteCode != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(stateObject.ByteCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddRefund 暂时先忽略补偿</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddRefund</span><span class="params">(<span class="keyword">uint64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//GetRefund ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetRefund</span><span class="params">()</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetState 和SetState 是用于保存合约执行时 存储的变量是否发生变化 evm对变量存储的改变消耗的gas是有区别的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">GetState</span><span class="params">(addr common.Address, key common.Hash)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> stateObject.GetStorageState(key)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> common.Hash&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetState 设置变量的状态</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">SetState</span><span class="params">(addr common.Address, key common.Hash, value common.Hash)</span></span> &#123;</span><br><span class="line">	stateObject := accSt.getOrsetAccountObject(addr)</span><br><span class="line">	<span class="keyword">if</span> stateObject != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;SetState key: %x value: %s&quot;</span>, key, <span class="built_in">new</span>(big.Int).SetBytes(value[:]).String())</span><br><span class="line">		stateObject.SetStorageState(key, value)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Suicide 暂时禁止自杀</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Suicide</span><span class="params">(common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HasSuicided ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">HasSuicided</span><span class="params">(common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exist 检查账户是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Exist</span><span class="params">(addr common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> accSt.getAccountObject(addr) != <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Empty 是否是空账户</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Empty</span><span class="params">(addr common.Address)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	so := accSt.getAccountObject(addr)</span><br><span class="line">	<span class="keyword">return</span> so == <span class="literal">nil</span> || so.Empty()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RevertToSnapshot ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">RevertToSnapshot</span><span class="params">(<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Snapshot ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Snapshot</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddLog 添加事件触发日志</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddLog</span><span class="params">(log *types.Log)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;log: %v&quot;</span>, log)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddPreimage </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">AddPreimage</span><span class="params">(common.Hash, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForEachStorage  暂时没发现vm调用这个接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">ForEachStorage</span><span class="params">(common.Address, <span class="keyword">func</span>(common.Hash, common.Hash)</span> <span class="title">bool</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit 进行持久存储 这里我们只将其简单的json话之后保存到本地磁盘中。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(accSt *AccountState)</span> <span class="title">Commit</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 将bincode写入文件</span></span><br><span class="line">	file, err := os.Create(<span class="string">&quot;./account_sate.db&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	err = json.NewEncoder(file).Encode(accSt)</span><br><span class="line">	<span class="comment">//fmt.Println(&quot;len(binCode): &quot;, len(binCode), &quot; code: &quot;, binCode)</span></span><br><span class="line">	<span class="comment">// bufW := bufio.NewWriter(file)</span></span><br><span class="line">	<span class="comment">// bufW.Write(binCode)</span></span><br><span class="line">	<span class="comment">// // bufW.WriteByte(&#x27;\n&#x27;)</span></span><br><span class="line">	<span class="comment">// bufW.Flush()</span></span><br><span class="line">	file.Close()</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//TryLoadFromDisk  尝试从磁盘加载AccountState</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TryLoadFromDisk</span><span class="params">()</span> <span class="params">(*AccountState, error)</span></span> &#123;</span><br><span class="line">	file, err := os.Open(<span class="string">&quot;./account_sate.db&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> NewAccountStateDb(), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// stat, _ := file.Stat()</span></span><br><span class="line">	<span class="comment">// // buf := stat.Size()</span></span><br><span class="line">	<span class="keyword">var</span> accStat AccountState</span><br><span class="line"></span><br><span class="line">	err = json.NewDecoder(file).Decode(&amp;accStat)</span><br><span class="line">	<span class="keyword">return</span> &amp;accStat, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>接下来尝试部署两份智能合约进行测试:</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.21</span>;</span><br><span class="line">interface BaseInterface &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CurrentVersion</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">string</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Helloworld &#123;</span><br><span class="line">    uint256 balance;</span><br><span class="line">    event Triggle(address, string);</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span>=&gt;</span>uint256) _mapamount; </span><br><span class="line">    </span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span>) <span class="title">public</span> &#123;</span><br><span class="line">        balance = <span class="number">6000000000</span>;</span><br><span class="line">        _mapamount[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line">        _mapamount[<span class="number">1</span>] = <span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getbalance</span>(<span class="params"></span>) <span class="title">public</span>  <span class="title">returns</span> (<span class="params">address, uint256</span>) </span>&#123;</span><br><span class="line">        emit Triggle(msg.sender, <span class="string">&quot;funck&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (msg.sender, balance--);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onlytest</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        _mapamount[<span class="number">1</span>] = <span class="number">100</span>;</span><br><span class="line">        emit Triggle(msg.sender, <span class="string">&quot;onlytest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setBalance</span>(<span class="params">uint256 tmp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        balance = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getVersion</span>(<span class="params">address contractAddr</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        BaseInterface baseClass = BaseInterface(contractAddr);</span><br><span class="line">       <span class="keyword">return</span> baseClass.CurrentVersion();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.21</span>;</span><br><span class="line"></span><br><span class="line">contract BaseContract &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"> <span class="comment">// </span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">CurrentVersion</span>(<span class="params"></span>) <span class="title">pure</span> <span class="title">public</span> <span class="title">returns</span>(<span class="params">string</span>)  </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;BaseContractV0.1&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这两个合约我们就可以测试到一些view 类型的函数调用， 一些对数据状态有修改的合约调用， 和跨合约的调用。 我们可以将上面的两个合约通过ethereum官方出品的remix进行编译，得到字节码。因为BaseContract没有涉及初始化的内容 所以我们可以直接使用runtime的bytecode。 不过我们直接使用Create函数去部署合约。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runtimeBytecode, contractAddr, leftgas, <span class="attr">err</span> := vmenv.Create(vm.AccountRef(normalAccount), helloCode, <span class="number">10000000000</span>, big.NewInt(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<p>第一个返回值其实就是需要部署的runtime字节码 ， 我们调用<code>stateDb.SetCode(helloWorldcontactAccont, runtimeBytecode)</code>将其部署。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> normalAddress, _ = hex.DecodeString(<span class="string">&quot;123456abc&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> hellWorldcontractAddress, _ = hex.DecodeString(<span class="string">&quot;987654321&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> baseContractAddress, _ = hex.DecodeString(<span class="string">&quot;038f160ad632409bfb18582241d9fd88c1a072ba&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> normalAccount = common.BytesToAddress(normalAddress)</span><br><span class="line"><span class="keyword">var</span> helloWorldcontactAccont = common.BytesToAddress(hellWorldcontractAddress)</span><br><span class="line"><span class="keyword">var</span> baseContractAccont = common.BytesToAddress(baseContractAddress)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本账户字节码</span></span><br><span class="line"><span class="keyword">var</span> baseCodeStr = <span class="string">&quot;608060405260043610610062576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632b225f29146100675780638afc3605146100f75780638da5cb5b1461010e578063f2fde38b14610165575b600080fd5b34801561007357600080fd5b5061007c6101a8565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100bc5780820151818401526020810190506100a1565b50505050905090810190601f1680156100e95780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561010357600080fd5b5061010c6101e5565b005b34801561011a57600080fd5b50610123610227565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561017157600080fd5b506101a6600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061024c565b005b60606040805190810160405280601081526020017f42617365436f6e747261637456302e3100000000000000000000000000000000815250905090565b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156102a757600080fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141515156102e357600080fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3505600a165627a7a723058208c3064096245894122f6bcf5e2ee12e30d4775a3b8dca0b21f10d5a5bc386e8b0029&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// hellworld 账户字节码</span></span><br><span class="line"><span class="keyword">var</span> hellCodeStr = <span class="string">&quot;6080604052600436106100615763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416634d9b3d5d81146100665780637e8800a7146100ab578063c3f82bc3146100c2578063fb1669ca14610165575b600080fd5b34801561007257600080fd5b5061007b61017d565b6040805173ffffffffffffffffffffffffffffffffffffffff909316835260208301919091528051918290030190f35b3480156100b757600080fd5b506100c06101fa565b005b3480156100ce57600080fd5b506100f073ffffffffffffffffffffffffffffffffffffffff6004351661028f565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561012a578181015183820152602001610112565b50505050905090810190601f1680156101575780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561017157600080fd5b506100c0600435610389565b60408051338152602081018290526005818301527f66756e636b0000000000000000000000000000000000000000000000000000006060820152905160009182917f08c31d20d5c3a5f2cfe0adf83909e6411f43fe97eb091e15c12f3e5a203e8fde9181900360800190a150506000805460001981019091553391565b600080526001602090815260647fa6eef7e35abe7026729641147f7915573c7e97b47efa546f5f6e3230263bcb4955604080513381529182018190526008828201527f6f6e6c79746573740000000000000000000000000000000000000000000000006060830152517f08c31d20d5c3a5f2cfe0adf83909e6411f43fe97eb091e15c12f3e5a203e8fde9181900360800190a1565b606060008290508073ffffffffffffffffffffffffffffffffffffffff16632b225f296040518163ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401600060405180830381600087803b1580156102fa57600080fd5b505af115801561030e573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052602081101561033757600080fd5b81019080805164010000000081111561034f57600080fd5b8201602081018481111561036257600080fd5b815164010000000081118282018710171561037c57600080fd5b5090979650505050505050565b6000555600a165627a7a72305820c63a859d93a3512b52ccaec75bb9aa146648c41b21c8a0cd0cd2e2c1aede35ed0029&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helloCode, _ = hex.DecodeString(hellCodeStr)</span><br><span class="line"><span class="keyword">var</span> baseCode, _ = hex.DecodeString(baseCodeStr)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">updateContract</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="comment">// 加载账户State</span></span><br><span class="line">	stateDb, <span class="attr">err</span> := cvm.TryLoadFromDisk()</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	stateDb.SetCode(helloWorldcontactAccont, helloCode)</span><br><span class="line">	stateDb.SetCode(baseContractAccont, baseCode)</span><br><span class="line">	fmt.Println(stateDb.Commit())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们调用一个智能合约比如getbalance函数， 代码类似下面这样:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4d9b3d5d : getbalance  7e8800a7: onlytest fb1669ca000000000000000000000000000000000000000000000000000000000000029a: setbalance 666</span></span><br><span class="line"><span class="keyword">var</span> input, _ = hex.DecodeString(<span class="string">&quot;7e8800a7&quot;</span>)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="comment">// updateContract()</span></span><br><span class="line">	<span class="comment">// return</span></span><br><span class="line">	<span class="comment">// 创建账户State</span></span><br><span class="line">	stateDb, <span class="attr">err</span> := cvm.TryLoadFromDisk()</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	evmCtx := cvm.NewEVMContext(normalAccount, <span class="number">100</span>, <span class="number">1200000</span>, <span class="number">1</span>)</span><br><span class="line">	vmenv := vm.NewEVM(evmCtx, stateDb, vm.Config&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	ret, leftgas, <span class="attr">err</span> := vmenv.Call(vm.AccountRef(normalAccount), helloWorldcontactAccont, input, <span class="number">1000000</span>, big.NewInt(<span class="number">0</span>))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ret: %v, usedGas: %v, err: %v, len(ret): %v, hexret: %v, &quot;</span>, ret, <span class="number">1000000</span>-leftgas, err, len(ret), hex.EncodeToString(ret))</span><br><span class="line"></span><br><span class="line">	abiObjet, <span class="attr">_</span> := abi.JSON(strings.NewReader(hellWorldContractABIJson))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// begin, length, _ := lengthPrefixPointsTo(0, ret)</span></span><br><span class="line">	addr := <span class="keyword">new</span>(common.Address)</span><br><span class="line"></span><br><span class="line">	value := big.NewInt(<span class="number">0</span>) <span class="comment">//new(*big.Int)</span></span><br><span class="line">	restult := []interface&#123;&#125;&#123;addr, &amp;value&#125;</span><br><span class="line">	fmt.Println(abiObjet.Unpack(&amp;restult, <span class="string">&quot;getbalance&quot;</span>, ret))</span><br><span class="line">	<span class="comment">//fmt.Println(unpackAtomic(&amp;restult, string(ret[begin:begin+length])))</span></span><br><span class="line">	println(restult[<span class="number">0</span>].(*common.Address).String(), (*restult[<span class="number">1</span>].(**big.Int)).String())</span><br><span class="line">	fmt.Println(stateDb.Commit())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>到了这里， evm移植流程就算完成了。 如果理解evm执行的原理， 大部分的工作其实就是拷贝， 出错的任务。 当然这个移植后的代码肯定是不能在生产中使用的， 但是需要修改和添加的代码主要也就是上文提到的内容。 最后还是想说明白原理和流程就是成功了一大半， 后面的部分主要就是调试和排错的过程了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zhuang-weiming.github.io/2022/04/27/4.Open%20source%20ecommerce%20platform%20for%20multi-vendor%20marketplaces/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Weiming Zhuang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhuang's Diary">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/27/4.Open%20source%20ecommerce%20platform%20for%20multi-vendor%20marketplaces/" class="post-title-link" itemprop="url">4.Open source ecommerce platform for multi-vendor marketplaces</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-27 17:18:00" itemprop="dateCreated datePublished" datetime="2022-04-27T17:18:00+08:00">2022-04-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-08-01 10:05:14" itemprop="dateModified" datetime="2023-08-01T10:05:14+08:00">2023-08-01</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I tried here <a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender#marketplace-tutorial">https://github.com/adrien2p/medusa-extender#marketplace-tutorial</a> for new medusa-server, the same as <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace">https://github.com/shahednasser/medusa-marketplace</a>, but fail to “npm start”.</p>
<p>But we can run it buy code update directly step by step — <a target="_blank" rel="noopener" href="https://dev.to/medusajs/create-an-open-source-commerce-marketplace-part-1-3m5k">https://dev.to/medusajs/create-an-open-source-commerce-marketplace-part-1-3m5k</a>, this is a guide to migrate exciting medusa-server to upgrade about “store_id”.</p>
<p>==================&gt; guide detail &lt;==================</p>
<p><a target="_blank" rel="noopener" href="https://www.medusajs.com/">Medusa</a> is an open source headless commerce platform that allows you to create your own store in a matter of minutes. Part of what makes Medusa a good choice for your ecommerce store is its extensibility. <strong>Now, it is also possible to create multi-vendor marketplaces using Medusa</strong>.</p>
<p>To make things easier for our open source community, <a target="_blank" rel="noopener" href="https://github.com/adrien2p">Adrien de Peretti</a>, one of our amazing contributors, created a Medusa module that allows you to extend anything and everything you want.</p>
<blockquote>
<p>“I’ve been looking for an e-commerce solution that could provide me with some core features while being fully customisable… After some research, where I found that none of the present solutions could provide what I needed, I chose Medusa as it provided me with many of the needed features while being easy to extend. I ended up loving the community atmosphere, especially the proximity with the team, and have been helping those in the community looking for a similar fully-customisable solution by sharing a part of my private project. This is how the medusa-extender was born.” — Adrien de Peretti</p>
</blockquote>
<p>In this tutorial, you’ll learn how to install and set up the Medusa Extender module on your Medusa server. You’ll then learn how to use its customization abilities to create a marketplace in your store! The marketplace will have multiple stores or vendors, and each of these stores will be able to add its own products. This tutorial will be the first part of a series that will explore all aspects of creating a marketplace.</p>
<h2 id="What-is-Medusa-Extender"><a href="#What-is-Medusa-Extender" class="headerlink" title="What is Medusa Extender"></a>What is Medusa Extender</h2><p><a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender">Medusa Extender</a> is an NPM package that you can add to your Medusa store to extend or customize its functionalities. The scope of its customization entails Entities, Repositories, Services, and more.</p>
<p>The Medusa Extender has many use cases aside the marketplace functionality. It can be used in many other use cases, such as adding custom fields, listening to events to perform certain actions like sending emails, customizing Medusa’s validation of request parameters, and more.</p>
<h2 id="What-You’ll-Be-Creating"><a href="#What-You’ll-Be-Creating" class="headerlink" title="What You’ll Be Creating"></a>What You’ll Be Creating</h2><p>In this article and the following parts of this series, you’ll learn how to create a marketplace using Medusa and Medusa Extender. A marketplace is an online store that allows multiple vendors to add their products and sell them.</p>
<p>A marketplace has a lot of features, including managing a vendor’s own orders and settings. This part of the tutorial will only showcase how to create stores for each user and attach the products they create to that store.</p>
<h2 id="Code-for-This-Tutorial"><a href="#Code-for-This-Tutorial" class="headerlink" title="Code for This Tutorial"></a>Code for This Tutorial</h2><p>If you want to follow along you can find the code for this tutorial in <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace-tutorial">this repository</a>.</p>
<p>Alternatively, if you want to install the marketplace into your existing Medusa store, you can install the <a target="_blank" rel="noopener" href="https://github.com/shahednasser/medusa-marketplace">Medusa Marketplace plugin</a>. This plugin is created with the code from this tutorial and will be updated with every new part of this series released.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>Before you follow along with this tutorial, make sure you have:</p>
<ol>
<li>A Medusa server instance was installed. You can follow along with our easy <a target="_blank" rel="noopener" href="https://docs.medusajs.com/quickstart/quick-start">quickstart guide</a> to learn how you can do that.</li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/download/">PostgreSQL</a> installed and your Medusa server connected to it.</li>
<li><a target="_blank" rel="noopener" href="https://redis.io/download">Redis</a> installed and your Medusa server connected to it.</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart redis-server</span><br><span class="line">清楚redis 缓存数据</span><br><span class="line">➜  ~ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; select</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;select&#x27; command</span><br><span class="line">127.0.0.1:6379&gt; select 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; FLUSHDB</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">➜  ~ sudo /etc/init.d/postgresql star</span><br><span class="line">[sudo] password for zhuang: </span><br><span class="line">➜  ~ </span><br><span class="line">➜  ~ sudo -i -u postgres</span><br><span class="line">postgres@elementoryos61:~$ psql</span><br><span class="line">psql (12.9 (Ubuntu 12.9-0ubuntu0.20.04.1))</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line">postgres=# CREATE DATABASE openharbor_marketplace_medusa;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=# </span><br></pre></td></tr></table></figure>



<h2 id="Building-the-Marketplace"><a href="#Building-the-Marketplace" class="headerlink" title="Building the Marketplace"></a>Building the Marketplace</h2><h3 id="Project-Setup"><a href="#Project-Setup" class="headerlink" title="Project Setup"></a>Project Setup</h3><p>In the directory that holds your Medusa server, start by installing Medusa Extender using NPM:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i medusa-extender</span><br></pre></td></tr></table></figure>



<p>It’s recommended that you use TypeScript in your project to get the full benefits of Medusa-Extender. To do that, create the file <code>tsconfig.json</code> in the root of the Medusa project with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;module&quot;</span>: <span class="string">&quot;CommonJS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;declaration&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;emitDecoratorMetadata&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowSyntheticDefaultImports&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;es2017&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowJs&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;outDir&quot;</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rootDir&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;include&quot;</span>: [<span class="string">&quot;src&quot;</span>, <span class="string">&quot;medusa-config.js&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exclude&quot;</span>: [<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;node_modules&quot;</span>, <span class="string">&quot;**/*.spec.ts&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Next, update the <code>scripts</code> key in <code>package.json</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;seed&quot;</span>: <span class="string">&quot;medusa seed -f ./data/seed.json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;rm -rf dist &amp;&amp; tsc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;npm run build &amp;&amp; node dist/src/main.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>



<p>These scripts will ensure that your TypeScript files will be transpiled before Medusa is run.</p>
<p>Then, create the file <code>main.ts</code> in the directory <code>src</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Medusa &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> expressInstance = express();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([]);</span><br><span class="line"></span><br><span class="line">    expressInstance.listen(<span class="number">9000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">&#x27;Server successfully started on port 9000&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bootstrap();</span><br></pre></td></tr></table></figure>



<p>This file will make sure to load all the customizations you’ll add next when you run your Medusa server.</p>
<p>Now, Medusa Extender is fully integrated into your Medusa instance and you can start building the Marketplace.</p>
<h3 id="Customize-the-Store-Entity"><a href="#Customize-the-Store-Entity" class="headerlink" title="Customize the Store Entity"></a>Customize the Store Entity</h3><p>You’ll start by customizing the Store entity. You’ll need to use it later on to add relations between the store entity and the users and products entities.</p>
<p>By convention, customizations using Medusa Extender are organized in a module-like structure. However, this is completely optional.</p>
<p>In the <code>src</code> directory, create the directory <code>modules</code> in which you’ll store all the customizations in.</p>
<p>Then, create the directory <code>store</code> inside the <code>modules</code> directory. The <code>store</code> directory will hold all customizations related to the Store.</p>
<p><strong>Create a Store Entity</strong></p>
<p>Create the file <code>src/modules/store/entities/store.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Store <span class="keyword">as</span> MedusaStore &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity, JoinColumn, OneToMany &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaStore &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Store</span> <span class="keyword">extends</span> <span class="title">MedusaStore</span> </span>&#123;</span><br><span class="line">    <span class="comment">//TODO add relations</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the decorator <code>@Entity</code> from <code>medusa-extender</code> to customize Medusa’s <code>Store</code> entity. You create a <code>Store</code> class that extends Medusa’s Store entity (imported as <code>MedusaStore</code> ).</p>
<p>You’ll, later on, edit this entity to add the relations between the store and users and products.</p>
<p><strong>Create a Store Repository</strong></p>
<p>Next, you need to override Medusa’s <code>StoreRepository</code>. This repository will return Medusa’s <code>Store</code> entity. So, you need to override it to make sure it returns your <code>Store</code> entity that you just created.</p>
<p>Create the file <code>src/modules/store/repositories/store.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StoreRepository <span class="keyword">as</span> MedusaStoreRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/repositories/store&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaStoreRepository &#125;)</span><br><span class="line">@EntityRepository(Store)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">Store</span>, <span class="title">MedusaStoreRepository</span>&gt;(<span class="title">MedusaStoreRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Create the Store Module</strong></p>
<p>For now, these are the only files you’ll add for the store. You can create the Store module using these files.</p>
<p>Create the file <code>src/modules/store/store.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/store.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> StoreRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/store.repository&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [Store, StoreRepository],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the <code>@Module</code> decorator from <code>medusa-extender</code> and imports the 2 classes you created.</p>
<p>The last thing left is to import this module and use it with Medusa. In <code>src/main.ts</code> import <code>StoreModule</code> at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/store/store.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>StoreModule</code> in the array passed as a parameter to <code>Medusa.load</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">    StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p>This is all that you’ll do for now in the Store module. In the next sections, you’ll be adding more classes to it as necessary.</p>
<h3 id="Customize-the-User-Entity"><a href="#Customize-the-User-Entity" class="headerlink" title="Customize the User Entity"></a>Customize the User Entity</h3><p>In this section, you’ll customize the user entity mainly to link the user to a store.</p>
<p><strong>Create the User Entity</strong></p>
<p>Create the directory <code>user</code> inside the <code>modules</code> directory and create the file <code>src/modules/user/entities/user.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; User <span class="keyword">as</span> MedusaUser &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, Index, JoinColumn, ManyToOne &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store/entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaUser &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">MedusaUser</span> </span>&#123;</span><br><span class="line">    @Index()</span><br><span class="line">    @Column(&#123; <span class="attr">nullable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    store_id: string;</span><br><span class="line"></span><br><span class="line">    @ManyToOne(<span class="function">() =&gt;</span> Store, <span class="function">(<span class="params">store</span>) =&gt;</span> store.members)</span><br><span class="line">    @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">    store: Store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This class will add an additional column <code>store_id</code> of type string and will add a relation to the <code>Store</code> entity.</p>
<p>To add the new column to the <code>user</code> table in the database, you need to create a Migration file. Create the file <code>src/modules/user/migrations/user.migration.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Migration &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MigrationInterface, QueryRunner &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Migration()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">addStoreIdToUser1644946220401</span> <span class="title">implements</span> <span class="title">MigrationInterface</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;addStoreIdToUser1644946220401&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> up(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;user&quot; ADD COLUMN IF NOT EXISTS &quot;store_id&quot; text;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> down(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;user&quot; DROP COLUMN &quot;store_id&quot;;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>The migration is created using the <code>@Migration</code> decorator from <code>medusa-extender</code>. Notice that the migration name should end with a JavaScript timestamp based on <code>typeorm</code>‘s conventions.</p>
<p>The <code>up</code> method is run if the migration hasn’t been run before. It will add the column <code>store_id</code> to the table <code>user</code> if it doesn’t exist.</p>
<p>You’ll also need to add the relation between the Store and the User entities in <code>src/modules/store/entities/store.entity.ts</code> . Replace the <code>//TODO</code> with the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(<span class="function">() =&gt;</span> User, <span class="function">(<span class="params">user</span>) =&gt;</span> user.store)</span><br><span class="line">@JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">members: User[];</span><br></pre></td></tr></table></figure>



<p>Make sure to import the <code>User</code> entity at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p><strong>Create the User Repository</strong></p>
<p>Next, you need to override Medusa’s <code>UserRepository</code>. Create the file <code>src/modules/user/repositories/user.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserRepository <span class="keyword">as</span> MedusaUserRepository &#125; <span class="keyword">from</span> <span class="string">&quot;@medusajs/medusa/dist/repositories/user&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&quot;medusa-extender&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&quot;../entities/user.entity&quot;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaUserRepository &#125;)</span><br><span class="line">@EntityRepository(User)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">User</span>, <span class="title">MedusaUserRepository</span>&gt;(<span class="title">MedusaUserRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Create the User Service</strong></p>
<p>Next, you need to override Medusa’s <code>UserService</code> class. Create the file <code>src/modules/user/services/user.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Service &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> EventBusService <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services/event-bus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FindConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/types/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserService <span class="keyword">as</span> MedusaUserService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserRepository <span class="keyword">from</span> <span class="string">&#x27;../repositories/user.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MedusaError &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-core-utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type ConstructorParams = &#123;</span><br><span class="line">    manager: EntityManager;</span><br><span class="line">    userRepository: <span class="keyword">typeof</span> UserRepository;</span><br><span class="line">    eventBusService: EventBusService;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">override</span>: MedusaUserService &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">MedusaUserService</span> </span>&#123;</span><br><span class="line">    private readonly manager: EntityManager;</span><br><span class="line">    private readonly userRepository: <span class="keyword">typeof</span> UserRepository;</span><br><span class="line">    private readonly eventBus: EventBusService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.manager = container.manager;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = container.userRepository;</span><br><span class="line">        <span class="built_in">this</span>.eventBus = container.eventBusService;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> retrieve(userId: string, config?: FindConfig&lt;User&gt;): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> userRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.userRepository);</span><br><span class="line">        <span class="keyword">const</span> validatedId = <span class="built_in">this</span>.validateId_(userId);</span><br><span class="line">        <span class="keyword">const</span> query = <span class="built_in">this</span>.buildQuery_(&#123; <span class="attr">id</span>: validatedId &#125;, config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> user = <span class="keyword">await</span> userRepo.findOne(query);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MedusaError(MedusaError.Types.NOT_FOUND, <span class="string">`User with id: <span class="subst">$&#123;userId&#125;</span> was not found`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user <span class="keyword">as</span> User;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This uses the <code>@Service</code> decorator from <code>medusa-extender</code> to override Medusa’s <code>UserService</code>. The class you create to override it will extend <code>UserService</code>.</p>
<p>This new class overrides the <code>retrieve</code> method to ensure that the user returned is the new User entity class you created earlier.</p>
<p><strong>Create a User Middleware</strong></p>
<p>The <code>loggedInUser</code> is not available natively in Medusa. You’ll need to create a Middleware that, when a request is authenticated, registers the logged-in User within the scope.</p>
<p>Create the file <code>src/modules/user/middlewares/loggedInUser.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MedusaAuthenticatedRequest, MedusaMiddleware, Middleware &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;../../user/services/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">true</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;all&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggedInUserMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">async</span> consume(req: MedusaAuthenticatedRequest, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.user &amp;&amp; req.user.userId) &#123;</span><br><span class="line">            <span class="keyword">const</span> userService = req.scope.resolve(<span class="string">&#x27;userService&#x27;</span>) <span class="keyword">as</span> UserService;</span><br><span class="line">            <span class="keyword">const</span> loggedInUser = <span class="keyword">await</span> userService.retrieve(req.user.userId, &#123;</span><br><span class="line">                select: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;store_id&#x27;</span>],</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            req.scope.register(&#123;</span><br><span class="line">                loggedInUser: &#123;</span><br><span class="line">                    resolve: <span class="function">() =&gt;</span> loggedInUser,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>You can use the <code>@Middleware</code> decorator from <code>medusa-extender</code> to create a Middleware that runs on specific requests. This Middleware is run when the request is received from an authenticated user, and it runs for all paths (notice the use of <code>path: &#39;*&#39;</code> ) and for all types of requests (notice the use of <code>method: &quot;all&quot;</code>).</p>
<p>Inside the middleware, you retrieve the current user ID from the request, then retrieve the user model and register it in the scope so that it can be accessed from services.</p>
<blockquote>
<p>This approach is simplified for the purpose of this tutorial. However, it makes more sense to include this middleware in a separate <code>auth</code> module. Whether you include this middleware in the <code>user</code> module or the <code>auth</code> middleware will not affect its functionality.</p>
</blockquote>
<p><strong>Create a Store Service to Handle User Insert Events</strong></p>
<p>You need to ensure that when a user is created, a store is associated with it. You can do that by listening to the User-created event and creating a new store for that user. You’ll add this event handler in a <code>StoreService</code>.</p>
<p>Create the file <code>src/modules/store/services/store.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreService <span class="keyword">as</span> MedusaStoreService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CurrencyRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/repositories/currency&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/store.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EntityEventType, Service, MedusaEventHandlerParams, OnMedusaEntityEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> EventBusService <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services/event-bus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> StoreRepository <span class="keyword">from</span> <span class="string">&#x27;../repositories/store.repository&#x27;</span>;</span><br><span class="line"></span><br><span class="line">interface ConstructorParams &#123;</span><br><span class="line">    loggedInUser: User;</span><br><span class="line">    manager: EntityManager;</span><br><span class="line">    storeRepository: <span class="keyword">typeof</span> StoreRepository;</span><br><span class="line">    currencyRepository: <span class="keyword">typeof</span> CurrencyRepository;</span><br><span class="line">    eventBusService: EventBusService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">override</span>: MedusaStoreService, <span class="attr">scope</span>: <span class="string">&#x27;SCOPED&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">StoreService</span> <span class="keyword">extends</span> <span class="title">MedusaStoreService</span> </span>&#123;</span><br><span class="line">    private readonly manager: EntityManager;</span><br><span class="line">    private readonly storeRepository: <span class="keyword">typeof</span> StoreRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.manager = container.manager;</span><br><span class="line">        <span class="built_in">this</span>.storeRepository = container.storeRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    withTransaction(transactionManager: EntityManager): StoreService &#123;</span><br><span class="line">        <span class="keyword">if</span> (!transactionManager) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> cloned = <span class="keyword">new</span> StoreService(&#123;</span><br><span class="line">            ...this.container,</span><br><span class="line">            manager: transactionManager,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        cloned.transactionManager_ = transactionManager;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cloned;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @OnMedusaEntityEvent.Before.Insert(User, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    public <span class="keyword">async</span> createStoreForNewUser(</span><br><span class="line">        params: MedusaEventHandlerParams&lt;User, <span class="string">&#x27;Insert&#x27;</span>&gt;</span><br><span class="line">    ): <span class="built_in">Promise</span>&lt;EntityEventType&lt;User, <span class="string">&#x27;Insert&#x27;</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; event &#125; = params;</span><br><span class="line">        <span class="keyword">const</span> createdStore = <span class="keyword">await</span> <span class="built_in">this</span>.withTransaction(event.manager).createForUser(event.entity);</span><br><span class="line">        <span class="keyword">if</span> (!!createdStore) &#123;</span><br><span class="line">            event.entity.store_id = createdStore.id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> createForUser(user: User): <span class="built_in">Promise</span>&lt;Store | <span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (user.store_id) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> storeRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.storeRepository);</span><br><span class="line">        <span class="keyword">const</span> store = storeRepo.create() <span class="keyword">as</span> Store;</span><br><span class="line">        <span class="keyword">return</span> storeRepo.save(store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> <span class="function"><span class="title">retrieve</span>(<span class="params">relations: string[] = []</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.container.loggedInUser) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.retrieve(relations);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> storeRepo = <span class="built_in">this</span>.manager.getCustomRepository(<span class="built_in">this</span>.storeRepository);</span><br><span class="line">        <span class="keyword">const</span> store = <span class="keyword">await</span> storeRepo.findOne(&#123;</span><br><span class="line">            relations,</span><br><span class="line">            join: &#123; <span class="attr">alias</span>: <span class="string">&#x27;store&#x27;</span>, <span class="attr">innerJoin</span>: &#123; <span class="attr">members</span>: <span class="string">&#x27;store.members&#x27;</span> &#125; &#125;,</span><br><span class="line">            where: <span class="function">(<span class="params">qb</span>) =&gt;</span> &#123;</span><br><span class="line">                qb.where(<span class="string">&#x27;members.id = :memberId&#x27;</span>, &#123; <span class="attr">memberId</span>: <span class="built_in">this</span>.container.loggedInUser.id &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!store) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Unable to find the user store&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> store;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>@OnMedusaEntityEvent.Before.Insert</code> is used to add a listener to an insert event on an entity, which in this case is the <code>User</code> entity. Inside the listener, you create the user using the <code>createForUser</code> method. This method just uses the <code>StoreRepository</code> to create a store.</p>
<p>You also add a helper event <code>retrieve</code> to retrieve the store that belongs to the currently logged-in user.</p>
<p>Notice the use of <code>scope: &#39;SCOPED&#39;</code> in the <code>@Service</code> decorator. This will allow you to access the logged in user you registered earlier in the scope.</p>
<p>You’ll need to import this new class into the <code>StoreModule</code>. In <code>src/modules/store/store.module.ts</code> add the following import at the beginning:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> StoreService <span class="keyword">from</span> <span class="string">&#x27;./services/store.service&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>StoreService</code> to the <code>imports</code> array passed to <code>@Module</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imports: [Store, StoreRepository, StoreService],</span><br></pre></td></tr></table></figure>



<p><strong>Create a User Subscriber</strong></p>
<p>For the event listener to work, you need to first emit this event in a subscriber. The event will be emitted before a <code>User</code> is inserted. Create the file <code>src/modules/user/subscribers/user.subscriber.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Connection, EntitySubscriberInterface, EventSubscriber, InsertEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; eventEmitter, Utils <span class="keyword">as</span> MedusaUtils, OnMedusaEntityEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@EventSubscriber()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSubscriber</span> <span class="title">implements</span> <span class="title">EntitySubscriberInterface</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> attachTo(connection: Connection): <span class="keyword">void</span> &#123;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, UserSubscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public listenTo(): <span class="keyword">typeof</span> User &#123;</span><br><span class="line">        <span class="keyword">return</span> User;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> beforeInsert(event: InsertEvent&lt;User&gt;): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> eventEmitter.emitAsync(OnMedusaEntityEvent.Before.InsertEvent(User), &#123;</span><br><span class="line">            event,</span><br><span class="line">            transactionalEntityManager: event.manager,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will create a subscriber using the <code>EventSubscriber</code> decorator from <code>typeorm</code>. Then, before a user is inserted the <code>OnMedusaEntityEvent.Before.InsertEvent</code> event from <code>medusa-extender</code> is emitted, which will trigger creating the store.</p>
<p>To register the subscriber, you need to create a middleware that registers it. Create the file <code>src/modules/user/middlewares/userSubscriber.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  MEDUSA_RESOLVER_KEYS,</span><br><span class="line">  MedusaAuthenticatedRequest,</span><br><span class="line">  MedusaMiddleware,</span><br><span class="line">  Utils <span class="keyword">as</span> MedusaUtils,</span><br><span class="line">  Middleware</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserSubscriber <span class="keyword">from</span> <span class="string">&#x27;../subscribers/user.subscriber&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">false</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/users&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachUserSubscriberMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">async</span> consume(req: MedusaAuthenticatedRequest, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; connection &#125; = req.scope.resolve(MEDUSA_RESOLVER_KEYS.manager) <span class="keyword">as</span> &#123; <span class="attr">connection</span>: Connection &#125;;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, UserSubscriber);</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will register the subscriber when a <code>POST</code> request is sent to <code>/admin/users</code>, which creates a new user.</p>
<p><strong>Create a User Router</strong></p>
<p>The last customization left is an optional one. By default, Medusa’s create user endpoint requires you to be authenticated as an admin. In a marketplace use case, you might want users to register on their own and create their own stores. If this is not the case for you, you can skip creating the following class.</p>
<p>Medusa Extender allows you to also override routes in Medusa. In this case, you’ll be adding the <code>/admin/create-user</code> route to accept non-authenticated requests.</p>
<p>Create the file <code>src/modules/user/routers/user.router.ts</code> and add the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createUserHandler <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/api/routes/admin/users/create-user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> wrapHandler <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/api/middlewares/await-middleware&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Router(&#123;</span><br><span class="line">    routes: [</span><br><span class="line">        &#123;</span><br><span class="line">            requiredAuth: <span class="literal">false</span>,</span><br><span class="line">            path: <span class="string">&#x27;/admin/create-user&#x27;</span>,</span><br><span class="line">            method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">            handlers: [wrapHandler(createUserHandler)],</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRouter</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>You use the <code>@Router</code> decorator from <code>medusa-extender</code> to create a router. This router will accept a <code>routes</code> array which will either be added or override existing routes in your Medusa server. In this case, you override the <code>/admin/create-user</code> route and set <code>requiredAuth</code> to false.</p>
<p>To make sure that the <code>AttachUserSubscriberMiddleware</code> also runs for this new route (so that the before insert user event handlers run for this new route), make sure to add a new entry to the <code>routes</code> array:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">false</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/users&#x27;</span> &#125;, &#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/create-user&#x27;</span> &#125;] &#125;)</span><br></pre></td></tr></table></figure>



<p><strong>Create a User Module</strong></p>
<p>You’ve added all the customizations necessary to associate a user with their own store. Now, you can create the User module using these files.</p>
<p>Create the file <code>src/modules/user/user.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AttachUserSubscriberMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;./middlewares/userSubscriber.middleware&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoggedInUserMiddleware &#125; <span class="keyword">from</span> <span class="string">&quot;./middlewares/loggedInUser.middleware&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/user.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserRouter &#125; <span class="keyword">from</span> <span class="string">&quot;./routers/user.router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;./services/user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> addStoreIdToUser1644946220401 <span class="keyword">from</span> <span class="string">&#x27;./migrations/user.migration&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [</span><br><span class="line">        User,</span><br><span class="line">        UserService,</span><br><span class="line">        UserRepository,</span><br><span class="line">        addStoreIdToUser1644946220401,</span><br><span class="line">        UserRouter,</span><br><span class="line">        LoggedInUserMiddleware,</span><br><span class="line">        AttachUserSubscriberMiddleware</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>If you didn’t create the <code>UserRouter</code> in the previous step then make sure to remove it from the <code>imports</code> array.</p>
</blockquote>
<p>The last thing left is to import this Module. In <code>src/main.ts</code> import <code>UserModule</code> at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/user/user.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add the <code>UserModule</code> in the array passed as a parameter to <code>Medusa.load</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">        UserModule,</span><br><span class="line">        StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p><strong>Test it Out</strong></p>
<p>You are now ready to test out this customization! In your terminal, run your Medusa server:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// this is upgrade DB, also the same as scripts in package.json</span><br><span class="line">medusa seed -f data/seed.json -m</span><br><span class="line"></span><br><span class="line">// this is start medusa server</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>



<p>Or using Medusa’s CLI:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">medusa develop</span><br></pre></td></tr></table></figure>



<p>After your run your server, you need to use a tool like <a target="_blank" rel="noopener" href="https://www.postman.com/">Postman</a> to easily send requests to your server.</p>
<p>If you didn’t add the <code>UserRouter</code>, you first need to log in as an admin to be able to add users. You can do that by sending a <code>POST</code> request to <code>localhost:9000/admin/auth</code>. In the body, you should include the email and password. If you’re using a fresh Medusa install you can use the following credentials:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;admin@medusa-test.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;supersecret&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Following this request, you can send authenticated requests to the Admin.</p>
<p>Send a <code>POST</code> request to <code>[localhost:9000/admin/users](http://localhost:9000/admin/users)</code> to create a new user. In the body, you need to pass the email and password of the new user:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;example@gmail.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;supersecret&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>The request will return a user object with the details of the new user:</p>
<p>![Create User Result](Open source ecommerce platform for multi-vendor marketplaces/1.png)</p>
<p>Notice how there’s a <code>store_id</code> field now. If you try to create a couple of users, you’ll see that the <code>store_id</code> will be different each time.</p>
<h3 id="Customize-the-Products-Entity"><a href="#Customize-the-Products-Entity" class="headerlink" title="Customize the Products Entity"></a>Customize the Products Entity</h3><p>Similar to how you just customized the <code>User</code> entity, you need to customize the <code>Product</code> entity to also hold the <code>store_id</code> with the relationship as well. You’ll then customize the <code>ProductService</code> as well as other classes to make sure that, when a product is created, the store ID of the user creating it is attached to it. You’ll also make sure that when the list of products is fetched, only the products that belong to the current user’s store are returned.</p>
<p><strong>Create a Product Entity</strong></p>
<p>Create the file <code>src/modules/product/entities/product.entity.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Product <span class="keyword">as</span> MedusaProduct &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Column, Entity, Index, JoinColumn, ManyToOne &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Entity <span class="keyword">as</span> MedusaEntity &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Store &#125; <span class="keyword">from</span> <span class="string">&#x27;../../store/entities/store.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaEntity(&#123; <span class="attr">override</span>: MedusaProduct &#125;)</span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">extends</span> <span class="title">MedusaProduct</span> </span>&#123;</span><br><span class="line">    @Index()</span><br><span class="line">    @Column(&#123; <span class="attr">nullable</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    store_id: string;</span><br><span class="line"></span><br><span class="line">    @ManyToOne(<span class="function">() =&gt;</span> Store, <span class="function">(<span class="params">store</span>) =&gt;</span> store.members)</span><br><span class="line">    @JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;store_id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;id&#x27;</span> &#125;)</span><br><span class="line">    store: Store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override Medusa’s <code>Product</code> entity to add the <code>store_id</code> field and relation to the <code>Store</code> entity.</p>
<p>You need to also reflect this relation in the <code>Store</code> entity, so, in <code>src/modules/store/entities/store.entity.ts</code> add the following code below the relation with the <code>User</code> entity you previously added:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(<span class="function">() =&gt;</span> Product, <span class="function">(<span class="params">product</span>) =&gt;</span> product.store)</span><br><span class="line">@JoinColumn(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">referencedColumnName</span>: <span class="string">&#x27;store_id&#x27;</span> &#125;)</span><br><span class="line">products: Product[];</span><br></pre></td></tr></table></figure>



<p>Make sure to import the <code>Product</code> entity at the beginning of the file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../../product/entities/product.entity&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p><strong>Create a Product Migration</strong></p>
<p>Next, create the file <code>src/modules/product/migrations/product.migration.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MigrationInterface, QueryRunner &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Migration &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Migration()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">addStoreIdToProduct1645034402086</span> <span class="title">implements</span> <span class="title">MigrationInterface</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;addStoreIdToProduct1645034402086&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> up(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;product&quot; ADD COLUMN IF NOT EXISTS &quot;store_id&quot; text;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> down(queryRunner: QueryRunner): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> query = <span class="string">`ALTER TABLE public.&quot;product&quot; DROP COLUMN &quot;store_id&quot;;`</span>;</span><br><span class="line">      <span class="keyword">await</span> queryRunner.query(query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will add a migration that will add the <code>store_id</code> column to the <code>product</code> table.</p>
<p><strong>Create a Product Repository</strong></p>
<p>Next, create the file <code>src/modules/product/repositories/product.repository.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Repository <span class="keyword">as</span> MedusaRepository, Utils &#125; <span class="keyword">from</span> <span class="string">&quot;medusa-extender&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EntityRepository &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductRepository <span class="keyword">as</span> MedusaProductRepository &#125; <span class="keyword">from</span> <span class="string">&quot;@medusajs/medusa/dist/repositories/product&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@MedusaRepository(&#123; <span class="attr">override</span>: MedusaProductRepository &#125;)</span><br><span class="line">@EntityRepository(Product)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductRepository</span> <span class="keyword">extends</span> <span class="title">Utils</span>.<span class="title">repositoryMixin</span>&lt;<span class="title">Product</span>, <span class="title">MedusaProductRepository</span>&gt;(<span class="title">MedusaProductRepository</span>) </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override Medusa’s <code>ProductRepository</code> to return your new <code>Product</code> entity.</p>
<p><strong>Create a Product Service</strong></p>
<p>Now, you’ll add the customization to ensure that only the products that belong to the currently logged-in user are returned when a request is sent.</p>
<p>Since you created the <code>LoggedInUserMiddleware</code> earlier, you can have access to the logged-in user from any service through the <code>container</code> object passed to the constructor of the service.</p>
<p>Create the file <code>src/modules/product/services/product.service.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; EntityEventType, MedusaEventHandlerParams, OnMedusaEntityEvent, Service &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; EntityManager &#125; <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductService <span class="keyword">as</span> MedusaProductService &#125; <span class="keyword">from</span> <span class="string">&#x27;@medusajs/medusa/dist/services&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&#x27;../../user/entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">&#x27;../../user/services/user.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line">type ConstructorParams = &#123;</span><br><span class="line">    manager: any;</span><br><span class="line">    loggedInUser: User;</span><br><span class="line">    productRepository: any;</span><br><span class="line">    productVariantRepository: any;</span><br><span class="line">    productOptionRepository: any;</span><br><span class="line">    eventBusService: any;</span><br><span class="line">    productVariantService: any;</span><br><span class="line">    productCollectionService: any;</span><br><span class="line">    productTypeRepository: any;</span><br><span class="line">    productTagRepository: any;</span><br><span class="line">    imageRepository: any;</span><br><span class="line">    searchService: any;</span><br><span class="line">    userService: UserService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Service(&#123; <span class="attr">scope</span>: <span class="string">&#x27;SCOPED&#x27;</span>, <span class="attr">override</span>: MedusaProductService &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> <span class="keyword">extends</span> <span class="title">MedusaProductService</span> </span>&#123;</span><br><span class="line">    readonly #manager: EntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">private readonly container: ConstructorParams</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(container);</span><br><span class="line">        <span class="built_in">this</span>.#manager = container.manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prepareListQuery_(selector: object, <span class="attr">config</span>: object): object &#123;</span><br><span class="line">        <span class="keyword">const</span> loggedInUser = <span class="built_in">this</span>.container.loggedInUser</span><br><span class="line">        <span class="keyword">if</span> (loggedInUser) &#123;</span><br><span class="line">            selector[<span class="string">&#x27;store_id&#x27;</span>] = loggedInUser.store_id</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.prepareListQuery_(selector, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will override the <code>prepareListQuery</code> method in Medusa’s <code>ProductService</code>, which this new class extends, to get the logged-in user. Then, if the user is retrieved successfully the key <code>store_id</code> is added to the <code>selector</code> object to filter the products by the user’s <code>store_id</code>.</p>
<p><strong>Create a Product Module</strong></p>
<p>That’s all the customization you’ll do for now. You just need to import all these files into a Product module.</p>
<p>Create <code>src/modules/product/product.module.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/product.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ProductRepository <span class="keyword">from</span> <span class="string">&#x27;./repositories/product.repository&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProductService &#125; <span class="keyword">from</span> <span class="string">&#x27;./services/product.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> addStoreIdToProduct1645034402086 <span class="keyword">from</span> <span class="string">&#x27;./migrations/product.migration&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Module(&#123;</span><br><span class="line">    imports: [</span><br><span class="line">      Product,</span><br><span class="line">      ProductRepository,</span><br><span class="line">      ProductService,</span><br><span class="line">      addStoreIdToProduct1645034402086,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>Finally, import the <code>ProductModule</code> at the beginning of <code>src/main.ts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ProductModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./modules/product/product.module&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>And add the <code>ProductModule</code> to the array passed to <code>load</code> along with <code>UserModule</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Medusa(__dirname + <span class="string">&#x27;/../&#x27;</span>, expressInstance).load([</span><br><span class="line">    UserModule,</span><br><span class="line">    ProductModule,</span><br><span class="line">    StoreModule</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>



<p><strong>Test it Out</strong></p>
<p>You can go ahead and test it out now. Run the server if it isn’t running already and log in with the user you created earlier by sending the credentials to <code>localhost:9000/admin/auth</code>.</p>
<p>After that, send a <code>GET</code> request to <code>localhost:9000/admin/products</code>. You’ll receive an empty array of products as the current user does not have any products yet.</p>
<p>![Result of Get Products](Open source ecommerce platform for multi-vendor marketplaces/2.png)</p>
<p>You’ll now add the necessary customization to attach a store ID to a newly created product.</p>
<p>To listen to the product created event, create the file <code>src/modules/product/subscribers/product.subscriber.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Connection, EntitySubscriberInterface, EventSubscriber, InsertEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; OnMedusaEntityEvent, Utils, eventEmitter &#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Product &#125; <span class="keyword">from</span> <span class="string">&#x27;../entities/product.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@EventSubscriber()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductSubscriber</span> <span class="title">implements</span> <span class="title">EntitySubscriberInterface</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> attachTo(connection: Connection): <span class="keyword">void</span> &#123;</span><br><span class="line">        Utils.attachOrReplaceEntitySubscriber(connection, ProductSubscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public listenTo(): <span class="keyword">typeof</span> Product &#123;</span><br><span class="line">        <span class="keyword">return</span> Product;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> beforeInsert(event: InsertEvent&lt;Product&gt;): <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> eventEmitter.emitAsync(OnMedusaEntityEvent.Before.InsertEvent(Product), &#123;</span><br><span class="line">            event,</span><br><span class="line">            transactionalEntityManager: event.manager,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Then, you need to register this Subscriber using Middleware. Create the file <code>src/modules/product/middlewares/product.middleware.ts</code> with the following content:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  MEDUSA_RESOLVER_KEYS,</span><br><span class="line">  MedusaAuthenticatedRequest,</span><br><span class="line">  MedusaMiddleware,</span><br><span class="line">  Utils <span class="keyword">as</span> MedusaUtils,</span><br><span class="line">  Middleware</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;medusa-extender&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NextFunction, Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Connection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ProductSubscriber <span class="keyword">from</span> <span class="string">&#x27;../subscribers/product.subscriber&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Middleware(&#123; <span class="attr">requireAuth</span>: <span class="literal">true</span>, <span class="attr">routes</span>: [&#123; <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/admin/products&#x27;</span> &#125;] &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachProductSubscribersMiddleware</span> <span class="title">implements</span> <span class="title">MedusaMiddleware</span> </span>&#123;</span><br><span class="line">    public consume(req: MedusaAuthenticatedRequest | Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction): <span class="keyword">void</span> | <span class="built_in">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; connection &#125; = req.scope.resolve(MEDUSA_RESOLVER_KEYS.manager) <span class="keyword">as</span> &#123; <span class="attr">connection</span>: Connection &#125;;</span><br><span class="line">        MedusaUtils.attachOrReplaceEntitySubscriber(connection, ProductSubscriber);</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will register the subscriber when a <code>POST</code> request is sent to <code>/admin/products</code>, which creates a new product.</p>
<p><strong>Add Event Listener in Product Service</strong></p>
<p>Next, in <code>src/modules/product/services/product.service.ts</code> add the following inside the class:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@OnMedusaEntityEvent.Before.Insert(Product, &#123; <span class="attr">async</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">public <span class="keyword">async</span> attachStoreToProduct(</span><br><span class="line">    params: MedusaEventHandlerParams&lt;Product, <span class="string">&#x27;Insert&#x27;</span>&gt;</span><br><span class="line">): <span class="built_in">Promise</span>&lt;EntityEventType&lt;Product, <span class="string">&#x27;Insert&#x27;</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; event &#125; = params;</span><br><span class="line">    <span class="keyword">const</span> loggedInUser = <span class="built_in">this</span>.container.loggedInUser;</span><br><span class="line">    event.entity.store_id = loggedInUser.store_id;</span><br><span class="line">    <span class="keyword">return</span> event;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This will listen to the Insert event using the <code>@OnMedusaEntityEvent</code> decorator from <code>medusa-extender</code>. It will then use the logged-in user and attach the user’s <code>store_id</code> to the newly created product.</p>
<p><strong>Add Middleware to Product Module</strong></p>
<p>Finally, make sure to import the new middleware at the beginning of <code>src/modules/product/product.module.ts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> AttachProductSubscribersMiddleware <span class="keyword">from</span> <span class="string">&#x27;./middlewares/product.middleware&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>Then, add it in the <code>imports</code> array passed to <code>@Module</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">imports: [</span><br><span class="line">  Product,</span><br><span class="line">  ProductRepository,</span><br><span class="line">  ProductService,</span><br><span class="line">  addStoreIdToProduct1645034402086,</span><br><span class="line">  AttachProductSubscribersMiddleware</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>You’re ready to add products into a store now! Run the server if it’s not running and make sure you’re logged in with the user you created earlier. Then, send a <code>POST</code> request to <code>[localhost:9000/admin/products](http://localhost:9000/admin/products)</code> with the following body:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;my product&quot;</span>,</span><br><span class="line">    <span class="string">&quot;options&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>This is the minimum structure of a product. You can rename the title to anything you want.</p>
<p>After you send the request, you should receive a Product object where you can see the <code>store_id</code> is set to the same <code>store_id</code> of the user you’re logged in with.</p>
<p>![Add Product Request Result](Open source ecommerce platform for multi-vendor marketplaces/3.png)</p>
<p>Now, try sending a <code>GET</code> request to <code>[localhost:9000/admin/products](http://localhost:9000/admin/products)</code> as you did earlier. Instead of an empty array, you’ll see the product you just added.</p>
<p>![Retrieve Products](Open source ecommerce platform for multi-vendor marketplaces/4.png)</p>
<h2 id="Testing-it-Out-Using-Medusa’s-Admin"><a href="#Testing-it-Out-Using-Medusa’s-Admin" class="headerlink" title="Testing it Out Using Medusa’s Admin"></a>Testing it Out Using Medusa’s Admin</h2><p>If you also have a <a target="_blank" rel="noopener" href="https://github.com/medusajs/admin">Medusa Admin</a> instance installed, you can also test this out. Log in with the user you created earlier and you’ll see that you can only see the product they added.</p>
<p>![Admin Dashboard](Open source ecommerce platform for multi-vendor marketplaces/5.png)</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this tutorial, you learned the first steps of creating a Marketplace using Medusa and Medusa Extender! In later points, you’ll learn about how you can add settings, manage orders, and more!</p>
<p>Be sure to support <a target="_blank" rel="noopener" href="https://github.com/adrien2p/medusa-extender">Medusa Extender</a> and check the repository out for more details!</p>
<p>Should you have any issues or questions related to Medusa, then feel free to reach out to the Medusa team via <a target="_blank" rel="noopener" href="https://discord.gg/F87eGuwkTp">Discord</a>. You can also contact Adrien <code>@adrien2p</code> for more details or help regarding Medusa Extender.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/20/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><a class="extend next" rel="next" href="/page/22/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weiming Zhuang</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  




  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'none'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>




</body>
</html>
